(function(){var root=this;var PIXI=PIXI||{};PIXI.WEBGL_RENDERER=0;PIXI.CANVAS_RENDERER=1;PIXI.VERSION="v1.5.3";PIXI.blendModes={NORMAL:0,ADD:1,MULTIPLY:2,SCREEN:3,OVERLAY:4,DARKEN:5,LIGHTEN:6,COLOR_DODGE:7,COLOR_BURN:8,HARD_LIGHT:9,SOFT_LIGHT:10,DIFFERENCE:11,EXCLUSION:12,HUE:13,SATURATION:14,COLOR:15,LUMINOSITY:16};PIXI.scaleModes={DEFAULT:0,LINEAR:0,NEAREST:1};PIXI.INTERACTION_FREQUENCY=30;PIXI.AUTO_PREVENT_DEFAULT=true;PIXI.RAD_TO_DEG=180/Math.PI;PIXI.DEG_TO_RAD=Math.PI/180;PIXI.Point=function(x,y){this.x=x||0;this.y=y||0};PIXI.Point.prototype.clone=function(){return new PIXI.Point(this.x,this.y)};PIXI.Point.prototype.constructor=PIXI.Point;PIXI.Point.prototype.set=function(x,y){this.x=x||0;this.y=y||(y!==0?this.x:0)};PIXI.Rectangle=function(x,y,width,height){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0};PIXI.Rectangle.prototype.clone=function(){return new PIXI.Rectangle(this.x,this.y,this.width,this.height)};PIXI.Rectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true}}return false};PIXI.Rectangle.prototype.constructor=PIXI.Rectangle;PIXI.EmptyRectangle=new PIXI.Rectangle(0,0,0,0);PIXI.Polygon=function(points){if(!(points instanceof Array))points=Array.prototype.slice.call(arguments);if(typeof points[0]==="number"){var p=[];for(var i=0,il=points.length;i<il;i+=2){p.push(new PIXI.Point(points[i],points[i+1]))}points=p}this.points=points};PIXI.Polygon.prototype.clone=function(){var points=[];for(var i=0;i<this.points.length;i++){points.push(this.points[i].clone())}return new PIXI.Polygon(points)};PIXI.Polygon.prototype.contains=function(x,y){var inside=false;for(var i=0,j=this.points.length-1;i<this.points.length;j=i++){var xi=this.points[i].x,yi=this.points[i].y,xj=this.points[j].x,yj=this.points[j].y,intersect=yi>y!==yj>y&&x<(xj-xi)*(y-yi)/(yj-yi)+xi;if(intersect)inside=!inside}return inside};PIXI.Polygon.prototype.constructor=PIXI.Polygon;PIXI.Circle=function(x,y,radius){this.x=x||0;this.y=y||0;this.radius=radius||0};PIXI.Circle.prototype.clone=function(){return new PIXI.Circle(this.x,this.y,this.radius)};PIXI.Circle.prototype.contains=function(x,y){if(this.radius<=0)return false;var dx=this.x-x,dy=this.y-y,r2=this.radius*this.radius;dx*=dx;dy*=dy;return dx+dy<=r2};PIXI.Circle.prototype.constructor=PIXI.Circle;PIXI.Ellipse=function(x,y,width,height){this.x=x||0;this.y=y||0;this.width=width||0;this.height=height||0};PIXI.Ellipse.prototype.clone=function(){return new PIXI.Ellipse(this.x,this.y,this.width,this.height)};PIXI.Ellipse.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var normx=(x-this.x)/this.width,normy=(y-this.y)/this.height;normx*=normx;normy*=normy;return normx+normy<=1};PIXI.Ellipse.prototype.getBounds=function(){return new PIXI.Rectangle(this.x,this.y,this.width,this.height)};PIXI.Ellipse.prototype.constructor=PIXI.Ellipse;PIXI.determineMatrixArrayType=function(){return typeof Float32Array!=="undefined"?Float32Array:Array};PIXI.Matrix2=PIXI.determineMatrixArrayType();PIXI.Matrix=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0};PIXI.Matrix.prototype.fromArray=function(array){this.a=array[0];this.b=array[1];this.c=array[3];this.d=array[4];this.tx=array[2];this.ty=array[5]};PIXI.Matrix.prototype.toArray=function(transpose){if(!this.array)this.array=new Float32Array(9);var array=this.array;if(transpose){this.array[0]=this.a;this.array[1]=this.c;this.array[2]=0;this.array[3]=this.b;this.array[4]=this.d;this.array[5]=0;this.array[6]=this.tx;this.array[7]=this.ty;this.array[8]=1}else{this.array[0]=this.a;this.array[1]=this.b;this.array[2]=this.tx;this.array[3]=this.c;this.array[4]=this.d;this.array[5]=this.ty;this.array[6]=0;this.array[7]=0;this.array[8]=1}return array};PIXI.identityMatrix=new PIXI.Matrix;PIXI.DisplayObject=function(){this.position=new PIXI.Point;this.scale=new PIXI.Point(1,1);this.pivot=new PIXI.Point(0,0);this.rotation=0;this.alpha=1;this.visible=true;this.hitArea=null;this.buttonMode=false;this.renderable=false;this.parent=null;this.stage=null;this.worldAlpha=1;this._interactive=false;this.defaultCursor="pointer";this.worldTransform=new PIXI.Matrix;this.color=[];this.dynamic=true;this._sr=0;this._cr=1;this.filterArea=null;this._bounds=new PIXI.Rectangle(0,0,1,1);this._currentBounds=null;this._mask=null;this._cacheAsBitmap=false;this._cacheIsDirty=false};PIXI.DisplayObject.prototype.constructor=PIXI.DisplayObject;PIXI.DisplayObject.prototype.setInteractive=function(interactive){this.interactive=interactive};Object.defineProperty(PIXI.DisplayObject.prototype,"interactive",{get:function(){return this._interactive},set:function(value){this._interactive=value;if(this.stage)this.stage.dirty=true}});Object.defineProperty(PIXI.DisplayObject.prototype,"worldVisible",{get:function(){var item=this;do{if(!item.visible)return false;item=item.parent}while(item);return true}});Object.defineProperty(PIXI.DisplayObject.prototype,"mask",{get:function(){return this._mask},set:function(value){if(this._mask)this._mask.isMask=false;this._mask=value;if(this._mask)this._mask.isMask=true}});Object.defineProperty(PIXI.DisplayObject.prototype,"filters",{get:function(){return this._filters},set:function(value){if(value){var passes=[];for(var i=0;i<value.length;i++){var filterPasses=value[i].passes;for(var j=0;j<filterPasses.length;j++){passes.push(filterPasses[j])}}this._filterBlock={target:this,filterPasses:passes}}this._filters=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){if(this._cacheAsBitmap===value)return;if(value){this._generateCachedSprite()}else{this._destroyCachedSprite()}this._cacheAsBitmap=value}});PIXI.DisplayObject.prototype.updateTransform=function(){if(this.rotation!==this.rotationCache){this.rotationCache=this.rotation;this._sr=Math.sin(this.rotation);this._cr=Math.cos(this.rotation)}var parentTransform=this.parent.worldTransform;var worldTransform=this.worldTransform;var px=this.pivot.x;var py=this.pivot.y;var a00=this._cr*this.scale.x,a01=-this._sr*this.scale.y,a10=this._sr*this.scale.x,a11=this._cr*this.scale.y,a02=this.position.x-a00*px-py*a01,a12=this.position.y-a11*py-px*a10,b00=parentTransform.a,b01=parentTransform.b,b10=parentTransform.c,b11=parentTransform.d;worldTransform.a=b00*a00+b01*a10;worldTransform.b=b00*a01+b01*a11;worldTransform.tx=b00*a02+b01*a12+parentTransform.tx;worldTransform.c=b10*a00+b11*a10;worldTransform.d=b10*a01+b11*a11;worldTransform.ty=b10*a02+b11*a12+parentTransform.ty;this.worldAlpha=this.alpha*this.parent.worldAlpha};PIXI.DisplayObject.prototype.getBounds=function(matrix){matrix=matrix;return PIXI.EmptyRectangle};PIXI.DisplayObject.prototype.getLocalBounds=function(){return this.getBounds(PIXI.identityMatrix)};PIXI.DisplayObject.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true};PIXI.DisplayObject.prototype.generateTexture=function(renderer){var bounds=this.getLocalBounds();var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0,renderer);renderTexture.render(this,new PIXI.Point(-bounds.x,-bounds.y));return renderTexture};PIXI.DisplayObject.prototype.updateCache=function(){this._generateCachedSprite()};PIXI.DisplayObject.prototype._renderCachedSprite=function(renderSession){if(renderSession.gl){PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession)}else{PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession)}};PIXI.DisplayObject.prototype._generateCachedSprite=function(){this._cacheAsBitmap=false;var bounds=this.getLocalBounds();if(!this._cachedSprite){var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0);this._cachedSprite=new PIXI.Sprite(renderTexture);this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.texture.resize(bounds.width|0,bounds.height|0)}var tempFilters=this._filters;this._filters=null;this._cachedSprite.filters=tempFilters;this._cachedSprite.texture.render(this,new PIXI.Point(-bounds.x,-bounds.y));this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._filters=tempFilters;this._cacheAsBitmap=true};PIXI.DisplayObject.prototype._destroyCachedSprite=function(){if(!this._cachedSprite)return;this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.DisplayObject.prototype._renderWebGL=function(renderSession){renderSession=renderSession};PIXI.DisplayObject.prototype._renderCanvas=function(renderSession){renderSession=renderSession};Object.defineProperty(PIXI.DisplayObject.prototype,"x",{get:function(){return this.position.x},set:function(value){this.position.x=value}});Object.defineProperty(PIXI.DisplayObject.prototype,"y",{get:function(){return this.position.y},set:function(value){this.position.y=value}});PIXI.DisplayObjectContainer=function(){PIXI.DisplayObject.call(this);this.children=[]};PIXI.DisplayObjectContainer.prototype=Object.create(PIXI.DisplayObject.prototype);PIXI.DisplayObjectContainer.prototype.constructor=PIXI.DisplayObjectContainer;PIXI.DisplayObjectContainer.prototype.addChild=function(child){this.addChildAt(child,this.children.length)};PIXI.DisplayObjectContainer.prototype.addChildAt=function(child,index){if(index>=0&&index<=this.children.length){if(child.parent){child.parent.removeChild(child)}child.parent=this;this.children.splice(index,0,child);if(this.stage)child.setStageReference(this.stage)}else{throw new Error(child+" The index "+index+" supplied is out of bounds "+this.children.length)}};PIXI.DisplayObjectContainer.prototype.swapChildren=function(child,child2){if(child===child2){return}var index1=this.children.indexOf(child);var index2=this.children.indexOf(child2);if(index1<0||index2<0){throw new Error("swapChildren: Both the supplied DisplayObjects must be a child of the caller.")}this.children[index1]=child2;this.children[index2]=child};PIXI.DisplayObjectContainer.prototype.getChildAt=function(index){if(index>=0&&index<this.children.length){return this.children[index]}else{throw new Error("Supplied index does not exist in the child list, or the supplied DisplayObject must be a child of the caller")}};PIXI.DisplayObjectContainer.prototype.removeChild=function(child){return this.removeChildAt(this.children.indexOf(child))};PIXI.DisplayObjectContainer.prototype.removeChildAt=function(index){var child=this.getChildAt(index);if(this.stage)child.removeStageReference();child.parent=undefined;this.children.splice(index,1);return child};PIXI.DisplayObjectContainer.prototype.removeChildren=function(beginIndex,endIndex){var begin=beginIndex||0;var end=typeof endIndex==="number"?endIndex:this.children.length;var range=end-begin;if(range>0&&range<=end){var removed=this.children.splice(begin,range);for(var i=0;i<removed.length;i++){var child=removed[i];if(this.stage)child.removeStageReference();child.parent=undefined}return removed}else{throw new Error("Range Error, numeric values are outside the acceptable range")}};PIXI.DisplayObjectContainer.prototype.updateTransform=function(){if(!this.visible)return;PIXI.DisplayObject.prototype.updateTransform.call(this);if(this._cacheAsBitmap)return;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}};PIXI.DisplayObjectContainer.prototype.getBounds=function(matrix){if(this.children.length===0)return PIXI.EmptyRectangle;if(matrix){var matrixCache=this.worldTransform;this.worldTransform=matrix;this.updateTransform();this.worldTransform=matrixCache}var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var childBounds;var childMaxX;var childMaxY;var childVisible=false;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];if(!child.visible)continue;childVisible=true;childBounds=this.children[i].getBounds(matrix);minX=minX<childBounds.x?minX:childBounds.x;minY=minY<childBounds.y?minY:childBounds.y;childMaxX=childBounds.width+childBounds.x;childMaxY=childBounds.height+childBounds.y;maxX=maxX>childMaxX?maxX:childMaxX;maxY=maxY>childMaxY?maxY:childMaxY}if(!childVisible)return PIXI.EmptyRectangle;var bounds=this._bounds;bounds.x=minX;bounds.y=minY;bounds.width=maxX-minX;bounds.height=maxY-minY;return bounds};PIXI.DisplayObjectContainer.prototype.getLocalBounds=function(){var matrixCache=this.worldTransform;this.worldTransform=PIXI.identityMatrix;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}var bounds=this.getBounds();this.worldTransform=matrixCache;return bounds};PIXI.DisplayObjectContainer.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.setStageReference(stage)}};PIXI.DisplayObjectContainer.prototype.removeStageReference=function(){for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.removeStageReference()}if(this._interactive)this.stage.dirty=true;this.stage=null};PIXI.DisplayObjectContainer.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}var i,j;if(this._mask||this._filters){if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(renderSession);renderSession.spriteBatch.start()}else{for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.DisplayObjectContainer.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession.context)}for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession.context)}};PIXI.Sprite=function(texture){PIXI.DisplayObjectContainer.call(this);this.anchor=new PIXI.Point;this.texture=texture;this._width=0;this._height=0;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;if(texture.baseTexture.hasLoaded){this.onTextureUpdate()}else{this.onTextureUpdateBind=this.onTextureUpdate.bind(this);this.texture.addEventListener("update",this.onTextureUpdateBind)}this.renderable=true};PIXI.Sprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Sprite.prototype.constructor=PIXI.Sprite;Object.defineProperty(PIXI.Sprite.prototype,"width",{get:function(){return this.scale.x*this.texture.frame.width},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value}});Object.defineProperty(PIXI.Sprite.prototype,"height",{get:function(){return this.scale.y*this.texture.frame.height},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value}});PIXI.Sprite.prototype.setTexture=function(texture){if(this.texture.baseTexture!==texture.baseTexture){this.textureChange=true;this.texture=texture}else{this.texture=texture}this.cachedTint=16777215;this.updateFrame=true};PIXI.Sprite.prototype.onTextureUpdate=function(){if(this._width)this.scale.x=this._width/this.texture.frame.width;if(this._height)this.scale.y=this._height/this.texture.frame.height;this.updateFrame=true};PIXI.Sprite.prototype.getBounds=function(matrix){var width=this.texture.frame.width;var height=this.texture.frame.height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.c;var c=worldTransform.b;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.Sprite.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;var i,j;if(this._mask||this._filters){var spriteBatch=renderSession.spriteBatch;if(this._mask){spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);spriteBatch.start()}if(this._filters){spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}spriteBatch.render(this);for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}spriteBatch.stop();if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(renderSession);spriteBatch.start()}else{renderSession.spriteBatch.render(this);for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}}};PIXI.Sprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;var frame=this.texture.frame;var context=renderSession.context;var texture=this.texture;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession.context)}if(frame&&frame.width&&frame.height&&texture.baseTexture.source){context.globalAlpha=this.worldAlpha;var transform=this.worldTransform;if(renderSession.roundPixels){context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx|0,transform.ty|0)}else{context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx,transform.ty)}if(renderSession.smoothProperty&&renderSession.scaleMode!==this.texture.baseTexture.scaleMode){renderSession.scaleMode=this.texture.baseTexture.scaleMode;context[renderSession.smoothProperty]=renderSession.scaleMode===PIXI.scaleModes.LINEAR}if(this.tint!==16777215){if(this.cachedTint!==this.tint){if(!texture.baseTexture.hasLoaded)return;this.cachedTint=this.tint;this.tintedTexture=PIXI.CanvasTinter.getTintedTexture(this,this.tint)}context.drawImage(this.tintedTexture,0,0,frame.width,frame.height,this.anchor.x*-frame.width,this.anchor.y*-frame.height,frame.width,frame.height)}else{if(texture.trim){var trim=texture.trim;context.drawImage(this.texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,trim.x-this.anchor.x*trim.width,trim.y-this.anchor.y*trim.height,frame.width,frame.height)}else{context.drawImage(this.texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,this.anchor.x*-frame.width,this.anchor.y*-frame.height,frame.width,frame.height)}}}for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child._renderCanvas(renderSession)}if(this._mask){renderSession.maskManager.popMask(renderSession.context)}};PIXI.Sprite.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache'+this);return new PIXI.Sprite(texture)};PIXI.Sprite.fromImage=function(imageId,crossorigin,scaleMode){var texture=PIXI.Texture.fromImage(imageId,crossorigin,scaleMode);return new PIXI.Sprite(texture)};PIXI.SpriteBatch=function(texture){PIXI.DisplayObjectContainer.call(this);this.textureThing=texture;this.ready=false};PIXI.SpriteBatch.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.SpriteBatch.constructor=PIXI.SpriteBatch;PIXI.SpriteBatch.prototype.initWebGL=function(gl){this.fastSpriteBatch=new PIXI.WebGLFastSpriteBatch(gl);this.ready=true};PIXI.SpriteBatch.prototype.updateTransform=function(){PIXI.DisplayObject.prototype.updateTransform.call(this)};PIXI.SpriteBatch.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;if(!this.ready)this.initWebGL(renderSession.gl);renderSession.spriteBatch.stop();renderSession.shaderManager.activateShader(renderSession.shaderManager.fastShader);this.fastSpriteBatch.begin(this,renderSession);this.fastSpriteBatch.render(this);renderSession.shaderManager.activateShader(renderSession.shaderManager.defaultShader);renderSession.spriteBatch.start()};PIXI.SpriteBatch.prototype._renderCanvas=function(renderSession){var context=renderSession.context;context.globalAlpha=this.worldAlpha;PIXI.DisplayObject.prototype.updateTransform.call(this);var transform=this.worldTransform;var isRotated=true;for(var i=0;i<this.children.length;i++){var child=this.children[i];if(!child.visible)continue;var texture=child.texture;var frame=texture.frame;context.globalAlpha=this.worldAlpha*child.alpha;if(child.rotation%(Math.PI*2)===0){if(isRotated){context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx,transform.ty);isRotated=false}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*(-frame.width*child.scale.x)+child.position.x+.5|0,child.anchor.y*(-frame.height*child.scale.y)+child.position.y+.5|0,frame.width*child.scale.x,frame.height*child.scale.y)}else{if(!isRotated)isRotated=true;PIXI.DisplayObject.prototype.updateTransform.call(child);var childTransform=child.worldTransform;if(renderSession.roundPixels){context.setTransform(childTransform.a,childTransform.c,childTransform.b,childTransform.d,childTransform.tx|0,childTransform.ty|0)}else{context.setTransform(childTransform.a,childTransform.c,childTransform.b,childTransform.d,childTransform.tx,childTransform.ty)}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*-frame.width+.5|0,child.anchor.y*-frame.height+.5|0,frame.width,frame.height)}}};PIXI.MovieClip=function(textures){PIXI.Sprite.call(this,textures[0]);this.textures=textures;this.animationSpeed=1;this.loop=true;this.onComplete=null;this.currentFrame=0;this.playing=false};PIXI.MovieClip.prototype=Object.create(PIXI.Sprite.prototype);PIXI.MovieClip.prototype.constructor=PIXI.MovieClip;Object.defineProperty(PIXI.MovieClip.prototype,"totalFrames",{get:function(){return this.textures.length}});PIXI.MovieClip.prototype.stop=function(){this.playing=false};PIXI.MovieClip.prototype.play=function(){this.playing=true};PIXI.MovieClip.prototype.gotoAndStop=function(frameNumber){this.playing=false;this.currentFrame=frameNumber;var round=this.currentFrame+.5|0;this.setTexture(this.textures[round%this.textures.length])};PIXI.MovieClip.prototype.gotoAndPlay=function(frameNumber){this.currentFrame=frameNumber;this.playing=true};PIXI.MovieClip.prototype.updateTransform=function(){PIXI.Sprite.prototype.updateTransform.call(this);if(!this.playing)return;this.currentFrame+=this.animationSpeed;var round=this.currentFrame+.5|0;if(this.loop||round<this.textures.length){this.setTexture(this.textures[round%this.textures.length])}else if(round>=this.textures.length){this.gotoAndStop(this.textures.length-1);if(this.onComplete){this.onComplete()}}};PIXI.MovieClip.prototype.fromFrames=function(frames){var textures=[];for(var i=0;i<frames.length;i++){textures.push(new PIXI.Texture.fromFrame(frames[i]))}return new PIXI.MovieClip(textures)};PIXI.MovieClip.prototype.fromImages=function(images){var textures=[];for(var i=0;i<images.length;i++){textures.push(new PIXI.Texture.fromImage(images[i]))}return new PIXI.MovieClip(textures)};PIXI.FilterBlock=function(){this.visible=true;this.renderable=true};PIXI.Text=function(text,style){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");PIXI.Sprite.call(this,PIXI.Texture.fromCanvas(this.canvas));this.setText(text);this.setStyle(style);this.updateText();this.dirty=false};PIXI.Text.prototype=Object.create(PIXI.Sprite.prototype);PIXI.Text.prototype.constructor=PIXI.Text;PIXI.Text.prototype.setStyle=function(style){style=style||{};style.font=style.font||"bold 20pt Arial";style.fill=style.fill||"black";style.align=style.align||"left";style.stroke=style.stroke||"black";style.strokeThickness=style.strokeThickness||0;style.wordWrap=style.wordWrap||false;style.wordWrapWidth=style.wordWrapWidth||100;style.wordWrapWidth=style.wordWrapWidth||100;style.dropShadow=style.dropShadow||false;style.dropShadowAngle=style.dropShadowAngle||Math.PI/6;style.dropShadowDistance=style.dropShadowDistance||4;style.dropShadowColor=style.dropShadowColor||"black";this.style=style;this.dirty=true};PIXI.Text.prototype.setText=function(text){this.text=text.toString()||" ";this.dirty=true};PIXI.Text.prototype.updateText=function(){this.context.font=this.style.font;var outputText=this.text;if(this.style.wordWrap)outputText=this.wordWrap(this.text);var lines=outputText.split(/(?:\r\n|\r|\n)/);var lineWidths=[];var maxLineWidth=0;for(var i=0;i<lines.length;i++){var lineWidth=this.context.measureText(lines[i]).width;lineWidths[i]=lineWidth;maxLineWidth=Math.max(maxLineWidth,lineWidth)}var width=maxLineWidth+this.style.strokeThickness;if(this.style.dropShadow)width+=this.style.dropShadowDistance;this.canvas.width=width+this.context.lineWidth;var lineHeight=this.determineFontHeight("font: "+this.style.font+";")+this.style.strokeThickness;var height=lineHeight*lines.length;if(this.style.dropShadow)height+=this.style.dropShadowDistance;this.canvas.height=height;if(navigator.isCocoonJS)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.font=this.style.font;this.context.strokeStyle=this.style.stroke;this.context.lineWidth=this.style.strokeThickness;this.context.textBaseline="top";var linePositionX;var linePositionY;if(this.style.dropShadow){this.context.fillStyle=this.style.dropShadowColor;var xShadowOffset=Math.sin(this.style.dropShadowAngle)*this.style.dropShadowDistance;var yShadowOffset=Math.cos(this.style.dropShadowAngle)*this.style.dropShadowDistance;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.fill){this.context.fillText(lines[i],linePositionX+xShadowOffset,linePositionY+yShadowOffset)}}}this.context.fillStyle=this.style.fill;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight;if(this.style.align==="right"){linePositionX+=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){linePositionX+=(maxLineWidth-lineWidths[i])/2}if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(lines[i],linePositionX,linePositionY)}if(this.style.fill){this.context.fillText(lines[i],linePositionX,linePositionY)}}this.updateTexture()};PIXI.Text.prototype.updateTexture=function(){this.texture.baseTexture.width=this.canvas.width;this.texture.baseTexture.height=this.canvas.height;this.texture.frame.width=this.canvas.width;this.texture.frame.height=this.canvas.height;this._width=this.canvas.width;this._height=this.canvas.height;this.requiresUpdate=true};PIXI.Text.prototype._renderWebGL=function(renderSession){if(this.requiresUpdate){this.requiresUpdate=false;PIXI.updateWebGLTexture(this.texture.baseTexture,renderSession.gl)}PIXI.Sprite.prototype._renderWebGL.call(this,renderSession)};PIXI.Text.prototype.updateTransform=function(){if(this.dirty){this.updateText();this.dirty=false}PIXI.Sprite.prototype.updateTransform.call(this)};PIXI.Text.prototype.determineFontHeight=function(fontStyle){var result=PIXI.Text.heightCache[fontStyle];if(!result){var body=document.getElementsByTagName("body")[0];var dummy=document.createElement("div");var dummyText=document.createTextNode("M");dummy.appendChild(dummyText);dummy.setAttribute("style",fontStyle+";position:absolute;top:0;left:0");body.appendChild(dummy);result=dummy.offsetHeight;PIXI.Text.heightCache[fontStyle]=result;body.removeChild(dummy)}return result};PIXI.Text.prototype.wordWrap=function(text){var result="";var lines=text.split("\n");for(var i=0;i<lines.length;i++){var spaceLeft=this.style.wordWrapWidth;var words=lines[i].split(" ");for(var j=0;j<words.length;j++){var wordWidth=this.context.measureText(words[j]).width;var wordWidthWithSpace=wordWidth+this.context.measureText(" ").width;if(j===0||wordWidthWithSpace>spaceLeft){if(j>0){result+="\n"}result+=words[j];spaceLeft=this.style.wordWrapWidth-wordWidth}else{spaceLeft-=wordWidthWithSpace;result+=" "+words[j]}}if(i<lines.length-1){result+="\n"}}return result};PIXI.Text.prototype.destroy=function(destroyTexture){if(destroyTexture){this.texture.destroy()}};PIXI.Text.heightCache={};PIXI.BitmapText=function(text,style){PIXI.DisplayObjectContainer.call(this);this._pool=[];this.setText(text);this.setStyle(style);this.updateText();this.dirty=false};PIXI.BitmapText.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.BitmapText.prototype.constructor=PIXI.BitmapText;PIXI.BitmapText.prototype.setText=function(text){this.text=text||" ";this.dirty=true};PIXI.BitmapText.prototype.setStyle=function(style){style=style||{};style.align=style.align||"left";this.style=style;var font=style.font.split(" ");this.fontName=font[font.length-1];this.fontSize=font.length>=2?parseInt(font[font.length-2],10):PIXI.BitmapText.fonts[this.fontName].size;this.dirty=true;this.tint=style.tint};PIXI.BitmapText.prototype.updateText=function(){var data=PIXI.BitmapText.fonts[this.fontName];var pos=new PIXI.Point;var prevCharCode=null;var chars=[];var maxLineWidth=0;var lineWidths=[];var line=0;var scale=this.fontSize/data.size;for(var i=0;i<this.text.length;i++){var charCode=this.text.charCodeAt(i);if(/(?:\r\n|\r|\n)/.test(this.text.charAt(i))){lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue}var charData=data.chars[charCode];if(!charData)continue;if(prevCharCode&&charData[prevCharCode]){pos.x+=charData.kerning[prevCharCode]}chars.push({texture:charData.texture,line:line,charCode:charCode,position:new PIXI.Point(pos.x+charData.xOffset,pos.y+charData.yOffset)});pos.x+=charData.xAdvance;prevCharCode=charCode}lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);var lineAlignOffsets=[];for(i=0;i<=line;i++){var alignOffset=0;if(this.style.align==="right"){alignOffset=maxLineWidth-lineWidths[i]}else if(this.style.align==="center"){alignOffset=(maxLineWidth-lineWidths[i])/2}lineAlignOffsets.push(alignOffset)}var lenChildren=this.children.length;var lenChars=chars.length;var tint=this.tint||16777215;for(i=0;i<lenChars;i++){var c=i<lenChildren?this.children[i]:this._pool.pop();if(c)c.setTexture(chars[i].texture);else c=new PIXI.Sprite(chars[i].texture);c.position.x=(chars[i].position.x+lineAlignOffsets[chars[i].line])*scale;c.position.y=chars[i].position.y*scale;c.scale.x=c.scale.y=scale;c.tint=tint;if(!c.parent)this.addChild(c)}while(this.children.length>lenChars){var child=this.getChildAt(this.children.length-1);this._pool.push(child);this.removeChild(child)}this.textWidth=maxLineWidth*scale;this.textHeight=(pos.y+data.lineHeight)*scale};PIXI.BitmapText.prototype.updateTransform=function(){if(this.dirty){this.updateText();this.dirty=false}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.BitmapText.fonts={};
PIXI.InteractionData=function(){this.global=new PIXI.Point;this.target=null;this.originalEvent=null};PIXI.InteractionData.prototype.getLocalPosition=function(displayObject){var worldTransform=displayObject.worldTransform;var global=this.global;var a00=worldTransform.a,a01=worldTransform.b,a02=worldTransform.tx,a10=worldTransform.c,a11=worldTransform.d,a12=worldTransform.ty,id=1/(a00*a11+a01*-a10);return new PIXI.Point(a11*id*global.x+-a01*id*global.y+(a12*a01-a02*a11)*id,a00*id*global.y+-a10*id*global.x+(-a12*a00+a02*a10)*id)};PIXI.InteractionData.prototype.constructor=PIXI.InteractionData;PIXI.InteractionManager=function(stage){this.stage=stage;this.mouse=new PIXI.InteractionData;this.touchs={};this.tempPoint=new PIXI.Point;this.mouseoverEnabled=true;this.pool=[];this.interactiveItems=[];this.interactionDOMElement=null;this.onMouseMove=this.onMouseMove.bind(this);this.onMouseDown=this.onMouseDown.bind(this);this.onMouseOut=this.onMouseOut.bind(this);this.onMouseUp=this.onMouseUp.bind(this);this.onTouchStart=this.onTouchStart.bind(this);this.onTouchEnd=this.onTouchEnd.bind(this);this.onTouchMove=this.onTouchMove.bind(this);this.last=0;this.currentCursorStyle="inherit";this.mouseOut=false};PIXI.InteractionManager.prototype.constructor=PIXI.InteractionManager;PIXI.InteractionManager.prototype.collectInteractiveSprite=function(displayObject,iParent){var children=displayObject.children;var length=children.length;for(var i=length-1;i>=0;i--){var child=children[i];if(child._interactive){iParent.interactiveChildren=true;this.interactiveItems.push(child);if(child.children.length>0){this.collectInteractiveSprite(child,child)}}else{child.__iParent=null;if(child.children.length>0){this.collectInteractiveSprite(child,iParent)}}}};PIXI.InteractionManager.prototype.setTarget=function(target){this.target=target;if(this.interactionDOMElement===null){this.setTargetDomElement(target.view)}};PIXI.InteractionManager.prototype.setTargetDomElement=function(domElement){this.removeEvents();if(window.navigator.msPointerEnabled){domElement.style["-ms-content-zooming"]="none";domElement.style["-ms-touch-action"]="none"}this.interactionDOMElement=domElement;domElement.addEventListener("mousemove",this.onMouseMove,true);domElement.addEventListener("mousedown",this.onMouseDown,true);domElement.addEventListener("mouseout",this.onMouseOut,true);domElement.addEventListener("touchstart",this.onTouchStart,true);domElement.addEventListener("touchend",this.onTouchEnd,true);domElement.addEventListener("touchmove",this.onTouchMove,true);window.addEventListener("mouseup",this.onMouseUp,true)};PIXI.InteractionManager.prototype.removeEvents=function(){if(!this.interactionDOMElement)return;this.interactionDOMElement.style["-ms-content-zooming"]="";this.interactionDOMElement.style["-ms-touch-action"]="";this.interactionDOMElement.removeEventListener("mousemove",this.onMouseMove,true);this.interactionDOMElement.removeEventListener("mousedown",this.onMouseDown,true);this.interactionDOMElement.removeEventListener("mouseout",this.onMouseOut,true);this.interactionDOMElement.removeEventListener("touchstart",this.onTouchStart,true);this.interactionDOMElement.removeEventListener("touchend",this.onTouchEnd,true);this.interactionDOMElement.removeEventListener("touchmove",this.onTouchMove,true);this.interactionDOMElement=null;window.removeEventListener("mouseup",this.onMouseUp,true)};PIXI.InteractionManager.prototype.update=function(){if(!this.target)return;var now=Date.now();var diff=now-this.last;diff=diff*PIXI.INTERACTION_FREQUENCY/1e3;if(diff<1)return;this.last=now;var i=0;if(this.dirty){this.dirty=false;var len=this.interactiveItems.length;for(i=0;i<len;i++){this.interactiveItems[i].interactiveChildren=false}this.interactiveItems=[];if(this.stage.interactive)this.interactiveItems.push(this.stage);this.collectInteractiveSprite(this.stage,this.stage)}var length=this.interactiveItems.length;var cursor="inherit";var over=false;for(i=0;i<length;i++){var item=this.interactiveItems[i];item.__hit=this.hitTest(item,this.mouse);this.mouse.target=item;if(item.__hit&&!over){if(item.buttonMode)cursor=item.defaultCursor;if(!item.interactiveChildren)over=true;if(!item.__isOver){if(item.mouseover)item.mouseover(this.mouse);item.__isOver=true}}else{if(item.__isOver){if(item.mouseout)item.mouseout(this.mouse);item.__isOver=false}}}if(this.currentCursorStyle!==cursor){this.currentCursorStyle=cursor;this.interactionDOMElement.style.cursor=cursor}};PIXI.InteractionManager.prototype.onMouseMove=function(event){this.mouse.originalEvent=event||window.event;var rect=this.interactionDOMElement.getBoundingClientRect();this.mouse.global.x=(event.clientX-rect.left)*(this.target.width/rect.width);this.mouse.global.y=(event.clientY-rect.top)*(this.target.height/rect.height);var length=this.interactiveItems.length;for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.mousemove){item.mousemove(this.mouse)}}};PIXI.InteractionManager.prototype.onMouseDown=function(event){this.mouse.originalEvent=event||window.event;if(PIXI.AUTO_PREVENT_DEFAULT)this.mouse.originalEvent.preventDefault();var length=this.interactiveItems.length;for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.mousedown||item.click){item.__mouseIsDown=true;item.__hit=this.hitTest(item,this.mouse);if(item.__hit){if(item.mousedown)item.mousedown(this.mouse);item.__isDown=true;if(!item.interactiveChildren)break}}}};PIXI.InteractionManager.prototype.onMouseOut=function(){var length=this.interactiveItems.length;this.interactionDOMElement.style.cursor="inherit";for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.__isOver){this.mouse.target=item;if(item.mouseout)item.mouseout(this.mouse);item.__isOver=false}}this.mouseOut=true;this.mouse.global.x=-1e4;this.mouse.global.y=-1e4};PIXI.InteractionManager.prototype.onMouseUp=function(event){this.mouse.originalEvent=event||window.event;var length=this.interactiveItems.length;var up=false;for(var i=0;i<length;i++){var item=this.interactiveItems[i];item.__hit=this.hitTest(item,this.mouse);if(item.__hit&&!up){if(item.mouseup){item.mouseup(this.mouse)}if(item.__isDown){if(item.click)item.click(this.mouse)}if(!item.interactiveChildren)up=true}else{if(item.__isDown){if(item.mouseupoutside)item.mouseupoutside(this.mouse)}}item.__isDown=false}};PIXI.InteractionManager.prototype.hitTest=function(item,interactionData){var global=interactionData.global;if(!item.worldVisible)return false;var isSprite=item instanceof PIXI.Sprite,worldTransform=item.worldTransform,a00=worldTransform.a,a01=worldTransform.b,a02=worldTransform.tx,a10=worldTransform.c,a11=worldTransform.d,a12=worldTransform.ty,id=1/(a00*a11+a01*-a10),x=a11*id*global.x+-a01*id*global.y+(a12*a01-a02*a11)*id,y=a00*id*global.y+-a10*id*global.x+(-a12*a00+a02*a10)*id;interactionData.target=item;if(item.hitArea&&item.hitArea.contains){if(item.hitArea.contains(x,y)){interactionData.target=item;return true}return false}else if(isSprite){var width=item.texture.frame.width,height=item.texture.frame.height,x1=-width*item.anchor.x,y1;if(x>x1&&x<x1+width){y1=-height*item.anchor.y;if(y>y1&&y<y1+height){interactionData.target=item;return true}}}var length=item.children.length;for(var i=0;i<length;i++){var tempItem=item.children[i];var hit=this.hitTest(tempItem,interactionData);if(hit){interactionData.target=item;return true}}return false};PIXI.InteractionManager.prototype.onTouchMove=function(event){var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var touchData;var i=0;for(i=0;i<changedTouches.length;i++){var touchEvent=changedTouches[i];touchData=this.touchs[touchEvent.identifier];touchData.originalEvent=event||window.event;touchData.global.x=(touchEvent.clientX-rect.left)*(this.target.width/rect.width);touchData.global.y=(touchEvent.clientY-rect.top)*(this.target.height/rect.height);if(navigator.isCocoonJS){touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}for(var j=0;j<this.interactiveItems.length;j++){var item=this.interactiveItems[j];if(item.touchmove&&item.__touchData[touchEvent.identifier])item.touchmove(touchData)}}};PIXI.InteractionManager.prototype.onTouchStart=function(event){var rect=this.interactionDOMElement.getBoundingClientRect();if(PIXI.AUTO_PREVENT_DEFAULT)event.preventDefault();var changedTouches=event.changedTouches;for(var i=0;i<changedTouches.length;i++){var touchEvent=changedTouches[i];var touchData=this.pool.pop();if(!touchData)touchData=new PIXI.InteractionData;touchData.originalEvent=event||window.event;this.touchs[touchEvent.identifier]=touchData;touchData.global.x=(touchEvent.clientX-rect.left)*(this.target.width/rect.width);touchData.global.y=(touchEvent.clientY-rect.top)*(this.target.height/rect.height);if(navigator.isCocoonJS){touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.touchstart||item.tap){item.__hit=this.hitTest(item,touchData);if(item.__hit){if(item.touchstart)item.touchstart(touchData);item.__isDown=true;item.__touchData=item.__touchData||{};item.__touchData[touchEvent.identifier]=touchData;if(!item.interactiveChildren)break}}}}};PIXI.InteractionManager.prototype.onTouchEnd=function(event){var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;for(var i=0;i<changedTouches.length;i++){var touchEvent=changedTouches[i];var touchData=this.touchs[touchEvent.identifier];var up=false;touchData.global.x=(touchEvent.clientX-rect.left)*(this.target.width/rect.width);touchData.global.y=(touchEvent.clientY-rect.top)*(this.target.height/rect.height);if(navigator.isCocoonJS){touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.__touchData&&item.__touchData[touchEvent.identifier]){item.__hit=this.hitTest(item,item.__touchData[touchEvent.identifier]);touchData.originalEvent=event||window.event;if(item.touchend||item.tap){if(item.__hit&&!up){if(item.touchend)item.touchend(touchData);if(item.__isDown){if(item.tap)item.tap(touchData)}if(!item.interactiveChildren)up=true}else{if(item.__isDown){if(item.touchendoutside)item.touchendoutside(touchData)}}item.__isDown=false}item.__touchData[touchEvent.identifier]=null}}this.pool.push(touchData);this.touchs[touchEvent.identifier]=null}};PIXI.Stage=function(backgroundColor){PIXI.DisplayObjectContainer.call(this);this.worldTransform=new PIXI.Matrix;this.interactive=true;this.interactionManager=new PIXI.InteractionManager(this);this.dirty=true;this.stage=this;this.stage.hitArea=new PIXI.Rectangle(0,0,1e5,1e5);this.setBackgroundColor(backgroundColor)};PIXI.Stage.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Stage.prototype.constructor=PIXI.Stage;PIXI.Stage.prototype.setInteractionDelegate=function(domElement){this.interactionManager.setTargetDomElement(domElement)};PIXI.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform()}if(this.dirty){this.dirty=false;this.interactionManager.dirty=true}if(this.interactive)this.interactionManager.update()};PIXI.Stage.prototype.setBackgroundColor=function(backgroundColor){this.backgroundColor=backgroundColor||0;this.backgroundColorSplit=PIXI.hex2rgb(this.backgroundColor);var hex=this.backgroundColor.toString(16);hex="000000".substr(0,6-hex.length)+hex;this.backgroundColorString="#"+hex};PIXI.Stage.prototype.getMousePosition=function(){return this.interactionManager.mouse.global};var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){clearTimeout(id)}}window.requestAnimFrame=window.requestAnimationFrame;PIXI.hex2rgb=function(hex){return[(hex>>16&255)/255,(hex>>8&255)/255,(hex&255)/255]};PIXI.rgb2hex=function(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255};if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(){var slice=Array.prototype.slice;return function(thisArg){var target=this,boundArgs=slice.call(arguments,1);if(typeof target!=="function")throw new TypeError;function bound(){var args=boundArgs.concat(slice.call(arguments));target.apply(this instanceof bound?this:thisArg,args)}bound.prototype=function F(proto){if(proto)F.prototype=proto;if(!(this instanceof F))return new F}(target.prototype);return bound}}()}PIXI.AjaxRequest=function(){var activexmodes=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];if(window.ActiveXObject){for(var i=0;i<activexmodes.length;i++){try{return new window.ActiveXObject(activexmodes[i])}catch(e){}}}else if(window.XMLHttpRequest){return new window.XMLHttpRequest}else{return false}};PIXI.canUseNewCanvasBlendModes=function(){var canvas=document.createElement("canvas");canvas.width=1;canvas.height=1;var context=canvas.getContext("2d");context.fillStyle="#000";context.fillRect(0,0,1,1);context.globalCompositeOperation="multiply";context.fillStyle="#fff";context.fillRect(0,0,1,1);return context.getImageData(0,0,1,1).data[0]===0};PIXI.getNextPowerOfTwo=function(number){if(number>0&&(number&number-1)===0)return number;else{var result=1;while(result<number)result<<=1;return result}};PIXI.EventTarget=function(){var listeners={};this.addEventListener=this.on=function(type,listener){if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}};this.dispatchEvent=this.emit=function(event){if(!listeners[event.type]||!listeners[event.type].length){return}for(var i=0,l=listeners[event.type].length;i<l;i++){listeners[event.type][i](event)}};this.removeEventListener=this.off=function(type,listener){var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}};this.removeAllEventListeners=function(type){var a=listeners[type];if(a)a.length=0}};PIXI.autoDetectRenderer=function(width,height,view,transparent,antialias){if(!width)width=800;if(!height)height=600;var webgl=function(){try{var canvas=document.createElement("canvas");return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();if(webgl){return new PIXI.WebGLRenderer(width,height,view,transparent,antialias)}return new PIXI.CanvasRenderer(width,height,view,transparent)};PIXI.autoDetectRecommendedRenderer=function(width,height,view,transparent,antialias){if(!width)width=800;if(!height)height=600;var webgl=function(){try{var canvas=document.createElement("canvas");return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();var isAndroid=/Android/i.test(navigator.userAgent);if(webgl&&!isAndroid){return new PIXI.WebGLRenderer(width,height,view,transparent,antialias)}return new PIXI.CanvasRenderer(width,height,view,transparent)};PIXI.PolyK={};PIXI.PolyK.Triangulate=function(p){var sign=true;var n=p.length>>1;if(n<3)return[];var tgs=[];var avl=[];for(var i=0;i<n;i++)avl.push(i);i=0;var al=n;while(al>3){var i0=avl[(i+0)%al];var i1=avl[(i+1)%al];var i2=avl[(i+2)%al];var ax=p[2*i0],ay=p[2*i0+1];var bx=p[2*i1],by=p[2*i1+1];var cx=p[2*i2],cy=p[2*i2+1];var earFound=false;if(PIXI.PolyK._convex(ax,ay,bx,by,cx,cy,sign)){earFound=true;for(var j=0;j<al;j++){var vi=avl[j];if(vi===i0||vi===i1||vi===i2)continue;if(PIXI.PolyK._PointInTriangle(p[2*vi],p[2*vi+1],ax,ay,bx,by,cx,cy)){earFound=false;break}}}if(earFound){tgs.push(i0,i1,i2);avl.splice((i+1)%al,1);al--;i=0}else if(i++>3*al){if(sign){tgs=[];avl=[];for(i=0;i<n;i++)avl.push(i);i=0;al=n;sign=false}else{window.console.log("PIXI Warning: shape too complex to fill");return[]}}}tgs.push(avl[0],avl[1],avl[2]);return tgs};PIXI.PolyK._PointInTriangle=function(px,py,ax,ay,bx,by,cx,cy){var v0x=cx-ax;var v0y=cy-ay;var v1x=bx-ax;var v1y=by-ay;var v2x=px-ax;var v2y=py-ay;var dot00=v0x*v0x+v0y*v0y;var dot01=v0x*v1x+v0y*v1y;var dot02=v0x*v2x+v0y*v2y;var dot11=v1x*v1x+v1y*v1y;var dot12=v1x*v2x+v1y*v2y;var invDenom=1/(dot00*dot11-dot01*dot01);var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return u>=0&&v>=0&&u+v<1};PIXI.PolyK._convex=function(ax,ay,bx,by,cx,cy,sign){return(ay-by)*(cx-bx)+(bx-ax)*(cy-by)>=0===sign};PIXI.initDefaultShaders=function(){};PIXI.CompileVertexShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.VERTEX_SHADER)};PIXI.CompileFragmentShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.FRAGMENT_SHADER)};PIXI._CompileShader=function(gl,shaderSrc,shaderType){var src=shaderSrc.join("\n");var shader=gl.createShader(shaderType);gl.shaderSource(shader,src);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){window.console.log(gl.getShaderInfoLog(shader));return null}return shader};PIXI.compileProgram=function(gl,vertexSrc,fragmentSrc){var fragmentShader=PIXI.CompileFragmentShader(gl,fragmentSrc);var vertexShader=PIXI.CompileVertexShader(gl,vertexSrc);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){window.console.log("Could not initialise shaders")}return shaderProgram};PIXI.PixiShader=function(gl){this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.textureCount=0;this.attributes=[];this.init()};PIXI.PixiShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc||PIXI.PixiShader.defaultVertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aTextureCoord,this.colorAttribute];for(var key in this.uniforms){this.uniforms[key].uniformLocation=gl.getUniformLocation(program,key)}this.initUniforms();this.program=program};PIXI.PixiShader.prototype.initUniforms=function(){this.textureCount=1;var gl=this.gl;var uniform;for(var key in this.uniforms){uniform=this.uniforms[key];var type=uniform.type;if(type==="sampler2D"){uniform._init=false;if(uniform.value!==null){this.initSampler2D(uniform)}}else if(type==="mat2"||type==="mat3"||type==="mat4"){uniform.glMatrix=true;uniform.glValueLength=1;if(type==="mat2"){uniform.glFunc=gl.uniformMatrix2fv}else if(type==="mat3"){uniform.glFunc=gl.uniformMatrix3fv}else if(type==="mat4"){uniform.glFunc=gl.uniformMatrix4fv}}else{uniform.glFunc=gl["uniform"+type];if(type==="2f"||type==="2i"){uniform.glValueLength=2}else if(type==="3f"||type==="3i"){uniform.glValueLength=3}else if(type==="4f"||type==="4i"){uniform.glValueLength=4}else{uniform.glValueLength=1}}}};PIXI.PixiShader.prototype.initSampler2D=function(uniform){if(!uniform.value||!uniform.value.baseTexture||!uniform.value.baseTexture.hasLoaded){return}var gl=this.gl;gl.activeTexture(gl["TEXTURE"+this.textureCount]);gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]);if(uniform.textureData){var data=uniform.textureData;var magFilter=data.magFilter?data.magFilter:gl.LINEAR;var minFilter=data.minFilter?data.minFilter:gl.LINEAR;var wrapS=data.wrapS?data.wrapS:gl.CLAMP_TO_EDGE;var wrapT=data.wrapT?data.wrapT:gl.CLAMP_TO_EDGE;var format=data.luminance?gl.LUMINANCE:gl.RGBA;if(data.repeat){wrapS=gl.REPEAT;wrapT=gl.REPEAT}gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!!data.flipY);if(data.width){var width=data.width?data.width:512;var height=data.height?data.height:2;var border=data.border?data.border:0;gl.texImage2D(gl.TEXTURE_2D,0,format,width,height,border,format,gl.UNSIGNED_BYTE,null)}else{gl.texImage2D(gl.TEXTURE_2D,0,format,gl.RGBA,gl.UNSIGNED_BYTE,uniform.value.baseTexture.source)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrapS);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrapT)}gl.uniform1i(uniform.uniformLocation,this.textureCount);uniform._init=true;this.textureCount++};PIXI.PixiShader.prototype.syncUniforms=function(){this.textureCount=1;var uniform;var gl=this.gl;for(var key in this.uniforms){uniform=this.uniforms[key];if(uniform.glValueLength===1){if(uniform.glMatrix===true){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.transpose,uniform.value)}else{uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value)}}else if(uniform.glValueLength===2){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y)}else if(uniform.glValueLength===3){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z)}else if(uniform.glValueLength===4){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z,uniform.value.w)}else if(uniform.type==="sampler2D"){if(uniform._init){gl.activeTexture(gl["TEXTURE"+this.textureCount]);gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]||PIXI.createWebGLTexture(uniform.value.baseTexture,gl));gl.uniform1i(uniform.uniformLocation,this.textureCount);this.textureCount++}else{this.initSampler2D(uniform)}}}};PIXI.PixiShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.PixiShader.defaultVertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec2 aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","varying vec4 vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   gl_Position = vec4( ((aVertexPosition + offsetVector) / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vec3 color = mod(vec3(aColor.y/65536.0, aColor.y/256.0, aColor.y), 256.0) / 256.0;","   vColor = vec4(color * aColor.x, aColor.x);","}"];PIXI.PixiFastShader=function(gl){this.gl=gl;this.program=null;this.fragmentSrc=["precision lowp float;","varying vec2 vTextureCoord;","varying float vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aPositionCoord;","attribute vec2 aScale;","attribute float aRotation;","attribute vec2 aTextureCoord;","attribute float aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform mat3 uMatrix;","varying vec2 vTextureCoord;","varying float vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   vec2 v;","   vec2 sv = aVertexPosition * aScale;","   v.x = (sv.x) * cos(aRotation) - (sv.y) * sin(aRotation);","   v.y = (sv.x) * sin(aRotation) + (sv.y) * cos(aRotation);","   v = ( uMatrix * vec3(v + aPositionCoord , 1.0) ).xy ;","   gl_Position = vec4( ( v / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = aColor;","}"];this.textureCount=0;this.init()};PIXI.PixiFastShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.dimensions=gl.getUniformLocation(program,"dimensions");this.uMatrix=gl.getUniformLocation(program,"uMatrix");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aPositionCoord=gl.getAttribLocation(program,"aPositionCoord");this.aScale=gl.getAttribLocation(program,"aScale");this.aRotation=gl.getAttribLocation(program,"aRotation");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.colorAttribute=gl.getAttribLocation(program,"aColor");if(this.colorAttribute===-1){this.colorAttribute=2}this.attributes=[this.aVertexPosition,this.aPositionCoord,this.aScale,this.aRotation,this.aTextureCoord,this.colorAttribute];this.program=program};PIXI.PixiFastShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null};PIXI.StripShader=function(){this.program=null;this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying float vColor;","uniform float alpha;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y));","   gl_FragColor = gl_FragColor * alpha;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute float aColor;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","varying vec2 vTextureCoord;","uniform vec2 offsetVector;","varying float vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition, 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, v.y / projectionVector.y + 1.0 , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = aColor;","}"]};PIXI.StripShader.prototype.init=function(){var gl=PIXI.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.uSampler=gl.getUniformLocation(program,"uSampler");this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.aTextureCoord=gl.getAttribLocation(program,"aTextureCoord");this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.PrimitiveShader=function(gl){this.gl=gl;this.program=null;this.fragmentSrc=["precision mediump float;","varying vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"];this.vertexSrc=["attribute vec2 aVertexPosition;","attribute vec4 aColor;","uniform mat3 translationMatrix;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","uniform float alpha;","uniform vec3 tint;","varying vec4 vColor;","void main(void) {","   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);","   v -= offsetVector.xyx;","   gl_Position = vec4( v.x / projectionVector.x -1.0, v.y / -projectionVector.y + 1.0 , 0.0, 1.0);","   vColor = aColor * vec4(tint * alpha, alpha);","}"];this.init()};PIXI.PrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);this.projectionVector=gl.getUniformLocation(program,"projectionVector");this.offsetVector=gl.getUniformLocation(program,"offsetVector");this.tintColor=gl.getUniformLocation(program,"tint");this.aVertexPosition=gl.getAttribLocation(program,"aVertexPosition");this.colorAttribute=gl.getAttribLocation(program,"aColor");this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,"translationMatrix");this.alpha=gl.getUniformLocation(program,"alpha");this.program=program};PIXI.PrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null};PIXI.WebGLGraphics=function(){};PIXI.WebGLGraphics.renderGraphics=function(graphics,renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.primitiveShader;if(!graphics._webGL[gl.id])graphics._webGL[gl.id]={points:[],indices:[],lastIndex:0,buffer:gl.createBuffer(),indexBuffer:gl.createBuffer()};var webGL=graphics._webGL[gl.id];if(graphics.dirty){graphics.dirty=false;if(graphics.clearDirty){graphics.clearDirty=false;webGL.lastIndex=0;webGL.points=[];webGL.indices=[]}PIXI.WebGLGraphics.updateGraphics(graphics,gl)}renderSession.shaderManager.activatePrimitiveShader();gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGL.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGL.indexBuffer);gl.drawElements(gl.TRIANGLE_STRIP,webGL.indices.length,gl.UNSIGNED_SHORT,0);renderSession.shaderManager.deactivatePrimitiveShader()};PIXI.WebGLGraphics.updateGraphics=function(graphics,gl){var webGL=graphics._webGL[gl.id];for(var i=webGL.lastIndex;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];if(data.type===PIXI.Graphics.POLY){if(data.fill){if(data.points.length>3)PIXI.WebGLGraphics.buildPoly(data,webGL)}if(data.lineWidth>0){PIXI.WebGLGraphics.buildLine(data,webGL)}}else if(data.type===PIXI.Graphics.RECT){PIXI.WebGLGraphics.buildRectangle(data,webGL)}else if(data.type===PIXI.Graphics.CIRC||data.type===PIXI.Graphics.ELIP){PIXI.WebGLGraphics.buildCircle(data,webGL)}}webGL.lastIndex=graphics.graphicsData.length;webGL.glPoints=new Float32Array(webGL.points);gl.bindBuffer(gl.ARRAY_BUFFER,webGL.buffer);gl.bufferData(gl.ARRAY_BUFFER,webGL.glPoints,gl.STATIC_DRAW);webGL.glIndicies=new Uint16Array(webGL.indices);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGL.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,webGL.glIndicies,gl.STATIC_DRAW)};PIXI.WebGLGraphics.buildRectangle=function(graphicsData,webGLData){var rectData=graphicsData.points;var x=rectData[0];var y=rectData[1];var width=rectData[2];var height=rectData[3];if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vertPos=verts.length/6;verts.push(x,y);verts.push(r,g,b,alpha);verts.push(x+width,y);verts.push(r,g,b,alpha);verts.push(x,y+height);verts.push(r,g,b,alpha);verts.push(x+width,y+height);verts.push(r,g,b,alpha);indices.push(vertPos,vertPos,vertPos+1,vertPos+2,vertPos+3,vertPos+3)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[x,y,x+width,y,x+width,y+height,x,y+height,x,y];PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildCircle=function(graphicsData,webGLData){var rectData=graphicsData.points;var x=rectData[0];var y=rectData[1];var width=rectData[2];var height=rectData[3];var totalSegs=40;var seg=Math.PI*2/totalSegs;var i=0;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;
var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;indices.push(vecPos);for(i=0;i<totalSegs+1;i++){verts.push(x,y,r,g,b,alpha);verts.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height,r,g,b,alpha);indices.push(vecPos++,vecPos++)}indices.push(vecPos-1)}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[];for(i=0;i<totalSegs+1;i++){graphicsData.points.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height)}PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints}};PIXI.WebGLGraphics.buildLine=function(graphicsData,webGLData){var i=0;var points=graphicsData.points;if(points.length===0)return;if(graphicsData.lineWidth%2){for(i=0;i<points.length;i++){points[i]+=.5}}var firstPoint=new PIXI.Point(points[0],points[1]);var lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);if(firstPoint.x===lastPoint.x&&firstPoint.y===lastPoint.y){points.pop();points.pop();lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);var midPointX=lastPoint.x+(firstPoint.x-lastPoint.x)*.5;var midPointY=lastPoint.y+(firstPoint.y-lastPoint.y)*.5;points.unshift(midPointX,midPointY);points.push(midPointX,midPointY)}var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var indexCount=points.length;var indexStart=verts.length/6;var width=graphicsData.lineWidth/2;var color=PIXI.hex2rgb(graphicsData.lineColor);var alpha=graphicsData.lineAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var px,py,p1x,p1y,p2x,p2y,p3x,p3y;var perpx,perpy,perp2x,perp2y,perp3x,perp3y;var a1,b1,c1,a2,b2,c2;var denom,pdist,dist;p1x=points[0];p1y=points[1];p2x=points[2];p2y=points[3];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p1x-perpx,p1y-perpy,r,g,b,alpha);verts.push(p1x+perpx,p1y+perpy,r,g,b,alpha);for(i=1;i<length-1;i++){p1x=points[(i-1)*2];p1y=points[(i-1)*2+1];p2x=points[i*2];p2y=points[i*2+1];p3x=points[(i+1)*2];p3y=points[(i+1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;perp2x=-(p2y-p3y);perp2y=p2x-p3x;dist=Math.sqrt(perp2x*perp2x+perp2y*perp2y);perp2x/=dist;perp2y/=dist;perp2x*=width;perp2y*=width;a1=-perpy+p1y-(-perpy+p2y);b1=-perpx+p2x-(-perpx+p1x);c1=(-perpx+p1x)*(-perpy+p2y)-(-perpx+p2x)*(-perpy+p1y);a2=-perp2y+p3y-(-perp2y+p2y);b2=-perp2x+p2x-(-perp2x+p3x);c2=(-perp2x+p3x)*(-perp2y+p2y)-(-perp2x+p2x)*(-perp2y+p3y);denom=a1*b2-a2*b1;if(Math.abs(denom)<.1){denom+=10.1;verts.push(p2x-perpx,p2y-perpy,r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy,r,g,b,alpha);continue}px=(b1*c2-b2*c1)/denom;py=(a2*c1-a1*c2)/denom;pdist=(px-p2x)*(px-p2x)+(py-p2y)+(py-p2y);if(pdist>140*140){perp3x=perpx-perp2x;perp3y=perpy-perp2y;dist=Math.sqrt(perp3x*perp3x+perp3y*perp3y);perp3x/=dist;perp3y/=dist;perp3x*=width;perp3y*=width;verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);verts.push(p2x+perp3x,p2y+perp3y);verts.push(r,g,b,alpha);verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);indexCount++}else{verts.push(px,py);verts.push(r,g,b,alpha);verts.push(p2x-(px-p2x),p2y-(py-p2y));verts.push(r,g,b,alpha)}}p1x=points[(length-2)*2];p1y=points[(length-2)*2+1];p2x=points[(length-1)*2];p2y=points[(length-1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p2x-perpx,p2y-perpy);verts.push(r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy);verts.push(r,g,b,alpha);indices.push(indexStart);for(i=0;i<indexCount;i++){indices.push(indexStart++)}indices.push(indexStart-1)};PIXI.WebGLGraphics.buildPoly=function(graphicsData,webGLData){var points=graphicsData.points;if(points.length<6)return;var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var triangles=PIXI.PolyK.Triangulate(points);var vertPos=verts.length/6;var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vertPos);indices.push(triangles[i]+vertPos);indices.push(triangles[i+1]+vertPos);indices.push(triangles[i+2]+vertPos);indices.push(triangles[i+2]+vertPos)}for(i=0;i<length;i++){verts.push(points[i*2],points[i*2+1],r,g,b,alpha)}};PIXI.glContexts=[];PIXI.WebGLRenderer=function(width,height,view,transparent,antialias){if(!PIXI.defaultRenderer)PIXI.defaultRenderer=this;this.type=PIXI.WEBGL_RENDERER;this.transparent=!!transparent;this.width=width||800;this.height=height||600;this.view=view||document.createElement("canvas");this.view.width=this.width;this.view.height=this.height;this.contextLost=this.handleContextLost.bind(this);this.contextRestoredLost=this.handleContextRestored.bind(this);this.view.addEventListener("webglcontextlost",this.contextLost,false);this.view.addEventListener("webglcontextrestored",this.contextRestoredLost,false);this.options={alpha:this.transparent,antialias:!!antialias,premultipliedAlpha:!!transparent,stencil:true};try{this.gl=this.view.getContext("experimental-webgl",this.options)}catch(e){try{this.gl=this.view.getContext("webgl",this.options)}catch(e2){throw new Error(" This browser does not support webGL. Try using the canvas renderer"+this)}}var gl=this.gl;this.glContextId=gl.id=PIXI.WebGLRenderer.glContextId++;PIXI.glContexts[this.glContextId]=gl;if(!PIXI.blendModesWebGL){PIXI.blendModesWebGL=[];PIXI.blendModesWebGL[PIXI.blendModes.NORMAL]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.ADD]=[gl.SRC_ALPHA,gl.DST_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.MULTIPLY]=[gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SCREEN]=[gl.SRC_ALPHA,gl.ONE];PIXI.blendModesWebGL[PIXI.blendModes.OVERLAY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DARKEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LIGHTEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_DODGE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_BURN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HARD_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SOFT_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DIFFERENCE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.EXCLUSION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HUE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SATURATION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LUMINOSITY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA]}this.projection=new PIXI.Point;this.projection.x=this.width/2;this.projection.y=-this.height/2;this.offset=new PIXI.Point(0,0);this.resize(this.width,this.height);this.contextLost=false;this.shaderManager=new PIXI.WebGLShaderManager(gl);this.spriteBatch=new PIXI.WebGLSpriteBatch(gl);this.maskManager=new PIXI.WebGLMaskManager(gl);this.filterManager=new PIXI.WebGLFilterManager(gl,this.transparent);this.renderSession={};this.renderSession.gl=this.gl;this.renderSession.drawCount=0;this.renderSession.shaderManager=this.shaderManager;this.renderSession.maskManager=this.maskManager;this.renderSession.filterManager=this.filterManager;this.renderSession.spriteBatch=this.spriteBatch;this.renderSession.renderer=this;gl.useProgram(this.shaderManager.defaultShader.program);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.colorMask(true,true,true,this.transparent)};PIXI.WebGLRenderer.prototype.constructor=PIXI.WebGLRenderer;PIXI.WebGLRenderer.prototype.render=function(stage){if(this.contextLost)return;if(this.__stage!==stage){if(stage.interactive)stage.interactionManager.removeEvents();this.__stage=stage}PIXI.WebGLRenderer.updateTextures();stage.updateTransform();if(stage._interactive){if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this)}}var gl=this.gl;gl.viewport(0,0,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.transparent){gl.clearColor(0,0,0,0)}else{gl.clearColor(stage.backgroundColorSplit[0],stage.backgroundColorSplit[1],stage.backgroundColorSplit[2],1)}gl.clear(gl.COLOR_BUFFER_BIT);this.renderDisplayObject(stage,this.projection);if(stage.interactive){if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this)}}else{if(stage._interactiveEventsAdded){stage._interactiveEventsAdded=false;stage.interactionManager.setTarget(this)}}};PIXI.WebGLRenderer.prototype.renderDisplayObject=function(displayObject,projection,buffer){this.renderSession.drawCount=0;this.renderSession.currentBlendMode=9999;this.renderSession.projection=projection;this.renderSession.offset=this.offset;this.spriteBatch.begin(this.renderSession);this.filterManager.begin(this.renderSession,buffer);displayObject._renderWebGL(this.renderSession);this.spriteBatch.end()};PIXI.WebGLRenderer.updateTextures=function(){var i=0;for(i=0;i<PIXI.Texture.frameUpdates.length;i++)PIXI.WebGLRenderer.updateTextureFrame(PIXI.Texture.frameUpdates[i]);for(i=0;i<PIXI.texturesToDestroy.length;i++)PIXI.WebGLRenderer.destroyTexture(PIXI.texturesToDestroy[i]);PIXI.texturesToUpdate.length=0;PIXI.texturesToDestroy.length=0;PIXI.Texture.frameUpdates.length=0};PIXI.WebGLRenderer.destroyTexture=function(texture){for(var i=texture._glTextures.length-1;i>=0;i--){var glTexture=texture._glTextures[i];var gl=PIXI.glContexts[i];if(gl&&glTexture){gl.deleteTexture(glTexture)}}texture._glTextures.length=0};PIXI.WebGLRenderer.updateTextureFrame=function(texture){texture.updateFrame=false;texture._updateWebGLuvs()};PIXI.WebGLRenderer.prototype.resize=function(width,height){this.width=width;this.height=height;this.view.width=width;this.view.height=height;this.gl.viewport(0,0,this.width,this.height);this.projection.x=this.width/2;this.projection.y=-this.height/2};PIXI.createWebGLTexture=function(texture,gl){if(texture.hasLoaded){texture._glTextures[gl.id]=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.source);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);if(!texture._powerOf2){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT)}gl.bindTexture(gl.TEXTURE_2D,null)}return texture._glTextures[gl.id]};PIXI.updateWebGLTexture=function(texture,gl){if(texture._glTextures[gl.id]){gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.source);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);if(!texture._powerOf2){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT)}gl.bindTexture(gl.TEXTURE_2D,null)}};PIXI.WebGLRenderer.prototype.handleContextLost=function(event){event.preventDefault();this.contextLost=true};PIXI.WebGLRenderer.prototype.handleContextRestored=function(){try{this.gl=this.view.getContext("experimental-webgl",this.options)}catch(e){try{this.gl=this.view.getContext("webgl",this.options)}catch(e2){throw new Error(" This browser does not support webGL. Try using the canvas renderer"+this)}}var gl=this.gl;gl.id=PIXI.WebGLRenderer.glContextId++;this.shaderManager.setContext(gl);this.spriteBatch.setContext(gl);this.maskManager.setContext(gl);this.filterManager.setContext(gl);this.renderSession.gl=this.gl;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.colorMask(true,true,true,this.transparent);this.gl.viewport(0,0,this.width,this.height);for(var key in PIXI.TextureCache){var texture=PIXI.TextureCache[key].baseTexture;texture._glTextures=[]}this.contextLost=false};PIXI.WebGLRenderer.prototype.destroy=function(){this.view.removeEventListener("webglcontextlost",this.contextLost);this.view.removeEventListener("webglcontextrestored",this.contextRestoredLost);PIXI.glContexts[this.glContextId]=null;this.projection=null;this.offset=null;this.shaderManager.destroy();this.spriteBatch.destroy();this.maskManager.destroy();this.filterManager.destroy();this.shaderManager=null;this.spriteBatch=null;this.maskManager=null;this.filterManager=null;this.gl=null;this.renderSession=null};PIXI.WebGLRenderer.glContextId=0;PIXI.WebGLMaskManager=function(gl){this.maskStack=[];this.maskPosition=0;this.setContext(gl)};PIXI.WebGLMaskManager.prototype.setContext=function(gl){this.gl=gl};PIXI.WebGLMaskManager.prototype.pushMask=function(maskData,renderSession){var gl=this.gl;if(this.maskStack.length===0){gl.enable(gl.STENCIL_TEST);gl.stencilFunc(gl.ALWAYS,1,1)}this.maskStack.push(maskData);gl.colorMask(false,false,false,false);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR);PIXI.WebGLGraphics.renderGraphics(maskData,renderSession);gl.colorMask(true,true,true,true);gl.stencilFunc(gl.NOTEQUAL,0,this.maskStack.length);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP)};PIXI.WebGLMaskManager.prototype.popMask=function(renderSession){var gl=this.gl;var maskData=this.maskStack.pop();if(maskData){gl.colorMask(false,false,false,false);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR);PIXI.WebGLGraphics.renderGraphics(maskData,renderSession);gl.colorMask(true,true,true,true);gl.stencilFunc(gl.NOTEQUAL,0,this.maskStack.length);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP)}if(this.maskStack.length===0)gl.disable(gl.STENCIL_TEST)};PIXI.WebGLMaskManager.prototype.destroy=function(){this.maskStack=null;this.gl=null};PIXI.WebGLShaderManager=function(gl){this.maxAttibs=10;this.attribState=[];this.tempAttribState=[];for(var i=0;i<this.maxAttibs;i++){this.attribState[i]=false}this.setContext(gl)};PIXI.WebGLShaderManager.prototype.setContext=function(gl){this.gl=gl;this.primitiveShader=new PIXI.PrimitiveShader(gl);this.defaultShader=new PIXI.PixiShader(gl);this.fastShader=new PIXI.PixiFastShader(gl);this.activateShader(this.defaultShader)};PIXI.WebGLShaderManager.prototype.setAttribs=function(attribs){var i;for(i=0;i<this.tempAttribState.length;i++){this.tempAttribState[i]=false}for(i=0;i<attribs.length;i++){var attribId=attribs[i];this.tempAttribState[attribId]=true}var gl=this.gl;for(i=0;i<this.attribState.length;i++){if(this.attribState[i]!==this.tempAttribState[i]){this.attribState[i]=this.tempAttribState[i];if(this.tempAttribState[i]){gl.enableVertexAttribArray(i)}else{gl.disableVertexAttribArray(i)}}}};PIXI.WebGLShaderManager.prototype.activateShader=function(shader){this.currentShader=shader;this.gl.useProgram(shader.program);this.setAttribs(shader.attributes)};PIXI.WebGLShaderManager.prototype.activatePrimitiveShader=function(){var gl=this.gl;gl.useProgram(this.primitiveShader.program);this.setAttribs(this.primitiveShader.attributes)};PIXI.WebGLShaderManager.prototype.deactivatePrimitiveShader=function(){var gl=this.gl;gl.useProgram(this.defaultShader.program);this.setAttribs(this.defaultShader.attributes)};PIXI.WebGLShaderManager.prototype.destroy=function(){this.attribState=null;this.tempAttribState=null;this.primitiveShader.destroy();this.defaultShader.destroy();this.fastShader.destroy();this.gl=null};PIXI.WebGLSpriteBatch=function(gl){this.vertSize=6;this.size=2e3;var numVerts=this.size*4*this.vertSize;var numIndices=this.size*6;this.vertices=new Float32Array(numVerts);this.indices=new Uint16Array(numIndices);this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.setContext(gl)};PIXI.WebGLSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);this.currentBlendMode=99999};PIXI.WebGLSpriteBatch.prototype.begin=function(renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.defaultShader;this.start()};PIXI.WebGLSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLSpriteBatch.prototype.render=function(sprite){var texture=sprite.texture;if(texture.baseTexture!==this.currentBaseTexture||this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}if(sprite.blendMode!==this.currentBlendMode){this.setBlendMode(sprite.blendMode)}var uvs=sprite._uvs||sprite.texture._uvs;if(!uvs)return;var alpha=sprite.worldAlpha;var tint=sprite.tint;var verticies=this.vertices;var aX=sprite.anchor.x;var aY=sprite.anchor.y;var w0,w1,h0,h1;if(sprite.texture.trim){var trim=sprite.texture.trim;w1=trim.x-aX*trim.width;w0=w1+texture.frame.width;h1=trim.y-aY*trim.height;h0=h1+texture.frame.height}else{w0=texture.frame.width*(1-aX);w1=texture.frame.width*-aX;h0=texture.frame.height*(1-aY);h1=texture.frame.height*-aY}var index=this.currentBatchSize*4*this.vertSize;var worldTransform=sprite.worldTransform;var a=worldTransform.a;var b=worldTransform.c;var c=worldTransform.b;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;verticies[index++]=a*w1+c*h1+tx;verticies[index++]=d*h1+b*w1+ty;verticies[index++]=uvs.x0;verticies[index++]=uvs.y0;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w0+c*h1+tx;verticies[index++]=d*h1+b*w0+ty;verticies[index++]=uvs.x1;verticies[index++]=uvs.y1;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w0+c*h0+tx;verticies[index++]=d*h0+b*w0+ty;verticies[index++]=uvs.x2;verticies[index++]=uvs.y2;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w1+c*h0+tx;verticies[index++]=d*h0+b*w1+ty;verticies[index++]=uvs.x3;verticies[index++]=uvs.y3;verticies[index++]=alpha;verticies[index++]=tint;this.currentBatchSize++};PIXI.WebGLSpriteBatch.prototype.renderTilingSprite=function(tilingSprite){var texture=tilingSprite.tilingTexture;if(texture.baseTexture!==this.currentBaseTexture||this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture}if(tilingSprite.blendMode!==this.currentBlendMode){this.setBlendMode(tilingSprite.blendMode)}if(!tilingSprite._uvs)tilingSprite._uvs=new PIXI.TextureUvs;var uvs=tilingSprite._uvs;tilingSprite.tilePosition.x%=texture.baseTexture.width*tilingSprite.tileScaleOffset.x;tilingSprite.tilePosition.y%=texture.baseTexture.height*tilingSprite.tileScaleOffset.y;var offsetX=tilingSprite.tilePosition.x/(texture.baseTexture.width*tilingSprite.tileScaleOffset.x);var offsetY=tilingSprite.tilePosition.y/(texture.baseTexture.height*tilingSprite.tileScaleOffset.y);var scaleX=tilingSprite.width/texture.baseTexture.width/(tilingSprite.tileScale.x*tilingSprite.tileScaleOffset.x);var scaleY=tilingSprite.height/texture.baseTexture.height/(tilingSprite.tileScale.y*tilingSprite.tileScaleOffset.y);uvs.x0=0-offsetX;uvs.y0=0-offsetY;uvs.x1=1*scaleX-offsetX;uvs.y1=0-offsetY;uvs.x2=1*scaleX-offsetX;uvs.y2=1*scaleY-offsetY;uvs.x3=0-offsetX;uvs.y3=1*scaleY-offsetY;var alpha=tilingSprite.worldAlpha;var tint=tilingSprite.tint;var verticies=this.vertices;var width=tilingSprite.width;var height=tilingSprite.height;var aX=tilingSprite.anchor.x;var aY=tilingSprite.anchor.y;var w0=width*(1-aX);var w1=width*-aX;var h0=height*(1-aY);var h1=height*-aY;var index=this.currentBatchSize*4*this.vertSize;var worldTransform=tilingSprite.worldTransform;var a=worldTransform.a;var b=worldTransform.c;var c=worldTransform.b;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;verticies[index++]=a*w1+c*h1+tx;verticies[index++]=d*h1+b*w1+ty;verticies[index++]=uvs.x0;verticies[index++]=uvs.y0;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w0+c*h1+tx;verticies[index++]=d*h1+b*w0+ty;verticies[index++]=uvs.x1;verticies[index++]=uvs.y1;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w0+c*h0+tx;verticies[index++]=d*h0+b*w0+ty;verticies[index++]=uvs.x2;verticies[index++]=uvs.y2;verticies[index++]=alpha;verticies[index++]=tint;verticies[index++]=a*w1+c*h0+tx;verticies[index++]=d*h0+b*w1+ty;verticies[index++]=uvs.x3;verticies[index++]=uvs.y3;verticies[index++]=alpha;verticies[index++]=tint;this.currentBatchSize++};PIXI.WebGLSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,this.currentBaseTexture._glTextures[gl.id]||PIXI.createWebGLTexture(this.currentBaseTexture,gl));if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.vertices.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}gl.drawElements(gl.TRIANGLES,this.currentBatchSize*6,gl.UNSIGNED_SHORT,0);this.currentBatchSize=0;this.renderSession.drawCount++};PIXI.WebGLSpriteBatch.prototype.stop=function(){this.flush()};PIXI.WebGLSpriteBatch.prototype.start=function(){var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var projection=this.renderSession.projection;gl.uniform2f(this.shader.projectionVector,projection.x,projection.y);var stride=this.vertSize*4;gl.vertexAttribPointer(this.shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(this.shader.aTextureCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(this.shader.colorAttribute,2,gl.FLOAT,false,stride,4*4);if(this.currentBlendMode!==PIXI.blendModes.NORMAL){this.setBlendMode(PIXI.blendModes.NORMAL)}};PIXI.WebGLSpriteBatch.prototype.setBlendMode=function(blendMode){this.flush();this.currentBlendMode=blendMode;var blendModeWebGL=PIXI.blendModesWebGL[this.currentBlendMode];this.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1])};PIXI.WebGLSpriteBatch.prototype.destroy=function(){this.vertices=null;this.indices=null;this.gl.deleteBuffer(this.vertexBuffer);this.gl.deleteBuffer(this.indexBuffer);this.currentBaseTexture=null;this.gl=null};PIXI.WebGLFastSpriteBatch=function(gl){this.vertSize=10;this.maxSize=6e3;this.size=this.maxSize;var numVerts=this.size*4*this.vertSize;var numIndices=this.maxSize*6;this.vertices=new Float32Array(numVerts);this.indices=new Uint16Array(numIndices);this.vertexBuffer=null;this.indexBuffer=null;this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3}this.drawing=false;this.currentBatchSize=0;this.currentBaseTexture=null;this.currentBlendMode=0;this.renderSession=null;this.shader=null;this.matrix=null;this.setContext(gl)};PIXI.WebGLFastSpriteBatch.prototype.setContext=function(gl){this.gl=gl;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);this.currentBlendMode=99999};PIXI.WebGLFastSpriteBatch.prototype.begin=function(spriteBatch,renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.fastShader;this.matrix=spriteBatch.worldTransform.toArray(true);this.start()};PIXI.WebGLFastSpriteBatch.prototype.end=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.render=function(spriteBatch){var children=spriteBatch.children;var sprite=children[0];if(!sprite.texture._uvs)return;this.currentBaseTexture=sprite.texture.baseTexture;if(sprite.blendMode!==this.currentBlendMode){this.setBlendMode(sprite.blendMode)}for(var i=0,j=children.length;i<j;i++){this.renderSprite(children[i])}this.flush()};PIXI.WebGLFastSpriteBatch.prototype.renderSprite=function(sprite){if(!sprite.visible)return;if(sprite.texture.baseTexture!==this.currentBaseTexture){this.flush();this.currentBaseTexture=sprite.texture.baseTexture;if(!sprite.texture._uvs)return}var uvs,verticies=this.vertices,width,height,w0,w1,h0,h1,index;uvs=sprite.texture._uvs;width=sprite.texture.frame.width;height=sprite.texture.frame.height;if(sprite.texture.trim){var trim=sprite.texture.trim;w1=trim.x-sprite.anchor.x*trim.width;w0=w1+sprite.texture.frame.width;h1=trim.y-sprite.anchor.y*trim.height;h0=h1+sprite.texture.frame.height}else{w0=sprite.texture.frame.width*(1-sprite.anchor.x);w1=sprite.texture.frame.width*-sprite.anchor.x;h0=sprite.texture.frame.height*(1-sprite.anchor.y);h1=sprite.texture.frame.height*-sprite.anchor.y}index=this.currentBatchSize*4*this.vertSize;verticies[index++]=w1;verticies[index++]=h1;verticies[index++]=sprite.position.x;verticies[index++]=sprite.position.y;verticies[index++]=sprite.scale.x;verticies[index++]=sprite.scale.y;verticies[index++]=sprite.rotation;verticies[index++]=uvs.x0;verticies[index++]=uvs.y1;verticies[index++]=sprite.alpha;verticies[index++]=w0;verticies[index++]=h1;verticies[index++]=sprite.position.x;verticies[index++]=sprite.position.y;verticies[index++]=sprite.scale.x;verticies[index++]=sprite.scale.y;verticies[index++]=sprite.rotation;verticies[index++]=uvs.x1;verticies[index++]=uvs.y1;verticies[index++]=sprite.alpha;verticies[index++]=w0;verticies[index++]=h0;verticies[index++]=sprite.position.x;verticies[index++]=sprite.position.y;verticies[index++]=sprite.scale.x;verticies[index++]=sprite.scale.y;verticies[index++]=sprite.rotation;verticies[index++]=uvs.x2;verticies[index++]=uvs.y2;verticies[index++]=sprite.alpha;verticies[index++]=w1;verticies[index++]=h0;verticies[index++]=sprite.position.x;verticies[index++]=sprite.position.y;verticies[index++]=sprite.scale.x;verticies[index++]=sprite.scale.y;verticies[index++]=sprite.rotation;verticies[index++]=uvs.x3;verticies[index++]=uvs.y3;verticies[index++]=sprite.alpha;this.currentBatchSize++;if(this.currentBatchSize>=this.size){this.flush()}};PIXI.WebGLFastSpriteBatch.prototype.flush=function(){if(this.currentBatchSize===0)return;var gl=this.gl;if(!this.currentBaseTexture._glTextures[gl.id])PIXI.createWebGLTexture(this.currentBaseTexture,gl);gl.bindTexture(gl.TEXTURE_2D,this.currentBaseTexture._glTextures[gl.id]);if(this.currentBatchSize>this.size*.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices)}else{var view=this.vertices.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view)}gl.drawElements(gl.TRIANGLES,this.currentBatchSize*6,gl.UNSIGNED_SHORT,0);this.currentBatchSize=0;this.renderSession.drawCount++};PIXI.WebGLFastSpriteBatch.prototype.stop=function(){this.flush()};PIXI.WebGLFastSpriteBatch.prototype.start=function(){var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var projection=this.renderSession.projection;gl.uniform2f(this.shader.projectionVector,projection.x,projection.y);gl.uniformMatrix3fv(this.shader.uMatrix,false,this.matrix);var stride=this.vertSize*4;gl.vertexAttribPointer(this.shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(this.shader.aPositionCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(this.shader.aScale,2,gl.FLOAT,false,stride,4*4);gl.vertexAttribPointer(this.shader.aRotation,1,gl.FLOAT,false,stride,6*4);gl.vertexAttribPointer(this.shader.aTextureCoord,2,gl.FLOAT,false,stride,7*4);gl.vertexAttribPointer(this.shader.colorAttribute,1,gl.FLOAT,false,stride,9*4);if(this.currentBlendMode!==PIXI.blendModes.NORMAL){this.setBlendMode(PIXI.blendModes.NORMAL)}};PIXI.WebGLFastSpriteBatch.prototype.setBlendMode=function(blendMode){this.flush();this.currentBlendMode=blendMode;var blendModeWebGL=PIXI.blendModesWebGL[this.currentBlendMode];this.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1])};PIXI.WebGLFilterManager=function(gl,transparent){this.transparent=transparent;this.filterStack=[];this.offsetX=0;this.offsetY=0;this.setContext(gl)};PIXI.WebGLFilterManager.prototype.setContext=function(gl){this.gl=gl;this.texturePool=[];this.initShaderBuffers()};PIXI.WebGLFilterManager.prototype.begin=function(renderSession,buffer){this.renderSession=renderSession;this.defaultShader=renderSession.shaderManager.defaultShader;var projection=this.renderSession.projection;this.width=projection.x*2;this.height=-projection.y*2;this.buffer=buffer};PIXI.WebGLFilterManager.prototype.pushFilter=function(filterBlock){var gl=this.gl;var projection=this.renderSession.projection;var offset=this.renderSession.offset;filterBlock._filterArea=filterBlock.target.filterArea||filterBlock.target.getBounds();this.filterStack.push(filterBlock);var filter=filterBlock.filterPasses[0];this.offsetX+=filterBlock._filterArea.x;this.offsetY+=filterBlock._filterArea.y;var texture=this.texturePool.pop();if(!texture){texture=new PIXI.FilterTexture(this.gl,this.width,this.height)}else{texture.resize(this.width,this.height)}gl.bindTexture(gl.TEXTURE_2D,texture.texture);var filterArea=filterBlock._filterArea;var padding=filter.padding;filterArea.x-=padding;filterArea.y-=padding;filterArea.width+=padding*2;filterArea.height+=padding*2;if(filterArea.x<0)filterArea.x=0;if(filterArea.width>this.width)filterArea.width=this.width;if(filterArea.y<0)filterArea.y=0;if(filterArea.height>this.height)filterArea.height=this.height;gl.bindFramebuffer(gl.FRAMEBUFFER,texture.frameBuffer);gl.viewport(0,0,filterArea.width,filterArea.height);projection.x=filterArea.width/2;projection.y=-filterArea.height/2;offset.x=-filterArea.x;offset.y=-filterArea.y;gl.uniform2f(this.defaultShader.projectionVector,filterArea.width/2,-filterArea.height/2);gl.uniform2f(this.defaultShader.offsetVector,-filterArea.x,-filterArea.y);gl.colorMask(true,true,true,true);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);filterBlock._glFilterTexture=texture};PIXI.WebGLFilterManager.prototype.popFilter=function(){var gl=this.gl;var filterBlock=this.filterStack.pop();var filterArea=filterBlock._filterArea;var texture=filterBlock._glFilterTexture;var projection=this.renderSession.projection;var offset=this.renderSession.offset;if(filterBlock.filterPasses.length>1){gl.viewport(0,0,filterArea.width,filterArea.height);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=0;this.vertexArray[1]=filterArea.height;this.vertexArray[2]=filterArea.width;this.vertexArray[3]=filterArea.height;this.vertexArray[4]=0;this.vertexArray[5]=0;this.vertexArray[6]=filterArea.width;this.vertexArray[7]=0;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);var inputTexture=texture;var outputTexture=this.texturePool.pop();if(!outputTexture)outputTexture=new PIXI.FilterTexture(this.gl,this.width,this.height);outputTexture.resize(this.width,this.height);
gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.BLEND);for(var i=0;i<filterBlock.filterPasses.length-1;i++){var filterPass=filterBlock.filterPasses[i];gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,inputTexture.texture);this.applyFilterPass(filterPass,filterArea,filterArea.width,filterArea.height);var temp=inputTexture;inputTexture=outputTexture;outputTexture=temp}gl.enable(gl.BLEND);texture=inputTexture;this.texturePool.push(outputTexture)}var filter=filterBlock.filterPasses[filterBlock.filterPasses.length-1];this.offsetX-=filterArea.x;this.offsetY-=filterArea.y;var sizeX=this.width;var sizeY=this.height;var offsetX=0;var offsetY=0;var buffer=this.buffer;if(this.filterStack.length===0){gl.colorMask(true,true,true,true)}else{var currentFilter=this.filterStack[this.filterStack.length-1];filterArea=currentFilter._filterArea;sizeX=filterArea.width;sizeY=filterArea.height;offsetX=filterArea.x;offsetY=filterArea.y;buffer=currentFilter._glFilterTexture.frameBuffer}projection.x=sizeX/2;projection.y=-sizeY/2;offset.x=offsetX;offset.y=offsetY;filterArea=filterBlock._filterArea;var x=filterArea.x-offsetX;var y=filterArea.y-offsetY;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=x;this.vertexArray[1]=y+filterArea.height;this.vertexArray[2]=x+filterArea.width;this.vertexArray[3]=y+filterArea.height;this.vertexArray[4]=x;this.vertexArray[5]=y;this.vertexArray[6]=x+filterArea.width;this.vertexArray[7]=y;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);gl.viewport(0,0,sizeX,sizeY);gl.bindFramebuffer(gl.FRAMEBUFFER,buffer);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.texture);this.applyFilterPass(filter,filterArea,sizeX,sizeY);gl.useProgram(this.defaultShader.program);gl.uniform2f(this.defaultShader.projectionVector,sizeX/2,-sizeY/2);gl.uniform2f(this.defaultShader.offsetVector,-offsetX,-offsetY);this.texturePool.push(texture);filterBlock._glFilterTexture=null};PIXI.WebGLFilterManager.prototype.applyFilterPass=function(filter,filterArea,width,height){var gl=this.gl;var shader=filter.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=filter.fragmentSrc;shader.uniforms=filter.uniforms;shader.init();filter.shaders[gl.id]=shader}gl.useProgram(shader.program);gl.uniform2f(shader.projectionVector,width/2,-height/2);gl.uniform2f(shader.offsetVector,0,0);if(filter.uniforms.dimensions){filter.uniforms.dimensions.value[0]=this.width;filter.uniforms.dimensions.value[1]=this.height;filter.uniforms.dimensions.value[2]=this.vertexArray[0];filter.uniforms.dimensions.value[3]=this.vertexArray[5]}shader.syncUniforms();gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.vertexAttribPointer(shader.colorAttribute,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);this.renderSession.drawCount++};PIXI.WebGLFilterManager.prototype.initShaderBuffers=function(){var gl=this.gl;this.vertexBuffer=gl.createBuffer();this.uvBuffer=gl.createBuffer();this.colorBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.vertexArray=new Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertexArray,gl.STATIC_DRAW);this.uvArray=new Float32Array([0,0,1,0,0,1,1,1]);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvArray,gl.STATIC_DRAW);this.colorArray=new Float32Array([1,16777215,1,16777215,1,16777215,1,16777215]);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colorArray,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,1,3,2]),gl.STATIC_DRAW)};PIXI.WebGLFilterManager.prototype.destroy=function(){var gl=this.gl;this.filterStack=null;this.offsetX=0;this.offsetY=0;for(var i=0;i<this.texturePool.length;i++){this.texturePool.destroy()}this.texturePool=null;gl.deleteBuffer(this.vertexBuffer);gl.deleteBuffer(this.uvBuffer);gl.deleteBuffer(this.colorBuffer);gl.deleteBuffer(this.indexBuffer)};PIXI.FilterTexture=function(gl,width,height,scaleMode){this.gl=gl;this.frameBuffer=gl.createFramebuffer();this.texture=gl.createTexture();scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);this.renderBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this.renderBuffer);this.resize(width,height)};PIXI.FilterTexture.prototype.clear=function(){var gl=this.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT)};PIXI.FilterTexture.prototype.resize=function(width,height){if(this.width===width&&this.height===height)return;this.width=width;this.height=height;var gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height)};PIXI.FilterTexture.prototype.destroy=function(){var gl=this.gl;gl.deleteFramebuffer(this.frameBuffer);gl.deleteTexture(this.texture);this.frameBuffer=null;this.texture=null};PIXI.CanvasMaskManager=function(){};PIXI.CanvasMaskManager.prototype.pushMask=function(maskData,context){context.save();var cacheAlpha=maskData.alpha;var transform=maskData.worldTransform;context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx,transform.ty);PIXI.CanvasGraphics.renderGraphicsMask(maskData,context);context.clip();maskData.worldAlpha=cacheAlpha};PIXI.CanvasMaskManager.prototype.popMask=function(context){context.restore()};PIXI.CanvasTinter=function(){};PIXI.CanvasTinter.getTintedTexture=function(sprite,color){var texture=sprite.texture;color=PIXI.CanvasTinter.roundColor(color);var stringColor="#"+("00000"+(color|0).toString(16)).substr(-6);texture.tintCache=texture.tintCache||{};if(texture.tintCache[stringColor])return texture.tintCache[stringColor];var canvas=PIXI.CanvasTinter.canvas||document.createElement("canvas");PIXI.CanvasTinter.tintMethod(texture,color,canvas);if(PIXI.CanvasTinter.convertTintToImage){var tintImage=new Image;tintImage.src=canvas.toDataURL();texture.tintCache[stringColor]=tintImage}else{texture.tintCache[stringColor]=canvas;PIXI.CanvasTinter.canvas=null}return canvas};PIXI.CanvasTinter.tintWithMultiply=function(texture,color,canvas){var context=canvas.getContext("2d");var frame=texture.frame;canvas.width=frame.width;canvas.height=frame.height;context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,frame.width,frame.height);context.globalCompositeOperation="multiply";context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,0,0,frame.width,frame.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,0,0,frame.width,frame.height)};PIXI.CanvasTinter.tintWithOverlay=function(texture,color,canvas){var context=canvas.getContext("2d");var frame=texture.frame;canvas.width=frame.width;canvas.height=frame.height;context.globalCompositeOperation="copy";context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,frame.width,frame.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,0,0,frame.width,frame.height)};PIXI.CanvasTinter.tintWithPerPixel=function(texture,color,canvas){var context=canvas.getContext("2d");var frame=texture.frame;canvas.width=frame.width;canvas.height=frame.height;context.globalCompositeOperation="copy";context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,0,0,frame.width,frame.height);var rgbValues=PIXI.hex2rgb(color);var r=rgbValues[0],g=rgbValues[1],b=rgbValues[2];var pixelData=context.getImageData(0,0,frame.width,frame.height);var pixels=pixelData.data;for(var i=0;i<pixels.length;i+=4){pixels[i+0]*=r;pixels[i+1]*=g;pixels[i+2]*=b}context.putImageData(pixelData,0,0)};PIXI.CanvasTinter.roundColor=function(color){var step=PIXI.CanvasTinter.cacheStepsPerColorChannel;var rgbValues=PIXI.hex2rgb(color);rgbValues[0]=Math.min(255,rgbValues[0]/step*step);rgbValues[1]=Math.min(255,rgbValues[1]/step*step);rgbValues[2]=Math.min(255,rgbValues[2]/step*step);return PIXI.rgb2hex(rgbValues)};PIXI.CanvasTinter.cacheStepsPerColorChannel=8;PIXI.CanvasTinter.convertTintToImage=false;PIXI.CanvasTinter.canUseMultiply=PIXI.canUseNewCanvasBlendModes();PIXI.CanvasTinter.tintMethod=PIXI.CanvasTinter.canUseMultiply?PIXI.CanvasTinter.tintWithMultiply:PIXI.CanvasTinter.tintWithPerPixel;PIXI.CanvasRenderer=function(width,height,view,transparent){PIXI.defaultRenderer=PIXI.defaultRenderer||this;this.type=PIXI.CANVAS_RENDERER;this.clearBeforeRender=true;this.roundPixels=false;this.transparent=!!transparent;if(!PIXI.blendModesCanvas){PIXI.blendModesCanvas=[];if(PIXI.canUseNewCanvasBlendModes()){PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="multiply";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="screen";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="overlay";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="darken";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="lighten";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="color-dodge";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="color-burn";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="hard-light";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="soft-light";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="difference";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="exclusion";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="hue";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="saturation";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="color";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="luminosity"}else{PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="source-over"}}this.width=width||800;this.height=height||600;this.view=view||document.createElement("canvas");this.context=this.view.getContext("2d",{alpha:this.transparent});this.refresh=true;this.view.width=this.width;this.view.height=this.height;this.count=0;this.maskManager=new PIXI.CanvasMaskManager;this.renderSession={context:this.context,maskManager:this.maskManager,scaleMode:null,smoothProperty:null};if("imageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="imageSmoothingEnabled";else if("webkitImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="webkitImageSmoothingEnabled";else if("mozImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="mozImageSmoothingEnabled";else if("oImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="oImageSmoothingEnabled"};PIXI.CanvasRenderer.prototype.constructor=PIXI.CanvasRenderer;PIXI.CanvasRenderer.prototype.render=function(stage){PIXI.texturesToUpdate.length=0;PIXI.texturesToDestroy.length=0;stage.updateTransform();this.context.setTransform(1,0,0,1,0,0);this.context.globalAlpha=1;if(!this.transparent&&this.clearBeforeRender){this.context.fillStyle=stage.backgroundColorString;this.context.fillRect(0,0,this.width,this.height)}else if(this.transparent&&this.clearBeforeRender){this.context.clearRect(0,0,this.width,this.height)}this.renderDisplayObject(stage);if(stage.interactive){if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this)}}if(PIXI.Texture.frameUpdates.length>0){PIXI.Texture.frameUpdates.length=0}};PIXI.CanvasRenderer.prototype.resize=function(width,height){this.width=width;this.height=height;this.view.width=width;this.view.height=height};PIXI.CanvasRenderer.prototype.renderDisplayObject=function(displayObject,context){this.renderSession.context=context||this.context;displayObject._renderCanvas(this.renderSession)};PIXI.CanvasRenderer.prototype.renderStripFlat=function(strip){var context=this.context;var verticies=strip.verticies;var length=verticies.length/2;this.count++;context.beginPath();for(var i=1;i<length-2;i++){var index=i*2;var x0=verticies[index],x1=verticies[index+2],x2=verticies[index+4];var y0=verticies[index+1],y1=verticies[index+3],y2=verticies[index+5];context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2)}context.fillStyle="#FF0000";context.fill();context.closePath()};PIXI.CanvasRenderer.prototype.renderStrip=function(strip){var context=this.context;var verticies=strip.verticies;var uvs=strip.uvs;var length=verticies.length/2;this.count++;for(var i=1;i<length-2;i++){var index=i*2;var x0=verticies[index],x1=verticies[index+2],x2=verticies[index+4];var y0=verticies[index+1],y1=verticies[index+3],y2=verticies[index+5];var u0=uvs[index]*strip.texture.width,u1=uvs[index+2]*strip.texture.width,u2=uvs[index+4]*strip.texture.width;var v0=uvs[index+1]*strip.texture.height,v1=uvs[index+3]*strip.texture.height,v2=uvs[index+5]*strip.texture.height;context.save();context.beginPath();context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2);context.closePath();context.clip();var delta=u0*v1+v0*u2+u1*v2-v1*u2-v0*u1-u0*v2;var deltaA=x0*v1+v0*x2+x1*v2-v1*x2-v0*x1-x0*v2;var deltaB=u0*x1+x0*u2+u1*x2-x1*u2-x0*u1-u0*x2;var deltaC=u0*v1*x2+v0*x1*u2+x0*u1*v2-x0*v1*u2-v0*u1*x2-u0*x1*v2;var deltaD=y0*v1+v0*y2+y1*v2-v1*y2-v0*y1-y0*v2;var deltaE=u0*y1+y0*u2+u1*y2-y1*u2-y0*u1-u0*y2;var deltaF=u0*v1*y2+v0*y1*u2+y0*u1*v2-y0*v1*u2-v0*u1*y2-u0*y1*v2;context.transform(deltaA/delta,deltaD/delta,deltaB/delta,deltaE/delta,deltaC/delta,deltaF/delta);context.drawImage(strip.texture.baseTexture.source,0,0);context.restore()}};PIXI.CanvasBuffer=function(width,height){this.width=width;this.height=height;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=width;this.canvas.height=height};PIXI.CanvasBuffer.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)};PIXI.CanvasBuffer.prototype.resize=function(width,height){this.width=this.canvas.width=width;this.height=this.canvas.height=height};PIXI.CanvasGraphics=function(){};PIXI.CanvasGraphics.renderGraphics=function(graphics,context){var worldAlpha=graphics.worldAlpha;var color="";for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var points=data.points;context.strokeStyle=color="#"+("00000"+(data.lineColor|0).toString(16)).substr(-6);context.lineWidth=data.lineWidth;if(data.type===PIXI.Graphics.POLY){context.beginPath();context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle=color="#"+("00000"+(data.fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.stroke()}}else if(data.type===PIXI.Graphics.RECT){if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle=color="#"+("00000"+(data.fillColor|0).toString(16)).substr(-6);context.fillRect(points[0],points[1],points[2],points[3])}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeRect(points[0],points[1],points[2],points[3])}}else if(data.type===PIXI.Graphics.CIRC){context.beginPath();context.arc(points[0],points[1],points[2],0,2*Math.PI);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle=color="#"+("00000"+(data.fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.stroke()}}else if(data.type===PIXI.Graphics.ELIP){var ellipseData=data.points;var w=ellipseData[2]*2;var h=ellipseData[3]*2;var x=ellipseData[0]-w/2;var y=ellipseData[1]-h/2;context.beginPath();var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle=color="#"+("00000"+(data.fillColor|0).toString(16)).substr(-6);context.fill()}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.stroke()}}}};PIXI.CanvasGraphics.renderGraphicsMask=function(graphics,context){var len=graphics.graphicsData.length;if(len===0)return;if(len>1){len=1;window.console.log("Pixi.js warning: masks in canvas can only mask using the first path in the graphics object")}for(var i=0;i<1;i++){var data=graphics.graphicsData[i];var points=data.points;if(data.type===PIXI.Graphics.POLY){context.beginPath();context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1])}if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath()}}else if(data.type===PIXI.Graphics.RECT){context.beginPath();context.rect(points[0],points[1],points[2],points[3]);context.closePath()}else if(data.type===PIXI.Graphics.CIRC){context.beginPath();context.arc(points[0],points[1],points[2],0,2*Math.PI);context.closePath()}else if(data.type===PIXI.Graphics.ELIP){var ellipseData=data.points;var w=ellipseData[2]*2;var h=ellipseData[3]*2;var x=ellipseData[0]-w/2;var y=ellipseData[1]-h/2;context.beginPath();var kappa=.5522848,ox=w/2*kappa,oy=h/2*kappa,xe=x+w,ye=y+h,xm=x+w/2,ym=y+h/2;context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath()}}};PIXI.Graphics=function(){PIXI.DisplayObjectContainer.call(this);this.renderable=true;this.fillAlpha=1;this.lineWidth=0;this.lineColor="black";this.graphicsData=[];this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL;this.currentPath={points:[]};this._webGL=[];this.isMask=false;this.bounds=null;this.boundsPadding=10};PIXI.Graphics.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Graphics.prototype.constructor=PIXI.Graphics;Object.defineProperty(PIXI.Graphics.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap},set:function(value){this._cacheAsBitmap=value;if(this._cacheAsBitmap){this._generateCachedSprite()}else{this.destroyCachedSprite();this.dirty=true}}});PIXI.Graphics.prototype.lineStyle=function(lineWidth,color,alpha){if(!this.currentPath.points.length)this.graphicsData.pop();this.lineWidth=lineWidth||0;this.lineColor=color||0;this.lineAlpha=arguments.length<3?1:alpha;this.currentPath={lineWidth:this.lineWidth,lineColor:this.lineColor,lineAlpha:this.lineAlpha,fillColor:this.fillColor,fillAlpha:this.fillAlpha,fill:this.filling,points:[],type:PIXI.Graphics.POLY};this.graphicsData.push(this.currentPath);return this};PIXI.Graphics.prototype.moveTo=function(x,y){if(!this.currentPath.points.length)this.graphicsData.pop();this.currentPath=this.currentPath={lineWidth:this.lineWidth,lineColor:this.lineColor,lineAlpha:this.lineAlpha,fillColor:this.fillColor,fillAlpha:this.fillAlpha,fill:this.filling,points:[],type:PIXI.Graphics.POLY};this.currentPath.points.push(x,y);this.graphicsData.push(this.currentPath);return this};PIXI.Graphics.prototype.lineTo=function(x,y){this.currentPath.points.push(x,y);this.dirty=true;return this};PIXI.Graphics.prototype.beginFill=function(color,alpha){this.filling=true;this.fillColor=color||0;this.fillAlpha=arguments.length<2?1:alpha;return this};PIXI.Graphics.prototype.endFill=function(){this.filling=false;this.fillColor=null;this.fillAlpha=1;return this};PIXI.Graphics.prototype.drawRect=function(x,y,width,height){if(!this.currentPath.points.length)this.graphicsData.pop();this.currentPath={lineWidth:this.lineWidth,lineColor:this.lineColor,lineAlpha:this.lineAlpha,fillColor:this.fillColor,fillAlpha:this.fillAlpha,fill:this.filling,points:[x,y,width,height],type:PIXI.Graphics.RECT};this.graphicsData.push(this.currentPath);this.dirty=true;return this};PIXI.Graphics.prototype.drawCircle=function(x,y,radius){if(!this.currentPath.points.length)this.graphicsData.pop();this.currentPath={lineWidth:this.lineWidth,lineColor:this.lineColor,lineAlpha:this.lineAlpha,fillColor:this.fillColor,fillAlpha:this.fillAlpha,fill:this.filling,points:[x,y,radius,radius],type:PIXI.Graphics.CIRC};this.graphicsData.push(this.currentPath);this.dirty=true;return this};PIXI.Graphics.prototype.drawEllipse=function(x,y,width,height){if(!this.currentPath.points.length)this.graphicsData.pop();this.currentPath={lineWidth:this.lineWidth,lineColor:this.lineColor,lineAlpha:this.lineAlpha,fillColor:this.fillColor,fillAlpha:this.fillAlpha,fill:this.filling,points:[x,y,width,height],type:PIXI.Graphics.ELIP};this.graphicsData.push(this.currentPath);this.dirty=true;return this};PIXI.Graphics.prototype.clear=function(){this.lineWidth=0;this.filling=false;this.dirty=true;this.clearDirty=true;this.graphicsData=[];this.bounds=null;return this};PIXI.Graphics.prototype.generateTexture=function(){var bounds=this.getBounds();var canvasBuffer=new PIXI.CanvasBuffer(bounds.width,bounds.height);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);canvasBuffer.context.translate(-bounds.x,-bounds.y);PIXI.CanvasGraphics.renderGraphics(this,canvasBuffer.context);return texture};PIXI.Graphics.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty){this._generateCachedSprite();PIXI.updateWebGLTexture(this._cachedSprite.texture.baseTexture,renderSession.gl);this.dirty=false}this._cachedSprite.alpha=this.alpha;PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession);return}else{renderSession.spriteBatch.stop();if(this._mask)renderSession.maskManager.pushMask(this.mask,renderSession);if(this._filters)renderSession.filterManager.pushFilter(this._filterBlock);if(this.blendMode!==renderSession.spriteBatch.currentBlendMode){renderSession.spriteBatch.currentBlendMode=this.blendMode;var blendModeWebGL=PIXI.blendModesWebGL[renderSession.spriteBatch.currentBlendMode];renderSession.spriteBatch.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1])}PIXI.WebGLGraphics.renderGraphics(this,renderSession);if(this.children.length){renderSession.spriteBatch.start();for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop()}if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(renderSession);renderSession.drawCount++;renderSession.spriteBatch.start()}};PIXI.Graphics.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0||this.isMask===true)return;var context=renderSession.context;var transform=this.worldTransform;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx,transform.ty);PIXI.CanvasGraphics.renderGraphics(this,context);for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession)}};PIXI.Graphics.prototype.getBounds=function(matrix){if(!this.bounds)this.updateBounds();var w0=this.bounds.x;var w1=this.bounds.width+this.bounds.x;var h0=this.bounds.y;var h1=this.bounds.height+this.bounds.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.c;var c=worldTransform.b;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=x1;var maxY=y1;var minX=x1;var minY=y1;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;return bounds};PIXI.Graphics.prototype.updateBounds=function(){var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;var points,x,y,w,h;for(var i=0;i<this.graphicsData.length;i++){var data=this.graphicsData[i];var type=data.type;var lineWidth=data.lineWidth;points=data.points;if(type===PIXI.Graphics.RECT){x=points[0]-lineWidth/2;y=points[1]-lineWidth/2;w=points[2]+lineWidth;h=points[3]+lineWidth;minX=x<minX?x:minX;maxX=x+w>maxX?x+w:maxX;minY=y<minY?x:minY;maxY=y+h>maxY?y+h:maxY}else if(type===PIXI.Graphics.CIRC||type===PIXI.Graphics.ELIP){x=points[0];y=points[1];w=points[2]+lineWidth/2;h=points[3]+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY}else{for(var j=0;j<points.length;j+=2){x=points[j];y=points[j+1];minX=x-lineWidth<minX?x-lineWidth:minX;maxX=x+lineWidth>maxX?x+lineWidth:maxX;minY=y-lineWidth<minY?y-lineWidth:minY;maxY=y+lineWidth>maxY?y+lineWidth:maxY}}}var padding=this.boundsPadding;this.bounds=new PIXI.Rectangle(minX-padding,minY-padding,maxX-minX+padding*2,maxY-minY+padding*2)};PIXI.Graphics.prototype._generateCachedSprite=function(){var bounds=this.getLocalBounds();if(!this._cachedSprite){var canvasBuffer=new PIXI.CanvasBuffer(bounds.width,bounds.height);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this._cachedSprite=new PIXI.Sprite(texture);this._cachedSprite.buffer=canvasBuffer;this._cachedSprite.worldTransform=this.worldTransform}else{this._cachedSprite.buffer.resize(bounds.width,bounds.height)}this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._cachedSprite.buffer.context.translate(-bounds.x,-bounds.y);PIXI.CanvasGraphics.renderGraphics(this,this._cachedSprite.buffer.context);this._cachedSprite.alpha=this.alpha};PIXI.Graphics.prototype.destroyCachedSprite=function(){this._cachedSprite.texture.destroy(true);this._cachedSprite=null};PIXI.Graphics.POLY=0;PIXI.Graphics.RECT=1;PIXI.Graphics.CIRC=2;PIXI.Graphics.ELIP=3;PIXI.Strip=function(texture,width,height){PIXI.Sprite.call(this,texture);this.width=width;this.height=height;this.texture=texture;this.blendMode=PIXI.blendModes.NORMAL;try{this.uvs=new Float32Array([0,1,1,1,1,0,0,1]);this.verticies=new Float32Array([0,0,0,0,0,0,0,0,0]);this.colors=new Float32Array([1,1,1,1]);this.indices=new Uint16Array([0,1,2,3])}catch(error){this.uvs=[0,1,1,1,1,0,0,1];this.verticies=[0,0,0,0,0,0,0,0,0];this.colors=[1,1,1,1];this.indices=[0,1,2,3]}if(texture.baseTexture.hasLoaded){this.width=this.texture.frame.width;this.height=this.texture.frame.height;this.updateFrame=true}else{this.onTextureUpdateBind=this.onTextureUpdate.bind(this);this.texture.addEventListener("update",this.onTextureUpdateBind)}this.renderable=true};PIXI.Strip.prototype=Object.create(PIXI.Sprite.prototype);PIXI.Strip.prototype.constructor=PIXI.Strip;PIXI.Strip.prototype.onTextureUpdate=function(){this.updateFrame=true};PIXI.Rope=function(texture,points){PIXI.Strip.call(this,texture);this.points=points;try{this.verticies=new Float32Array(points.length*4);this.uvs=new Float32Array(points.length*4);this.colors=new Float32Array(points.length*2);this.indices=new Uint16Array(points.length*2)}catch(error){this.verticies=new Array(points.length*4);this.uvs=new Array(points.length*4);this.colors=new Array(points.length*2);this.indices=new Array(points.length*2)}this.refresh()};PIXI.Rope.prototype=Object.create(PIXI.Strip.prototype);PIXI.Rope.prototype.constructor=PIXI.Rope;PIXI.Rope.prototype.refresh=function(){var points=this.points;if(points.length<1)return;var uvs=this.uvs;var lastPoint=points[0];var indices=this.indices;var colors=this.colors;this.count-=.2;uvs[0]=0;uvs[1]=1;uvs[2]=0;uvs[3]=1;colors[0]=1;colors[1]=1;indices[0]=0;indices[1]=1;var total=points.length,point,index,amount;for(var i=1;i<total;i++){point=points[i];index=i*4;amount=i/(total-1);if(i%2){uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}else{uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1}index=i*2;colors[index]=1;colors[index+1]=1;index=i*2;indices[index]=index;indices[index+1]=index+1;lastPoint=point}};PIXI.Rope.prototype.updateTransform=function(){var points=this.points;if(points.length<1)return;var lastPoint=points[0];var nextPoint;var perp={x:0,y:0};this.count-=.2;var verticies=this.verticies;verticies[0]=lastPoint.x+perp.x;verticies[1]=lastPoint.y+perp.y;verticies[2]=lastPoint.x-perp.x;verticies[3]=lastPoint.y-perp.y;var total=points.length,point,index,ratio,perpLength,num;for(var i=1;i<total;i++){point=points[i];index=i*4;if(i<points.length-1){nextPoint=points[i+1]}else{nextPoint=point}perp.y=-(nextPoint.x-lastPoint.x);perp.x=nextPoint.y-lastPoint.y;ratio=(1-i/(total-1))*10;if(ratio>1)ratio=1;perpLength=Math.sqrt(perp.x*perp.x+perp.y*perp.y);num=this.texture.height/2;perp.x/=perpLength;perp.y/=perpLength;perp.x*=num;perp.y*=num;verticies[index]=point.x+perp.x;verticies[index+1]=point.y+perp.y;verticies[index+2]=point.x-perp.x;verticies[index+3]=point.y-perp.y;lastPoint=point}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.Rope.prototype.setTexture=function(texture){this.texture=texture;this.updateFrame=true};PIXI.TilingSprite=function(texture,width,height){PIXI.Sprite.call(this,texture);this.width=width||100;this.height=height||100;this.tileScale=new PIXI.Point(1,1);this.tileScaleOffset=new PIXI.Point(1,1);
this.tilePosition=new PIXI.Point(0,0);this.renderable=true;this.tint=16777215;this.blendMode=PIXI.blendModes.NORMAL};PIXI.TilingSprite.prototype=Object.create(PIXI.Sprite.prototype);PIXI.TilingSprite.prototype.constructor=PIXI.TilingSprite;Object.defineProperty(PIXI.TilingSprite.prototype,"width",{get:function(){return this._width},set:function(value){this._width=value}});Object.defineProperty(PIXI.TilingSprite.prototype,"height",{get:function(){return this._height},set:function(value){this._height=value}});PIXI.TilingSprite.prototype.onTextureUpdate=function(){this.updateFrame=true};PIXI.TilingSprite.prototype.setTexture=function(texture){if(this.texture===texture)return;this.texture=texture;this.refreshTexture=true;this.cachedTint=16777215};PIXI.TilingSprite.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0)return;var i,j;if(this.mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start()}if(this.filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock)}if(!this.tilingTexture||this.refreshTexture){this.generateTilingTexture(true);if(this.tilingTexture&&this.tilingTexture.needsUpdate){PIXI.updateWebGLTexture(this.tilingTexture.baseTexture,renderSession.gl);this.tilingTexture.needsUpdate=false}}else renderSession.spriteBatch.renderTilingSprite(this);for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession)}renderSession.spriteBatch.stop();if(this.filters)renderSession.filterManager.popFilter();if(this.mask)renderSession.maskManager.popMask(renderSession);renderSession.spriteBatch.start()};PIXI.TilingSprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;var context=renderSession.context;if(this._mask){renderSession.maskManager.pushMask(this._mask,context)}context.globalAlpha=this.worldAlpha;var transform=this.worldTransform;context.setTransform(transform.a,transform.c,transform.b,transform.d,transform.tx,transform.ty);if(!this.__tilePattern||this.refreshTexture){this.generateTilingTexture(false);if(this.tilingTexture){this.__tilePattern=context.createPattern(this.tilingTexture.baseTexture.source,"repeat")}else{return}}if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode]}context.beginPath();var tilePosition=this.tilePosition;var tileScale=this.tileScale;tilePosition.x%=this.tilingTexture.baseTexture.width;tilePosition.y%=this.tilingTexture.baseTexture.height;context.scale(tileScale.x,tileScale.y);context.translate(tilePosition.x,tilePosition.y);context.fillStyle=this.__tilePattern;context.fillRect(-tilePosition.x+this.anchor.x*-this._width,-tilePosition.y+this.anchor.y*-this._height,this._width/tileScale.x,this._height/tileScale.y);context.scale(1/tileScale.x,1/tileScale.y);context.translate(-tilePosition.x,-tilePosition.y);context.closePath();if(this._mask){renderSession.maskManager.popMask(renderSession.context)}};PIXI.TilingSprite.prototype.getBounds=function(){var width=this._width;var height=this._height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=this.worldTransform;var a=worldTransform.a;var b=worldTransform.c;var c=worldTransform.b;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;this._currentBounds=bounds;return bounds};PIXI.TilingSprite.prototype.generateTilingTexture=function(forcePowerOfTwo){var texture=this.texture;if(!texture.baseTexture.hasLoaded)return;var baseTexture=texture.baseTexture;var frame=texture.frame;var targetWidth,targetHeight;var isFrame=frame.width!==baseTexture.width||frame.height!==baseTexture.height;var newTextureRequired=false;if(!forcePowerOfTwo){if(isFrame){targetWidth=frame.width;targetHeight=frame.height;newTextureRequired=true}}else{targetWidth=PIXI.getNextPowerOfTwo(frame.width);targetHeight=PIXI.getNextPowerOfTwo(frame.height);if(frame.width!==targetWidth&&frame.height!==targetHeight)newTextureRequired=true}if(newTextureRequired){var canvasBuffer;if(this.tilingTexture&&this.tilingTexture.isTiling){canvasBuffer=this.tilingTexture.canvasBuffer;canvasBuffer.resize(targetWidth,targetHeight);this.tilingTexture.baseTexture.width=targetWidth;this.tilingTexture.baseTexture.height=targetHeight;this.tilingTexture.needsUpdate=true}else{canvasBuffer=new PIXI.CanvasBuffer(targetWidth,targetHeight);this.tilingTexture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this.tilingTexture.canvasBuffer=canvasBuffer;this.tilingTexture.isTiling=true}canvasBuffer.context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,0,0,targetWidth,targetHeight);this.tileScaleOffset.x=frame.width/targetWidth;this.tileScaleOffset.y=frame.height/targetHeight}else{if(this.tilingTexture&&this.tilingTexture.isTiling){this.tilingTexture.destroy(true)}this.tileScaleOffset.x=1;this.tileScaleOffset.y=1;this.tilingTexture=texture}this.refreshTexture=false;this.tilingTexture.baseTexture._powerOf2=true};var spine={};spine.BoneData=function(name,parent){this.name=name;this.parent=parent};spine.BoneData.prototype={length:0,x:0,y:0,rotation:0,scaleX:1,scaleY:1};spine.SlotData=function(name,boneData){this.name=name;this.boneData=boneData};spine.SlotData.prototype={r:1,g:1,b:1,a:1,attachmentName:null};spine.Bone=function(boneData,parent){this.data=boneData;this.parent=parent;this.setToSetupPose()};spine.Bone.yDown=false;spine.Bone.prototype={x:0,y:0,rotation:0,scaleX:1,scaleY:1,m00:0,m01:0,worldX:0,m10:0,m11:0,worldY:0,worldRotation:0,worldScaleX:1,worldScaleY:1,updateWorldTransform:function(flipX,flipY){var parent=this.parent;if(parent!=null){this.worldX=this.x*parent.m00+this.y*parent.m01+parent.worldX;this.worldY=this.x*parent.m10+this.y*parent.m11+parent.worldY;this.worldScaleX=parent.worldScaleX*this.scaleX;this.worldScaleY=parent.worldScaleY*this.scaleY;this.worldRotation=parent.worldRotation+this.rotation}else{this.worldX=this.x;this.worldY=this.y;this.worldScaleX=this.scaleX;this.worldScaleY=this.scaleY;this.worldRotation=this.rotation}var radians=this.worldRotation*Math.PI/180;var cos=Math.cos(radians);var sin=Math.sin(radians);this.m00=cos*this.worldScaleX;this.m10=sin*this.worldScaleX;this.m01=-sin*this.worldScaleY;this.m11=cos*this.worldScaleY;if(flipX){this.m00=-this.m00;this.m01=-this.m01}if(flipY){this.m10=-this.m10;this.m11=-this.m11}if(spine.Bone.yDown){this.m10=-this.m10;this.m11=-this.m11}},setToSetupPose:function(){var data=this.data;this.x=data.x;this.y=data.y;this.rotation=data.rotation;this.scaleX=data.scaleX;this.scaleY=data.scaleY}};spine.Slot=function(slotData,skeleton,bone){this.data=slotData;this.skeleton=skeleton;this.bone=bone;this.setToSetupPose()};spine.Slot.prototype={r:1,g:1,b:1,a:1,_attachmentTime:0,attachment:null,setAttachment:function(attachment){this.attachment=attachment;this._attachmentTime=this.skeleton.time},setAttachmentTime:function(time){this._attachmentTime=this.skeleton.time-time},getAttachmentTime:function(){return this.skeleton.time-this._attachmentTime},setToSetupPose:function(){var data=this.data;this.r=data.r;this.g=data.g;this.b=data.b;this.a=data.a;var slotDatas=this.skeleton.data.slots;for(var i=0,n=slotDatas.length;i<n;i++){if(slotDatas[i]==data){this.setAttachment(!data.attachmentName?null:this.skeleton.getAttachmentBySlotIndex(i,data.attachmentName));break}}}};spine.Skin=function(name){this.name=name;this.attachments={}};spine.Skin.prototype={addAttachment:function(slotIndex,name,attachment){this.attachments[slotIndex+":"+name]=attachment},getAttachment:function(slotIndex,name){return this.attachments[slotIndex+":"+name]},_attachAll:function(skeleton,oldSkin){for(var key in oldSkin.attachments){var colon=key.indexOf(":");var slotIndex=parseInt(key.substring(0,colon),10);var name=key.substring(colon+1);var slot=skeleton.slots[slotIndex];if(slot.attachment&&slot.attachment.name==name){var attachment=this.getAttachment(slotIndex,name);if(attachment)slot.setAttachment(attachment)}}}};spine.Animation=function(name,timelines,duration){this.name=name;this.timelines=timelines;this.duration=duration};spine.Animation.prototype={apply:function(skeleton,time,loop){if(loop&&this.duration)time%=this.duration;var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,time,1)},mix:function(skeleton,time,loop,alpha){if(loop&&this.duration)time%=this.duration;var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,time,alpha)}};spine.binarySearch=function(values,target,step){var low=0;var high=Math.floor(values.length/step)-2;if(!high)return step;var current=high>>>1;while(true){if(values[(current+1)*step]<=target)low=current+1;else high=current;if(low==high)return(low+1)*step;current=low+high>>>1}};spine.linearSearch=function(values,target,step){for(var i=0,last=values.length-step;i<=last;i+=step)if(values[i]>target)return i;return-1};spine.Curves=function(frameCount){this.curves=[];this.curves.length=(frameCount-1)*6};spine.Curves.prototype={setLinear:function(frameIndex){this.curves[frameIndex*6]=0},setStepped:function(frameIndex){this.curves[frameIndex*6]=-1},setCurve:function(frameIndex,cx1,cy1,cx2,cy2){var subdiv_step=1/10;var subdiv_step2=subdiv_step*subdiv_step;var subdiv_step3=subdiv_step2*subdiv_step;var pre1=3*subdiv_step;var pre2=3*subdiv_step2;var pre4=6*subdiv_step2;var pre5=6*subdiv_step3;var tmp1x=-cx1*2+cx2;var tmp1y=-cy1*2+cy2;var tmp2x=(cx1-cx2)*3+1;var tmp2y=(cy1-cy2)*3+1;var i=frameIndex*6;var curves=this.curves;curves[i]=cx1*pre1+tmp1x*pre2+tmp2x*subdiv_step3;curves[i+1]=cy1*pre1+tmp1y*pre2+tmp2y*subdiv_step3;curves[i+2]=tmp1x*pre4+tmp2x*pre5;curves[i+3]=tmp1y*pre4+tmp2y*pre5;curves[i+4]=tmp2x*pre5;curves[i+5]=tmp2y*pre5},getCurvePercent:function(frameIndex,percent){percent=percent<0?0:percent>1?1:percent;var curveIndex=frameIndex*6;var curves=this.curves;var dfx=curves[curveIndex];if(!dfx)return percent;if(dfx==-1)return 0;var dfy=curves[curveIndex+1];var ddfx=curves[curveIndex+2];var ddfy=curves[curveIndex+3];var dddfx=curves[curveIndex+4];var dddfy=curves[curveIndex+5];var x=dfx,y=dfy;var i=10-2;while(true){if(x>=percent){var lastX=x-dfx;var lastY=y-dfy;return lastY+(y-lastY)*(percent-lastX)/(x-lastX)}if(!i)break;i--;dfx+=ddfx;dfy+=ddfy;ddfx+=dddfx;ddfy+=dddfy;x+=dfx;y+=dfy}return y+(1-y)*(percent-x)/(1-x)}};spine.RotateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*2};spine.RotateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2},setFrame:function(frameIndex,time,angle){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=angle},apply:function(skeleton,time,alpha){var frames=this.frames,amount;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-2]){amount=bone.data.rotation+frames[frames.length-1]-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha;return}var frameIndex=spine.binarySearch(frames,time,2);var lastFrameValue=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-2]-frameTime);percent=this.curves.getCurvePercent(frameIndex/2-1,percent);amount=frames[frameIndex+1]-lastFrameValue;while(amount>180)amount-=360;while(amount<-180)amount+=360;amount=bone.data.rotation+(lastFrameValue+amount*percent)-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha}};spine.TranslateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*3};spine.TranslateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y},apply:function(skeleton,time,alpha){var frames=this.frames;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){bone.x+=(bone.data.x+frames[frames.length-2]-bone.x)*alpha;bone.y+=(bone.data.y+frames[frames.length-1]-bone.y)*alpha;return}var frameIndex=spine.binarySearch(frames,time,3);var lastFrameX=frames[frameIndex-2];var lastFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.x+=(bone.data.x+lastFrameX+(frames[frameIndex+1]-lastFrameX)*percent-bone.x)*alpha;bone.y+=(bone.data.y+lastFrameY+(frames[frameIndex+2]-lastFrameY)*percent-bone.y)*alpha}};spine.ScaleTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*3};spine.ScaleTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y},apply:function(skeleton,time,alpha){var frames=this.frames;if(time<frames[0])return;var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){bone.scaleX+=(bone.data.scaleX-1+frames[frames.length-2]-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY-1+frames[frames.length-1]-bone.scaleY)*alpha;return}var frameIndex=spine.binarySearch(frames,time,3);var lastFrameX=frames[frameIndex-2];var lastFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.scaleX+=(bone.data.scaleX-1+lastFrameX+(frames[frameIndex+1]-lastFrameX)*percent-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY-1+lastFrameY+(frames[frameIndex+2]-lastFrameY)*percent-bone.scaleY)*alpha}};spine.ColorTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount*5};spine.ColorTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length/5},setFrame:function(frameIndex,time,r,g,b,a){frameIndex*=5;this.frames[frameIndex]=time;this.frames[frameIndex+1]=r;this.frames[frameIndex+2]=g;this.frames[frameIndex+3]=b;this.frames[frameIndex+4]=a},apply:function(skeleton,time,alpha){var frames=this.frames;if(time<frames[0])return;var slot=skeleton.slots[this.slotIndex];if(time>=frames[frames.length-5]){var i=frames.length-1;slot.r=frames[i-3];slot.g=frames[i-2];slot.b=frames[i-1];slot.a=frames[i];return}var frameIndex=spine.binarySearch(frames,time,5);var lastFrameR=frames[frameIndex-4];var lastFrameG=frames[frameIndex-3];var lastFrameB=frames[frameIndex-2];var lastFrameA=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-5]-frameTime);percent=this.curves.getCurvePercent(frameIndex/5-1,percent);var r=lastFrameR+(frames[frameIndex+1]-lastFrameR)*percent;var g=lastFrameG+(frames[frameIndex+2]-lastFrameG)*percent;var b=lastFrameB+(frames[frameIndex+3]-lastFrameB)*percent;var a=lastFrameA+(frames[frameIndex+4]-lastFrameA)*percent;if(alpha<1){slot.r+=(r-slot.r)*alpha;slot.g+=(g-slot.g)*alpha;slot.b+=(b-slot.b)*alpha;slot.a+=(a-slot.a)*alpha}else{slot.r=r;slot.g=g;slot.b=b;slot.a=a}}};spine.AttachmentTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount;this.attachmentNames=[];this.attachmentNames.length=frameCount};spine.AttachmentTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length},setFrame:function(frameIndex,time,attachmentName){this.frames[frameIndex]=time;this.attachmentNames[frameIndex]=attachmentName},apply:function(skeleton,time,alpha){var frames=this.frames;if(time<frames[0])return;var frameIndex;if(time>=frames[frames.length-1])frameIndex=frames.length-1;else frameIndex=spine.binarySearch(frames,time,1)-1;var attachmentName=this.attachmentNames[frameIndex];skeleton.slots[this.slotIndex].setAttachment(!attachmentName?null:skeleton.getAttachmentBySlotIndex(this.slotIndex,attachmentName))}};spine.SkeletonData=function(){this.bones=[];this.slots=[];this.skins=[];this.animations=[]};spine.SkeletonData.prototype={defaultSkin:null,findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return bones[i];return null},findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return i;return-1},findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){if(slots[i].name==slotName)return slot[i]}return null},findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].name==slotName)return i;return-1},findSkin:function(skinName){var skins=this.skins;for(var i=0,n=skins.length;i<n;i++)if(skins[i].name==skinName)return skins[i];return null},findAnimation:function(animationName){var animations=this.animations;for(var i=0,n=animations.length;i<n;i++)if(animations[i].name==animationName)return animations[i];return null}};spine.Skeleton=function(skeletonData){this.data=skeletonData;this.bones=[];for(var i=0,n=skeletonData.bones.length;i<n;i++){var boneData=skeletonData.bones[i];var parent=!boneData.parent?null:this.bones[skeletonData.bones.indexOf(boneData.parent)];this.bones.push(new spine.Bone(boneData,parent))}this.slots=[];this.drawOrder=[];for(i=0,n=skeletonData.slots.length;i<n;i++){var slotData=skeletonData.slots[i];var bone=this.bones[skeletonData.bones.indexOf(slotData.boneData)];var slot=new spine.Slot(slotData,this,bone);this.slots.push(slot);this.drawOrder.push(slot)}};spine.Skeleton.prototype={x:0,y:0,skin:null,r:1,g:1,b:1,a:1,time:0,flipX:false,flipY:false,updateWorldTransform:function(){var flipX=this.flipX;var flipY=this.flipY;var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)bones[i].updateWorldTransform(flipX,flipY)},setToSetupPose:function(){this.setBonesToSetupPose();this.setSlotsToSetupPose()},setBonesToSetupPose:function(){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)bones[i].setToSetupPose()},setSlotsToSetupPose:function(){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)slots[i].setToSetupPose(i)},getRootBone:function(){return this.bones.length?this.bones[0]:null},findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return bones[i];return null},findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return i;return-1},findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return slots[i];return null},findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return i;return-1},setSkinByName:function(skinName){var skin=this.data.findSkin(skinName);if(!skin)throw"Skin not found: "+skinName;this.setSkin(skin)},setSkin:function(newSkin){if(this.skin&&newSkin)newSkin._attachAll(this,this.skin);this.skin=newSkin},getAttachmentBySlotName:function(slotName,attachmentName){return this.getAttachmentBySlotIndex(this.data.findSlotIndex(slotName),attachmentName)},getAttachmentBySlotIndex:function(slotIndex,attachmentName){if(this.skin){var attachment=this.skin.getAttachment(slotIndex,attachmentName);if(attachment)return attachment}if(this.data.defaultSkin)return this.data.defaultSkin.getAttachment(slotIndex,attachmentName);return null},setAttachment:function(slotName,attachmentName){var slots=this.slots;for(var i=0,n=slots.size;i<n;i++){var slot=slots[i];if(slot.data.name==slotName){var attachment=null;if(attachmentName){attachment=this.getAttachment(i,attachmentName);if(attachment==null)throw"Attachment not found: "+attachmentName+", for slot: "+slotName}slot.setAttachment(attachment);return}}throw"Slot not found: "+slotName},update:function(delta){time+=delta}};spine.AttachmentType={region:0};spine.RegionAttachment=function(){this.offset=[];this.offset.length=8;this.uvs=[];this.uvs.length=8};spine.RegionAttachment.prototype={x:0,y:0,rotation:0,scaleX:1,scaleY:1,width:0,height:0,rendererObject:null,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,setUVs:function(u,v,u2,v2,rotate){var uvs=this.uvs;if(rotate){uvs[2]=u;uvs[3]=v2;uvs[4]=u;uvs[5]=v;uvs[6]=u2;uvs[7]=v;uvs[0]=u2;uvs[1]=v2}else{uvs[0]=u;uvs[1]=v2;uvs[2]=u;uvs[3]=v;uvs[4]=u2;uvs[5]=v;uvs[6]=u2;uvs[7]=v2}},updateOffset:function(){var regionScaleX=this.width/this.regionOriginalWidth*this.scaleX;var regionScaleY=this.height/this.regionOriginalHeight*this.scaleY;var localX=-this.width/2*this.scaleX+this.regionOffsetX*regionScaleX;var localY=-this.height/2*this.scaleY+this.regionOffsetY*regionScaleY;var localX2=localX+this.regionWidth*regionScaleX;var localY2=localY+this.regionHeight*regionScaleY;var radians=this.rotation*Math.PI/180;var cos=Math.cos(radians);var sin=Math.sin(radians);var localXCos=localX*cos+this.x;var localXSin=localX*sin;var localYCos=localY*cos+this.y;var localYSin=localY*sin;var localX2Cos=localX2*cos+this.x;var localX2Sin=localX2*sin;var localY2Cos=localY2*cos+this.y;var localY2Sin=localY2*sin;var offset=this.offset;offset[0]=localXCos-localYSin;offset[1]=localYCos+localXSin;offset[2]=localXCos-localY2Sin;offset[3]=localY2Cos+localXSin;offset[4]=localX2Cos-localY2Sin;offset[5]=localY2Cos+localX2Sin;offset[6]=localX2Cos-localYSin;offset[7]=localYCos+localX2Sin},computeVertices:function(x,y,bone,vertices){x+=bone.worldX;y+=bone.worldY;var m00=bone.m00;var m01=bone.m01;var m10=bone.m10;var m11=bone.m11;var offset=this.offset;vertices[0]=offset[0]*m00+offset[1]*m01+x;vertices[1]=offset[0]*m10+offset[1]*m11+y;vertices[2]=offset[2]*m00+offset[3]*m01+x;vertices[3]=offset[2]*m10+offset[3]*m11+y;vertices[4]=offset[4]*m00+offset[5]*m01+x;vertices[5]=offset[4]*m10+offset[5]*m11+y;vertices[6]=offset[6]*m00+offset[7]*m01+x;vertices[7]=offset[6]*m10+offset[7]*m11+y}};spine.AnimationStateData=function(skeletonData){this.skeletonData=skeletonData;this.animationToMixTime={}};spine.AnimationStateData.prototype={defaultMix:0,setMixByName:function(fromName,toName,duration){var from=this.skeletonData.findAnimation(fromName);if(!from)throw"Animation not found: "+fromName;var to=this.skeletonData.findAnimation(toName);if(!to)throw"Animation not found: "+toName;this.setMix(from,to,duration)},setMix:function(from,to,duration){this.animationToMixTime[from.name+":"+to.name]=duration},getMix:function(from,to){var time=this.animationToMixTime[from.name+":"+to.name];return time?time:this.defaultMix}};spine.AnimationState=function(stateData){this.data=stateData;this.queue=[]};spine.AnimationState.prototype={current:null,previous:null,currentTime:0,previousTime:0,currentLoop:false,previousLoop:false,mixTime:0,mixDuration:0,update:function(delta){this.currentTime+=delta;this.previousTime+=delta;this.mixTime+=delta;if(this.queue.length>0){var entry=this.queue[0];if(this.currentTime>=entry.delay){this._setAnimation(entry.animation,entry.loop);this.queue.shift()}}},apply:function(skeleton){if(!this.current)return;if(this.previous){this.previous.apply(skeleton,this.previousTime,this.previousLoop);var alpha=this.mixTime/this.mixDuration;if(alpha>=1){alpha=1;this.previous=null}this.current.mix(skeleton,this.currentTime,this.currentLoop,alpha)}else this.current.apply(skeleton,this.currentTime,this.currentLoop)},clearAnimation:function(){this.previous=null;this.current=null;this.queue.length=0},_setAnimation:function(animation,loop){this.previous=null;if(animation&&this.current){this.mixDuration=this.data.getMix(this.current,animation);if(this.mixDuration>0){this.mixTime=0;this.previous=this.current;this.previousTime=this.currentTime;this.previousLoop=this.currentLoop}}this.current=animation;this.currentLoop=loop;this.currentTime=0},setAnimationByName:function(animationName,loop){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;this.setAnimation(animation,loop)},setAnimation:function(animation,loop){this.queue.length=0;this._setAnimation(animation,loop)},addAnimationByName:function(animationName,loop,delay){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;this.addAnimation(animation,loop,delay)},addAnimation:function(animation,loop,delay){var entry={};entry.animation=animation;entry.loop=loop;if(!delay||delay<=0){var previousAnimation=this.queue.length?this.queue[this.queue.length-1].animation:this.current;if(previousAnimation!=null)delay=previousAnimation.duration-this.data.getMix(previousAnimation,animation)+(delay||0);else delay=0}entry.delay=delay;this.queue.push(entry)},isComplete:function(){return!this.current||this.currentTime>=this.current.duration}};spine.SkeletonJson=function(attachmentLoader){this.attachmentLoader=attachmentLoader};spine.SkeletonJson.prototype={scale:1,readSkeletonData:function(root){var skeletonData=new spine.SkeletonData,boneData;var bones=root["bones"];for(var i=0,n=bones.length;i<n;i++){var boneMap=bones[i];var parent=null;if(boneMap["parent"]){parent=skeletonData.findBone(boneMap["parent"]);if(!parent)throw"Parent bone not found: "+boneMap["parent"]}boneData=new spine.BoneData(boneMap["name"],parent);boneData.length=(boneMap["length"]||0)*this.scale;boneData.x=(boneMap["x"]||0)*this.scale;boneData.y=(boneMap["y"]||0)*this.scale;boneData.rotation=boneMap["rotation"]||0;boneData.scaleX=boneMap["scaleX"]||1;boneData.scaleY=boneMap["scaleY"]||1;skeletonData.bones.push(boneData)}var slots=root["slots"];for(i=0,n=slots.length;i<n;i++){var slotMap=slots[i];boneData=skeletonData.findBone(slotMap["bone"]);if(!boneData)throw"Slot bone not found: "+slotMap["bone"];var slotData=new spine.SlotData(slotMap["name"],boneData);var color=slotMap["color"];if(color){slotData.r=spine.SkeletonJson.toColor(color,0);slotData.g=spine.SkeletonJson.toColor(color,1);slotData.b=spine.SkeletonJson.toColor(color,2);slotData.a=spine.SkeletonJson.toColor(color,3)}slotData.attachmentName=slotMap["attachment"];skeletonData.slots.push(slotData)}var skins=root["skins"];for(var skinName in skins){if(!skins.hasOwnProperty(skinName))continue;var skinMap=skins[skinName];var skin=new spine.Skin(skinName);for(var slotName in skinMap){if(!skinMap.hasOwnProperty(slotName))continue;var slotIndex=skeletonData.findSlotIndex(slotName);var slotEntry=skinMap[slotName];for(var attachmentName in slotEntry){if(!slotEntry.hasOwnProperty(attachmentName))continue;var attachment=this.readAttachment(skin,attachmentName,slotEntry[attachmentName]);if(attachment!=null)skin.addAttachment(slotIndex,attachmentName,attachment)}}skeletonData.skins.push(skin);if(skin.name=="default")skeletonData.defaultSkin=skin}var animations=root["animations"];for(var animationName in animations){if(!animations.hasOwnProperty(animationName))continue;this.readAnimation(animationName,animations[animationName],skeletonData)}return skeletonData},readAttachment:function(skin,name,map){name=map["name"]||name;var type=spine.AttachmentType[map["type"]||"region"];if(type==spine.AttachmentType.region){var attachment=new spine.RegionAttachment;attachment.x=(map["x"]||0)*this.scale;attachment.y=(map["y"]||0)*this.scale;attachment.scaleX=map["scaleX"]||1;attachment.scaleY=map["scaleY"]||1;attachment.rotation=map["rotation"]||0;attachment.width=(map["width"]||32)*this.scale;attachment.height=(map["height"]||32)*this.scale;attachment.updateOffset();attachment.rendererObject={};attachment.rendererObject.name=name;attachment.rendererObject.scale={};attachment.rendererObject.scale.x=attachment.scaleX;attachment.rendererObject.scale.y=attachment.scaleY;attachment.rendererObject.rotation=-attachment.rotation*Math.PI/180;return attachment}throw"Unknown attachment type: "+type},readAnimation:function(name,map,skeletonData){var timelines=[];var duration=0;var frameIndex,timeline,timelineName,valueMap,values,i,n;var bones=map["bones"];for(var boneName in bones){if(!bones.hasOwnProperty(boneName))continue;var boneIndex=skeletonData.findBoneIndex(boneName);if(boneIndex==-1)throw"Bone not found: "+boneName;var boneMap=bones[boneName];for(timelineName in boneMap){if(!boneMap.hasOwnProperty(timelineName))continue;values=boneMap[timelineName];if(timelineName=="rotate"){timeline=new spine.RotateTimeline(values.length);timeline.boneIndex=boneIndex;frameIndex=0;for(i=0,n=values.length;i<n;i++){valueMap=values[i];timeline.setFrame(frameIndex,valueMap["time"],valueMap["angle"]);spine.SkeletonJson.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*2-2])}else if(timelineName=="translate"||timelineName=="scale"){var timelineScale=1;if(timelineName=="scale")timeline=new spine.ScaleTimeline(values.length);else{timeline=new spine.TranslateTimeline(values.length);timelineScale=this.scale}timeline.boneIndex=boneIndex;frameIndex=0;for(i=0,n=values.length;i<n;i++){valueMap=values[i];var x=(valueMap["x"]||0)*timelineScale;var y=(valueMap["y"]||0)*timelineScale;timeline.setFrame(frameIndex,valueMap["time"],x,y);spine.SkeletonJson.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*3-3])}else throw"Invalid timeline type for a bone: "+timelineName+" ("+boneName+")"}}var slots=map["slots"];for(var slotName in slots){if(!slots.hasOwnProperty(slotName))continue;var slotMap=slots[slotName];var slotIndex=skeletonData.findSlotIndex(slotName);for(timelineName in slotMap){if(!slotMap.hasOwnProperty(timelineName))continue;values=slotMap[timelineName];if(timelineName=="color"){timeline=new spine.ColorTimeline(values.length);timeline.slotIndex=slotIndex;frameIndex=0;for(i=0,n=values.length;i<n;i++){valueMap=values[i];var color=valueMap["color"];var r=spine.SkeletonJson.toColor(color,0);var g=spine.SkeletonJson.toColor(color,1);var b=spine.SkeletonJson.toColor(color,2);var a=spine.SkeletonJson.toColor(color,3);timeline.setFrame(frameIndex,valueMap["time"],r,g,b,a);spine.SkeletonJson.readCurve(timeline,frameIndex,valueMap);frameIndex++}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*5-5])}else if(timelineName=="attachment"){timeline=new spine.AttachmentTimeline(values.length);timeline.slotIndex=slotIndex;frameIndex=0;for(i=0,n=values.length;i<n;i++){valueMap=values[i];timeline.setFrame(frameIndex++,valueMap["time"],valueMap["name"])}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}else throw"Invalid timeline type for a slot: "+timelineName+" ("+slotName+")"}}skeletonData.animations.push(new spine.Animation(name,timelines,duration))}};spine.SkeletonJson.readCurve=function(timeline,frameIndex,valueMap){var curve=valueMap["curve"];if(!curve)return;if(curve=="stepped")timeline.curves.setStepped(frameIndex);else if(curve instanceof Array)timeline.curves.setCurve(frameIndex,curve[0],curve[1],curve[2],curve[3])};spine.SkeletonJson.toColor=function(hexString,colorIndex){if(hexString.length!=8)throw"Color hexidecimal length must be 8, recieved: "+hexString;
return parseInt(hexString.substr(colorIndex*2,2),16)/255};spine.Atlas=function(atlasText,textureLoader){this.textureLoader=textureLoader;this.pages=[];this.regions=[];var reader=new spine.AtlasReader(atlasText);var tuple=[];tuple.length=4;var page=null;while(true){var line=reader.readLine();if(line==null)break;line=reader.trim(line);if(!line.length)page=null;else if(!page){page=new spine.AtlasPage;page.name=line;page.format=spine.Atlas.Format[reader.readValue()];reader.readTuple(tuple);page.minFilter=spine.Atlas.TextureFilter[tuple[0]];page.magFilter=spine.Atlas.TextureFilter[tuple[1]];var direction=reader.readValue();page.uWrap=spine.Atlas.TextureWrap.clampToEdge;page.vWrap=spine.Atlas.TextureWrap.clampToEdge;if(direction=="x")page.uWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="y")page.vWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="xy")page.uWrap=page.vWrap=spine.Atlas.TextureWrap.repeat;textureLoader.load(page,line);this.pages.push(page)}else{var region=new spine.AtlasRegion;region.name=line;region.page=page;region.rotate=reader.readValue()=="true";reader.readTuple(tuple);var x=parseInt(tuple[0],10);var y=parseInt(tuple[1],10);reader.readTuple(tuple);var width=parseInt(tuple[0],10);var height=parseInt(tuple[1],10);region.u=x/page.width;region.v=y/page.height;if(region.rotate){region.u2=(x+height)/page.width;region.v2=(y+width)/page.height}else{region.u2=(x+width)/page.width;region.v2=(y+height)/page.height}region.x=x;region.y=y;region.width=Math.abs(width);region.height=Math.abs(height);if(reader.readTuple(tuple)==4){region.splits=[parseInt(tuple[0],10),parseInt(tuple[1],10),parseInt(tuple[2],10),parseInt(tuple[3],10)];if(reader.readTuple(tuple)==4){region.pads=[parseInt(tuple[0],10),parseInt(tuple[1],10),parseInt(tuple[2],10),parseInt(tuple[3],10)];reader.readTuple(tuple)}}region.originalWidth=parseInt(tuple[0],10);region.originalHeight=parseInt(tuple[1],10);reader.readTuple(tuple);region.offsetX=parseInt(tuple[0],10);region.offsetY=parseInt(tuple[1],10);region.index=parseInt(reader.readValue(),10);this.regions.push(region)}}};spine.Atlas.prototype={findRegion:function(name){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++)if(regions[i].name==name)return regions[i];return null},dispose:function(){var pages=this.pages;for(var i=0,n=pages.length;i<n;i++)this.textureLoader.unload(pages[i].rendererObject)},updateUVs:function(page){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++){var region=regions[i];if(region.page!=page)continue;region.u=region.x/page.width;region.v=region.y/page.height;if(region.rotate){region.u2=(region.x+region.height)/page.width;region.v2=(region.y+region.width)/page.height}else{region.u2=(region.x+region.width)/page.width;region.v2=(region.y+region.height)/page.height}}}};spine.Atlas.Format={alpha:0,intensity:1,luminanceAlpha:2,rgb565:3,rgba4444:4,rgb888:5,rgba8888:6};spine.Atlas.TextureFilter={nearest:0,linear:1,mipMap:2,mipMapNearestNearest:3,mipMapLinearNearest:4,mipMapNearestLinear:5,mipMapLinearLinear:6};spine.Atlas.TextureWrap={mirroredRepeat:0,clampToEdge:1,repeat:2};spine.AtlasPage=function(){};spine.AtlasPage.prototype={name:null,format:null,minFilter:null,magFilter:null,uWrap:null,vWrap:null,rendererObject:null,width:0,height:0};spine.AtlasRegion=function(){};spine.AtlasRegion.prototype={page:null,name:null,x:0,y:0,width:0,height:0,u:0,v:0,u2:0,v2:0,offsetX:0,offsetY:0,originalWidth:0,originalHeight:0,index:0,rotate:false,splits:null,pads:null};spine.AtlasReader=function(text){this.lines=text.split(/\r\n|\r|\n/)};spine.AtlasReader.prototype={index:0,trim:function(value){return value.replace(/^\s+|\s+$/g,"")},readLine:function(){if(this.index>=this.lines.length)return null;return this.lines[this.index++]},readValue:function(){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;return this.trim(line.substring(colon+1))},readTuple:function(tuple){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;var i=0,lastMatch=colon+1;for(;i<3;i++){var comma=line.indexOf(",",lastMatch);if(comma==-1){if(!i)throw"Invalid line: "+line;break}tuple[i]=this.trim(line.substr(lastMatch,comma-lastMatch));lastMatch=comma+1}tuple[i]=this.trim(line.substring(lastMatch));return i+1}};spine.AtlasAttachmentLoader=function(atlas){this.atlas=atlas};spine.AtlasAttachmentLoader.prototype={newAttachment:function(skin,type,name){switch(type){case spine.AttachmentType.region:var region=this.atlas.findRegion(name);if(!region)throw"Region not found in atlas: "+name+" ("+type+")";var attachment=new spine.RegionAttachment(name);attachment.rendererObject=region;attachment.setUVs(region.u,region.v,region.u2,region.v2,region.rotate);attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment}throw"Unknown attachment type: "+type}};spine.Bone.yDown=true;PIXI.AnimCache={};PIXI.Spine=function(url){PIXI.DisplayObjectContainer.call(this);this.spineData=PIXI.AnimCache[url];if(!this.spineData){throw new Error("Spine data must be preloaded using PIXI.SpineLoader or PIXI.AssetLoader: "+url)}this.skeleton=new spine.Skeleton(this.spineData);this.skeleton.updateWorldTransform();this.stateData=new spine.AnimationStateData(this.spineData);this.state=new spine.AnimationState(this.stateData);this.slotContainers=[];for(var i=0,n=this.skeleton.drawOrder.length;i<n;i++){var slot=this.skeleton.drawOrder[i];var attachment=slot.attachment;var slotContainer=new PIXI.DisplayObjectContainer;this.slotContainers.push(slotContainer);this.addChild(slotContainer);if(!(attachment instanceof spine.RegionAttachment)){continue}var spriteName=attachment.rendererObject.name;var sprite=this.createSprite(slot,attachment.rendererObject);slot.currentSprite=sprite;slot.currentSpriteName=spriteName;slotContainer.addChild(sprite)}};PIXI.Spine.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Spine.prototype.constructor=PIXI.Spine;PIXI.Spine.prototype.updateTransform=function(){this.lastTime=this.lastTime||Date.now();var timeDelta=(Date.now()-this.lastTime)*.001;this.lastTime=Date.now();this.state.update(timeDelta);this.state.apply(this.skeleton);this.skeleton.updateWorldTransform();var drawOrder=this.skeleton.drawOrder;for(var i=0,n=drawOrder.length;i<n;i++){var slot=drawOrder[i];var attachment=slot.attachment;var slotContainer=this.slotContainers[i];if(!(attachment instanceof spine.RegionAttachment)){slotContainer.visible=false;continue}if(attachment.rendererObject){if(!slot.currentSpriteName||slot.currentSpriteName!=attachment.name){var spriteName=attachment.rendererObject.name;if(slot.currentSprite!==undefined){slot.currentSprite.visible=false}slot.sprites=slot.sprites||{};if(slot.sprites[spriteName]!==undefined){slot.sprites[spriteName].visible=true}else{var sprite=this.createSprite(slot,attachment.rendererObject);slotContainer.addChild(sprite)}slot.currentSprite=slot.sprites[spriteName];slot.currentSpriteName=spriteName}}slotContainer.visible=true;var bone=slot.bone;slotContainer.position.x=bone.worldX+attachment.x*bone.m00+attachment.y*bone.m01;slotContainer.position.y=bone.worldY+attachment.x*bone.m10+attachment.y*bone.m11;slotContainer.scale.x=bone.worldScaleX;slotContainer.scale.y=bone.worldScaleY;slotContainer.rotation=-(slot.bone.worldRotation*Math.PI/180);slotContainer.alpha=slot.a;slot.currentSprite.tint=PIXI.rgb2hex([slot.r,slot.g,slot.b])}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this)};PIXI.Spine.prototype.createSprite=function(slot,descriptor){var name=PIXI.TextureCache[descriptor.name]?descriptor.name:descriptor.name+".png";var sprite=new PIXI.Sprite(PIXI.Texture.fromFrame(name));sprite.scale=descriptor.scale;sprite.rotation=descriptor.rotation;sprite.anchor.x=sprite.anchor.y=.5;slot.sprites=slot.sprites||{};slot.sprites[descriptor.name]=sprite;return sprite};PIXI.BaseTextureCache={};PIXI.texturesToUpdate=[];PIXI.texturesToDestroy=[];PIXI.BaseTextureCacheIdGenerator=0;PIXI.BaseTexture=function(source,scaleMode){PIXI.EventTarget.call(this);this.width=100;this.height=100;this.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.hasLoaded=false;this.source=source;this.id=PIXI.BaseTextureCacheIdGenerator++;this._glTextures=[];if(!source)return;if((this.source.complete||this.source.getContext)&&this.source.width&&this.source.height){this.hasLoaded=true;this.width=this.source.width;this.height=this.source.height;PIXI.texturesToUpdate.push(this)}else{var scope=this;this.source.onload=function(){scope.hasLoaded=true;scope.width=scope.source.width;scope.height=scope.source.height;PIXI.texturesToUpdate.push(scope);scope.dispatchEvent({type:"loaded",content:scope})}}this.imageUrl=null;this._powerOf2=false};PIXI.BaseTexture.prototype.constructor=PIXI.BaseTexture;PIXI.BaseTexture.prototype.destroy=function(){if(this.imageUrl){delete PIXI.BaseTextureCache[this.imageUrl];this.imageUrl=null;this.source.src=null}this.source=null;PIXI.texturesToDestroy.push(this)};PIXI.BaseTexture.prototype.updateSourceImage=function(newSrc){this.hasLoaded=false;this.source.src=null;this.source.src=newSrc};PIXI.BaseTexture.fromImage=function(imageUrl,crossorigin,scaleMode){var baseTexture=PIXI.BaseTextureCache[imageUrl];if(crossorigin===undefined&&imageUrl.indexOf("data:")===-1)crossorigin=true;if(!baseTexture){var image=new Image;if(crossorigin){image.crossOrigin=""}image.src=imageUrl;baseTexture=new PIXI.BaseTexture(image,scaleMode);baseTexture.imageUrl=imageUrl;PIXI.BaseTextureCache[imageUrl]=baseTexture}return baseTexture};PIXI.BaseTexture.fromCanvas=function(canvas,scaleMode){if(!canvas._pixiId){canvas._pixiId="canvas_"+PIXI.TextureCacheIdGenerator++}var baseTexture=PIXI.BaseTextureCache[canvas._pixiId];if(!baseTexture){baseTexture=new PIXI.BaseTexture(canvas,scaleMode);PIXI.BaseTextureCache[canvas._pixiId]=baseTexture}return baseTexture};PIXI.TextureCache={};PIXI.FrameCache={};PIXI.TextureCacheIdGenerator=0;PIXI.Texture=function(baseTexture,frame){PIXI.EventTarget.call(this);if(!frame){this.noFrame=true;frame=new PIXI.Rectangle(0,0,1,1)}if(baseTexture instanceof PIXI.Texture)baseTexture=baseTexture.baseTexture;this.baseTexture=baseTexture;this.frame=frame;this.trim=null;this.scope=this;this._uvs=null;if(baseTexture.hasLoaded){if(this.noFrame)frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(frame)}else{var scope=this;baseTexture.addEventListener("loaded",function(){scope.onBaseTextureLoaded()})}};PIXI.Texture.prototype.constructor=PIXI.Texture;PIXI.Texture.prototype.onBaseTextureLoaded=function(){var baseTexture=this.baseTexture;baseTexture.removeEventListener("loaded",this.onLoaded);if(this.noFrame)this.frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(this.frame);this.scope.dispatchEvent({type:"update",content:this})};PIXI.Texture.prototype.destroy=function(destroyBase){if(destroyBase)this.baseTexture.destroy()};PIXI.Texture.prototype.setFrame=function(frame){this.frame=frame;this.width=frame.width;this.height=frame.height;if(frame.x+frame.width>this.baseTexture.width||frame.y+frame.height>this.baseTexture.height){throw new Error("Texture Error: frame does not fit inside the base Texture dimensions "+this)}this.updateFrame=true;PIXI.Texture.frameUpdates.push(this)};PIXI.Texture.prototype._updateWebGLuvs=function(){if(!this._uvs)this._uvs=new PIXI.TextureUvs;var frame=this.frame;var tw=this.baseTexture.width;var th=this.baseTexture.height;this._uvs.x0=frame.x/tw;this._uvs.y0=frame.y/th;this._uvs.x1=(frame.x+frame.width)/tw;this._uvs.y1=frame.y/th;this._uvs.x2=(frame.x+frame.width)/tw;this._uvs.y2=(frame.y+frame.height)/th;this._uvs.x3=frame.x/tw;this._uvs.y3=(frame.y+frame.height)/th};PIXI.Texture.fromImage=function(imageUrl,crossorigin,scaleMode){var texture=PIXI.TextureCache[imageUrl];if(!texture){texture=new PIXI.Texture(PIXI.BaseTexture.fromImage(imageUrl,crossorigin,scaleMode));PIXI.TextureCache[imageUrl]=texture}return texture};PIXI.Texture.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache ');return texture};PIXI.Texture.fromCanvas=function(canvas,scaleMode){var baseTexture=PIXI.BaseTexture.fromCanvas(canvas,scaleMode);return new PIXI.Texture(baseTexture)};PIXI.Texture.addTextureToCache=function(texture,id){PIXI.TextureCache[id]=texture};PIXI.Texture.removeTextureFromCache=function(id){var texture=PIXI.TextureCache[id];delete PIXI.TextureCache[id];delete PIXI.BaseTextureCache[id];return texture};PIXI.Texture.frameUpdates=[];PIXI.TextureUvs=function(){this.x0=0;this.y0=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;this.x3=0;this.y4=0};PIXI.RenderTexture=function(width,height,renderer,scaleMode){PIXI.EventTarget.call(this);this.width=width||100;this.height=height||100;this.frame=new PIXI.Rectangle(0,0,this.width,this.height);this.baseTexture=new PIXI.BaseTexture;this.baseTexture.width=this.width;this.baseTexture.height=this.height;this.baseTexture._glTextures=[];this.baseTexture.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.baseTexture.hasLoaded=true;this.renderer=renderer||PIXI.defaultRenderer;if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;this.textureBuffer=new PIXI.FilterTexture(gl,this.width,this.height,this.baseTexture.scaleMode);this.baseTexture._glTextures[gl.id]=this.textureBuffer.texture;this.render=this.renderWebGL;this.projection=new PIXI.Point(this.width/2,-this.height/2)}else{this.render=this.renderCanvas;this.textureBuffer=new PIXI.CanvasBuffer(this.width,this.height);this.baseTexture.source=this.textureBuffer.canvas}PIXI.Texture.frameUpdates.push(this)};PIXI.RenderTexture.prototype=Object.create(PIXI.Texture.prototype);PIXI.RenderTexture.prototype.constructor=PIXI.RenderTexture;PIXI.RenderTexture.prototype.resize=function(width,height){this.width=width;this.height=height;this.frame.width=this.width;this.frame.height=this.height;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.projection.x=this.width/2;this.projection.y=-this.height/2;var gl=this.renderer.gl;gl.bindTexture(gl.TEXTURE_2D,this.baseTexture._glTextures[gl.id]);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)}else{this.textureBuffer.resize(this.width,this.height)}PIXI.Texture.frameUpdates.push(this)};PIXI.RenderTexture.prototype.renderWebGL=function(displayObject,position,clear){var gl=this.renderer.gl;gl.colorMask(true,true,true,true);gl.viewport(0,0,this.width,this.height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);if(clear)this.textureBuffer.clear();var children=displayObject.children;var originalWorldTransform=displayObject.worldTransform;displayObject.worldTransform=PIXI.RenderTexture.tempMatrix;displayObject.worldTransform.d=-1;displayObject.worldTransform.ty=this.projection.y*-2;if(position){displayObject.worldTransform.tx=position.x;displayObject.worldTransform.ty-=position.y}for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}PIXI.WebGLRenderer.updateTextures();this.renderer.renderDisplayObject(displayObject,this.projection,this.textureBuffer.frameBuffer);displayObject.worldTransform=originalWorldTransform};PIXI.RenderTexture.prototype.renderCanvas=function(displayObject,position,clear){var children=displayObject.children;var originalWorldTransform=displayObject.worldTransform;displayObject.worldTransform=PIXI.RenderTexture.tempMatrix;if(position){displayObject.worldTransform.tx=position.x;displayObject.worldTransform.ty=position.y}for(var i=0,j=children.length;i<j;i++){children[i].updateTransform()}if(clear)this.textureBuffer.clear();var context=this.textureBuffer.context;this.renderer.renderDisplayObject(displayObject,context);context.setTransform(1,0,0,1,0,0);displayObject.worldTransform=originalWorldTransform};PIXI.RenderTexture.tempMatrix=new PIXI.Matrix;PIXI.AssetLoader=function(assetURLs,crossorigin){PIXI.EventTarget.call(this);this.assetURLs=assetURLs;this.crossorigin=crossorigin;this.loadersByType={jpg:PIXI.ImageLoader,jpeg:PIXI.ImageLoader,png:PIXI.ImageLoader,gif:PIXI.ImageLoader,json:PIXI.JsonLoader,atlas:PIXI.AtlasLoader,anim:PIXI.SpineLoader,xml:PIXI.BitmapFontLoader,fnt:PIXI.BitmapFontLoader}};PIXI.AssetLoader.prototype.constructor=PIXI.AssetLoader;PIXI.AssetLoader.prototype._getDataType=function(str){var test="data:";var start=str.slice(0,test.length).toLowerCase();if(start===test){var data=str.slice(test.length);var sepIdx=data.indexOf(",");if(sepIdx===-1)return null;var info=data.slice(0,sepIdx).split(";")[0];if(!info||info.toLowerCase()==="text/plain")return"txt";return info.split("/").pop().toLowerCase()}return null};PIXI.AssetLoader.prototype.load=function(){var scope=this;function onLoad(evt){scope.onAssetLoaded(evt.content)}this.loadCount=this.assetURLs.length;for(var i=0;i<this.assetURLs.length;i++){var fileName=this.assetURLs[i];var fileType=this._getDataType(fileName);if(!fileType)fileType=fileName.split("?").shift().split(".").pop().toLowerCase();var Constructor=this.loadersByType[fileType];if(!Constructor)throw new Error(fileType+" is an unsupported file type");var loader=new Constructor(fileName,this.crossorigin);loader.addEventListener("loaded",onLoad);loader.load()}};PIXI.AssetLoader.prototype.onAssetLoaded=function(loader){this.loadCount--;this.dispatchEvent({type:"onProgress",content:this,loader:loader});if(this.onProgress)this.onProgress(loader);if(!this.loadCount){this.dispatchEvent({type:"onComplete",content:this});if(this.onComplete)this.onComplete()}};PIXI.JsonLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.loaded=false};PIXI.JsonLoader.prototype.constructor=PIXI.JsonLoader;PIXI.JsonLoader.prototype.load=function(){var scope=this;if(window.XDomainRequest){this.ajaxRequest=new window.XDomainRequest;this.ajaxRequest.timeout=3e3;this.ajaxRequest.onerror=function(){scope.onError()};this.ajaxRequest.ontimeout=function(){scope.onError()};this.ajaxRequest.onprogress=function(){}}else if(window.XMLHttpRequest){this.ajaxRequest=new window.XMLHttpRequest}else{this.ajaxRequest=new window.ActiveXObject("Microsoft.XMLHTTP")}this.ajaxRequest.onload=function(){scope.onJSONLoaded()};this.ajaxRequest.open("GET",this.url,true);this.ajaxRequest.send()};PIXI.JsonLoader.prototype.onJSONLoaded=function(){if(!this.ajaxRequest.responseText){this.onError();return}this.json=JSON.parse(this.ajaxRequest.responseText);if(this.json.frames){var scope=this;var textureUrl=this.baseUrl+this.json.meta.image;var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);var frameData=this.json.frames;this.texture=image.texture.baseTexture;image.addEventListener("loaded",function(){scope.onLoaded()});for(var i in frameData){var rect=frameData[i].frame;if(rect){PIXI.TextureCache[i]=new PIXI.Texture(this.texture,{x:rect.x,y:rect.y,width:rect.w,height:rect.h});if(frameData[i].trimmed){var texture=PIXI.TextureCache[i];var actualSize=frameData[i].sourceSize;var realSize=frameData[i].spriteSourceSize;texture.trim=new PIXI.Rectangle(realSize.x,realSize.y,actualSize.w,actualSize.h)}}}image.load()}else if(this.json.bones){var spineJsonParser=new spine.SkeletonJson;var skeletonData=spineJsonParser.readSkeletonData(this.json);PIXI.AnimCache[this.url]=skeletonData;this.onLoaded()}else{this.onLoaded()}};PIXI.JsonLoader.prototype.onLoaded=function(){this.loaded=true;this.dispatchEvent({type:"loaded",content:this})};PIXI.JsonLoader.prototype.onError=function(){this.dispatchEvent({type:"error",content:this})};PIXI.AtlasLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.url=url;this.baseUrl=url.replace(/[^\/]*$/,"");this.crossorigin=crossorigin;this.loaded=false};PIXI.AtlasLoader.constructor=PIXI.AtlasLoader;PIXI.AtlasLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest;this.ajaxRequest.onreadystatechange=this.onAtlasLoaded.bind(this);this.ajaxRequest.open("GET",this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType("application/json");this.ajaxRequest.send(null)};PIXI.AtlasLoader.prototype.onAtlasLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.href.indexOf("http")===-1){this.atlas={meta:{image:[]},frames:[]};var result=this.ajaxRequest.responseText.split(/\r?\n/);var lineCount=-3;var currentImageId=0;var currentFrame=null;var nameInNextLine=false;var i=0,j=0,selfOnLoaded=this.onLoaded.bind(this);for(i=0;i<result.length;i++){result[i]=result[i].replace(/^\s+|\s+$/g,"");if(result[i]===""){nameInNextLine=i+1}if(result[i].length>0){if(nameInNextLine===i){this.atlas.meta.image.push(result[i]);currentImageId=this.atlas.meta.image.length-1;this.atlas.frames.push({});lineCount=-3}else if(lineCount>0){if(lineCount%7===1){if(currentFrame!=null){this.atlas.frames[currentImageId][currentFrame.name]=currentFrame}currentFrame={name:result[i],frame:{}}}else{var text=result[i].split(" ");if(lineCount%7===3){currentFrame.frame.x=Number(text[1].replace(",",""));currentFrame.frame.y=Number(text[2])}else if(lineCount%7===4){currentFrame.frame.w=Number(text[1].replace(",",""));currentFrame.frame.h=Number(text[2])}else if(lineCount%7===5){var realSize={x:0,y:0,w:Number(text[1].replace(",","")),h:Number(text[2])};if(realSize.w>currentFrame.frame.w||realSize.h>currentFrame.frame.h){currentFrame.trimmed=true;currentFrame.realSize=realSize}else{currentFrame.trimmed=false}}}}lineCount++}}if(currentFrame!=null){this.atlas.frames[currentImageId][currentFrame.name]=currentFrame}if(this.atlas.meta.image.length>0){this.images=[];for(j=0;j<this.atlas.meta.image.length;j++){var textureUrl=this.baseUrl+this.atlas.meta.image[j];var frameData=this.atlas.frames[j];this.images.push(new PIXI.ImageLoader(textureUrl,this.crossorigin));for(i in frameData){var rect=frameData[i].frame;if(rect){PIXI.TextureCache[i]=new PIXI.Texture(this.images[j].texture.baseTexture,{x:rect.x,y:rect.y,width:rect.w,height:rect.h});if(frameData[i].trimmed){PIXI.TextureCache[i].realSize=frameData[i].realSize;PIXI.TextureCache[i].trim.x=0;PIXI.TextureCache[i].trim.y=0}}}}this.currentImageId=0;for(j=0;j<this.images.length;j++){this.images[j].addEventListener("loaded",selfOnLoaded)}this.images[this.currentImageId].load()}else{this.onLoaded()}}else{this.onError()}}};PIXI.AtlasLoader.prototype.onLoaded=function(){if(this.images.length-1>this.currentImageId){this.currentImageId++;this.images[this.currentImageId].load()}else{this.loaded=true;this.dispatchEvent({type:"loaded",content:this})}};PIXI.AtlasLoader.prototype.onError=function(){this.dispatchEvent({type:"error",content:this})};PIXI.SpriteSheetLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.texture=null;this.frames={}};PIXI.SpriteSheetLoader.prototype.constructor=PIXI.SpriteSheetLoader;PIXI.SpriteSheetLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.addEventListener("loaded",function(event){scope.json=event.content.json;scope.onLoaded()});jsonLoader.load()};PIXI.SpriteSheetLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})};PIXI.ImageLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.texture=PIXI.Texture.fromImage(url,crossorigin);this.frames=[]};PIXI.ImageLoader.prototype.constructor=PIXI.ImageLoader;PIXI.ImageLoader.prototype.load=function(){if(!this.texture.baseTexture.hasLoaded){var scope=this;this.texture.baseTexture.addEventListener("loaded",function(){scope.onLoaded()})}else{this.onLoaded()}};PIXI.ImageLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})};PIXI.ImageLoader.prototype.loadFramedSpriteSheet=function(frameWidth,frameHeight,textureName){this.frames=[];var cols=Math.floor(this.texture.width/frameWidth);var rows=Math.floor(this.texture.height/frameHeight);var i=0;for(var y=0;y<rows;y++){for(var x=0;x<cols;x++,i++){var texture=new PIXI.Texture(this.texture,{x:x*frameWidth,y:y*frameHeight,width:frameWidth,height:frameHeight});this.frames.push(texture);if(textureName)PIXI.TextureCache[textureName+"-"+i]=texture}}if(!this.texture.baseTexture.hasLoaded){var scope=this;this.texture.baseTexture.addEventListener("loaded",function(){scope.onLoaded()})}else{this.onLoaded()}};PIXI.BitmapFontLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.url=url;this.crossorigin=crossorigin;this.baseUrl=url.replace(/[^\/]*$/,"");this.texture=null};PIXI.BitmapFontLoader.prototype.constructor=PIXI.BitmapFontLoader;PIXI.BitmapFontLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest;var scope=this;this.ajaxRequest.onreadystatechange=function(){scope.onXMLLoaded()};this.ajaxRequest.open("GET",this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType("application/xml");this.ajaxRequest.send(null)};PIXI.BitmapFontLoader.prototype.onXMLLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.protocol.indexOf("http")===-1){var responseXML=this.ajaxRequest.responseXML;if(!responseXML||/MSIE 9/i.test(navigator.userAgent)||navigator.isCocoonJS){if(typeof window.DOMParser==="function"){var domparser=new DOMParser;responseXML=domparser.parseFromString(this.ajaxRequest.responseText,"text/xml")}else{var div=document.createElement("div");div.innerHTML=this.ajaxRequest.responseText;responseXML=div}}var textureUrl=this.baseUrl+responseXML.getElementsByTagName("page")[0].getAttribute("file");var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);this.texture=image.texture.baseTexture;var data={};var info=responseXML.getElementsByTagName("info")[0];var common=responseXML.getElementsByTagName("common")[0];data.font=info.getAttribute("face");data.size=parseInt(info.getAttribute("size"),10);data.lineHeight=parseInt(common.getAttribute("lineHeight"),10);data.chars={};var letters=responseXML.getElementsByTagName("char");for(var i=0;i<letters.length;i++){var charCode=parseInt(letters[i].getAttribute("id"),10);var textureRect=new PIXI.Rectangle(parseInt(letters[i].getAttribute("x"),10),parseInt(letters[i].getAttribute("y"),10),parseInt(letters[i].getAttribute("width"),10),parseInt(letters[i].getAttribute("height"),10));data.chars[charCode]={xOffset:parseInt(letters[i].getAttribute("xoffset"),10),yOffset:parseInt(letters[i].getAttribute("yoffset"),10),xAdvance:parseInt(letters[i].getAttribute("xadvance"),10),kerning:{},texture:PIXI.TextureCache[charCode]=new PIXI.Texture(this.texture,textureRect)}}var kernings=responseXML.getElementsByTagName("kerning");for(i=0;i<kernings.length;i++){var first=parseInt(kernings[i].getAttribute("first"),10);var second=parseInt(kernings[i].getAttribute("second"),10);var amount=parseInt(kernings[i].getAttribute("amount"),10);data.chars[second].kerning[first]=amount}PIXI.BitmapText.fonts[data.font]=data;var scope=this;image.addEventListener("loaded",function(){scope.onLoaded()});image.load()}}};PIXI.BitmapFontLoader.prototype.onLoaded=function(){this.dispatchEvent({type:"loaded",content:this})};PIXI.SpineLoader=function(url,crossorigin){PIXI.EventTarget.call(this);this.url=url;this.crossorigin=crossorigin;this.loaded=false};PIXI.SpineLoader.prototype.constructor=PIXI.SpineLoader;PIXI.SpineLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.addEventListener("loaded",function(event){scope.json=event.content.json;scope.onLoaded()});jsonLoader.load()};PIXI.SpineLoader.prototype.onLoaded=function(){this.loaded=true;this.dispatchEvent({type:"loaded",content:this})};PIXI.AbstractFilter=function(fragmentSrc,uniforms){this.passes=[this];this.shaders=[];this.dirty=true;this.padding=0;this.uniforms=uniforms||{};this.fragmentSrc=fragmentSrc||[]};PIXI.AlphaMaskFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;this.uniforms={mask:{type:"sampler2D",value:texture},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mask.value.x=texture.width;this.uniforms.mask.value.y=texture.height}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on("loaded",this.boundLoadedFunction)}this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D mask;","uniform sampler2D uSampler;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","void main(void) {","   vec2 mapCords = vTextureCoord.xy;","   mapCords += (dimensions.zw + offset)/ dimensions.xy ;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   mapCords *= dimensions.xy / mapDimensions;","   vec4 original =  texture2D(uSampler, vTextureCoord);","   float maskAlpha =  texture2D(mask, mapCords).r;","   original *= maskAlpha;","   gl_FragColor =  original;","}"]};PIXI.AlphaMaskFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.AlphaMaskFilter.prototype.constructor=PIXI.AlphaMaskFilter;PIXI.AlphaMaskFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.mask.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.mask.value.height;this.uniforms.mask.value.baseTexture.off("loaded",this.boundLoadedFunction)};Object.defineProperty(PIXI.AlphaMaskFilter.prototype,"map",{get:function(){return this.uniforms.mask.value},set:function(value){this.uniforms.mask.value=value}});PIXI.ColorMatrixFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={matrix:{type:"mat4",value:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float invert;","uniform mat4 matrix;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * matrix;","}"]};PIXI.ColorMatrixFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorMatrixFilter.prototype.constructor=PIXI.ColorMatrixFilter;Object.defineProperty(PIXI.ColorMatrixFilter.prototype,"matrix",{get:function(){return this.uniforms.matrix.value},set:function(value){this.uniforms.matrix.value=value}});PIXI.GrayFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={gray:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","uniform float gray;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.2126*gl_FragColor.r + 0.7152*gl_FragColor.g + 0.0722*gl_FragColor.b), gray);","}"]};PIXI.GrayFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.GrayFilter.prototype.constructor=PIXI.GrayFilter;Object.defineProperty(PIXI.GrayFilter.prototype,"gray",{get:function(){return this.uniforms.gray.value},set:function(value){this.uniforms.gray.value=value}});PIXI.DisplacementFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;this.uniforms={displacementMap:{type:"sampler2D",value:texture},scale:{type:"2f",value:{x:30,y:30}},offset:{type:"2f",value:{x:0,y:0}},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mapDimensions.value.x=texture.width;this.uniforms.mapDimensions.value.y=texture.height}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on("loaded",this.boundLoadedFunction)}this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D displacementMap;","uniform sampler2D uSampler;","uniform vec2 scale;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","void main(void) {","   vec2 mapCords = vTextureCoord.xy;","   mapCords += (dimensions.zw + offset)/ dimensions.xy ;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   vec2 matSample = texture2D(displacementMap, mapCords).xy;","   matSample -= 0.5;","   matSample *= scale;","   matSample /= mapDimensions;","   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + matSample.x, vTextureCoord.y + matSample.y));","   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb, 1.0);","   vec2 cord = vTextureCoord;","}"]
};PIXI.DisplacementFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DisplacementFilter.prototype.constructor=PIXI.DisplacementFilter;PIXI.DisplacementFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.displacementMap.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.displacementMap.value.height;this.uniforms.displacementMap.value.baseTexture.off("loaded",this.boundLoadedFunction)};Object.defineProperty(PIXI.DisplacementFilter.prototype,"map",{get:function(){return this.uniforms.displacementMap.value},set:function(value){this.uniforms.displacementMap.value=value}});Object.defineProperty(PIXI.DisplacementFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(value){this.uniforms.scale.value=value}});Object.defineProperty(PIXI.DisplacementFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(value){this.uniforms.offset.value=value}});PIXI.PixelateFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={invert:{type:"1f",value:0},dimensions:{type:"4fv",value:new Float32Array([1e4,100,10,10])},pixelSize:{type:"2f",value:{x:10,y:10}}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 testDim;","uniform vec4 dimensions;","uniform vec2 pixelSize;","uniform sampler2D uSampler;","void main(void) {","   vec2 coord = vTextureCoord;","   vec2 size = dimensions.xy/pixelSize;","   vec2 color = floor( ( vTextureCoord * size ) ) / size + pixelSize/dimensions.xy * 0.5;","   gl_FragColor = texture2D(uSampler, color);","}"]};PIXI.PixelateFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.PixelateFilter.prototype.constructor=PIXI.PixelateFilter;Object.defineProperty(PIXI.PixelateFilter.prototype,"size",{get:function(){return this.uniforms.pixelSize.value},set:function(value){this.dirty=true;this.uniforms.pixelSize.value=value}});PIXI.BlurXFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","   vec4 sum = vec4(0.0);","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 4.0*blur, vTextureCoord.y)) * 0.05;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 3.0*blur, vTextureCoord.y)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - 2.0*blur, vTextureCoord.y)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x - blur, vTextureCoord.y)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + blur, vTextureCoord.y)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 2.0*blur, vTextureCoord.y)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 3.0*blur, vTextureCoord.y)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x + 4.0*blur, vTextureCoord.y)) * 0.05;","   gl_FragColor = sum;","}"]};PIXI.BlurXFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurXFilter.prototype.constructor=PIXI.BlurXFilter;Object.defineProperty(PIXI.BlurXFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.dirty=true;this.uniforms.blur.value=1/7e3*value}});PIXI.BlurYFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","   vec4 sum = vec4(0.0);","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 4.0*blur)) * 0.05;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 3.0*blur)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 2.0*blur)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - blur)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + blur)) * 0.15;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 2.0*blur)) * 0.12;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 3.0*blur)) * 0.09;","   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 4.0*blur)) * 0.05;","   gl_FragColor = sum;","}"]};PIXI.BlurYFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurYFilter.prototype.constructor=PIXI.BlurYFilter;Object.defineProperty(PIXI.BlurYFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.uniforms.blur.value=1/7e3*value}});PIXI.BlurFilter=function(){this.blurXFilter=new PIXI.BlurXFilter;this.blurYFilter=new PIXI.BlurYFilter;this.passes=[this.blurXFilter,this.blurYFilter]};Object.defineProperty(PIXI.BlurFilter.prototype,"blur",{get:function(){return this.blurXFilter.blur},set:function(value){this.blurXFilter.blur=this.blurYFilter.blur=value}});Object.defineProperty(PIXI.BlurFilter.prototype,"blurX",{get:function(){return this.blurXFilter.blur},set:function(value){this.blurXFilter.blur=value}});Object.defineProperty(PIXI.BlurFilter.prototype,"blurY",{get:function(){return this.blurYFilter.blur},set:function(value){this.blurYFilter.blur=value}});PIXI.InvertFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={invert:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float invert;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix( (vec3(1)-gl_FragColor.rgb) * gl_FragColor.a, gl_FragColor.rgb, 1.0 - invert);","}"]};PIXI.InvertFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.InvertFilter.prototype.constructor=PIXI.InvertFilter;Object.defineProperty(PIXI.InvertFilter.prototype,"invert",{get:function(){return this.uniforms.invert.value},set:function(value){this.uniforms.invert.value=value}});PIXI.SepiaFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={sepia:{type:"1f",value:1}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float sepia;","uniform sampler2D uSampler;","const mat3 sepiaMatrix = mat3(0.3588, 0.7044, 0.1368, 0.2990, 0.5870, 0.1140, 0.2392, 0.4696, 0.0912);","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord);","   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * sepiaMatrix, sepia);","}"]};PIXI.SepiaFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.SepiaFilter.prototype.constructor=PIXI.SepiaFilter;Object.defineProperty(PIXI.SepiaFilter.prototype,"sepia",{get:function(){return this.uniforms.sepia.value},set:function(value){this.uniforms.sepia.value=value}});PIXI.TwistFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={radius:{type:"1f",value:.5},angle:{type:"1f",value:5},offset:{type:"2f",value:{x:.5,y:.5}}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec4 dimensions;","uniform sampler2D uSampler;","uniform float radius;","uniform float angle;","uniform vec2 offset;","void main(void) {","   vec2 coord = vTextureCoord - offset;","   float distance = length(coord);","   if (distance < radius) {","       float ratio = (radius - distance) / radius;","       float angleMod = ratio * ratio * angle;","       float s = sin(angleMod);","       float c = cos(angleMod);","       coord = vec2(coord.x * c - coord.y * s, coord.x * s + coord.y * c);","   }","   gl_FragColor = texture2D(uSampler, coord+offset);","}"]};PIXI.TwistFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.TwistFilter.prototype.constructor=PIXI.TwistFilter;Object.defineProperty(PIXI.TwistFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(value){this.dirty=true;this.uniforms.offset.value=value}});Object.defineProperty(PIXI.TwistFilter.prototype,"radius",{get:function(){return this.uniforms.radius.value},set:function(value){this.dirty=true;this.uniforms.radius.value=value}});Object.defineProperty(PIXI.TwistFilter.prototype,"angle",{get:function(){return this.uniforms.angle.value},set:function(value){this.dirty=true;this.uniforms.angle.value=value}});PIXI.ColorStepFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={step:{type:"1f",value:5}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","uniform float step;","void main(void) {","   vec4 color = texture2D(uSampler, vTextureCoord);","   color = floor(color * step) / step;","   gl_FragColor = color;","}"]};PIXI.ColorStepFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorStepFilter.prototype.constructor=PIXI.ColorStepFilter;Object.defineProperty(PIXI.ColorStepFilter.prototype,"step",{get:function(){return this.uniforms.step.value},set:function(value){this.uniforms.step.value=value}});PIXI.DotScreenFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={scale:{type:"1f",value:1},angle:{type:"1f",value:5},dimensions:{type:"4fv",value:[0,0,0,0]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec4 dimensions;","uniform sampler2D uSampler;","uniform float angle;","uniform float scale;","float pattern() {","   float s = sin(angle), c = cos(angle);","   vec2 tex = vTextureCoord * dimensions.xy;","   vec2 point = vec2(","       c * tex.x - s * tex.y,","       s * tex.x + c * tex.y","   ) * scale;","   return (sin(point.x) * sin(point.y)) * 4.0;","}","void main() {","   vec4 color = texture2D(uSampler, vTextureCoord);","   float average = (color.r + color.g + color.b) / 3.0;","   gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);","}"]};PIXI.DotScreenFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DotScreenFilter.prototype.constructor=PIXI.DotScreenFilter;Object.defineProperty(PIXI.DotScreenFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(value){this.dirty=true;this.uniforms.scale.value=value}});Object.defineProperty(PIXI.DotScreenFilter.prototype,"angle",{get:function(){return this.uniforms.angle.value},set:function(value){this.dirty=true;this.uniforms.angle.value=value}});PIXI.CrossHatchFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={blur:{type:"1f",value:1/512}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform float blur;","uniform sampler2D uSampler;","void main(void) {","    float lum = length(texture2D(uSampler, vTextureCoord.xy).rgb);","    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);","    if (lum < 1.00) {","        if (mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.75) {","        if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.50) {","        if (mod(gl_FragCoord.x + gl_FragCoord.y - 5.0, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","    if (lum < 0.3) {","        if (mod(gl_FragCoord.x - gl_FragCoord.y - 5.0, 10.0) == 0.0) {","            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","        }","    }","}"]};PIXI.CrossHatchFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.CrossHatchFilter.prototype.constructor=PIXI.BlurYFilter;Object.defineProperty(PIXI.CrossHatchFilter.prototype,"blur",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.uniforms.blur.value=1/7e3*value}});PIXI.RGBSplitFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];this.uniforms={red:{type:"2f",value:{x:20,y:20}},green:{type:"2f",value:{x:-20,y:20}},blue:{type:"2f",value:{x:20,y:-20}},dimensions:{type:"4fv",value:[0,0,0,0]}};this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 red;","uniform vec2 green;","uniform vec2 blue;","uniform vec4 dimensions;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor.r = texture2D(uSampler, vTextureCoord + red/dimensions.xy).r;","   gl_FragColor.g = texture2D(uSampler, vTextureCoord + green/dimensions.xy).g;","   gl_FragColor.b = texture2D(uSampler, vTextureCoord + blue/dimensions.xy).b;","   gl_FragColor.a = texture2D(uSampler, vTextureCoord).a;","}"]};PIXI.RGBSplitFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.RGBSplitFilter.prototype.constructor=PIXI.RGBSplitFilter;Object.defineProperty(PIXI.RGBSplitFilter.prototype,"angle",{get:function(){return this.uniforms.blur.value/(1/7e3)},set:function(value){this.uniforms.blur.value=1/7e3*value}});if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=PIXI}exports.PIXI=PIXI}else if(typeof define!=="undefined"&&define.amd){define(PIXI)}else{root.PIXI=PIXI}}).call(this);!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.p2=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}if(!GLMAT_ARRAY_TYPE){var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}var glMatrix={};glMatrix.setMatrixArrayType=function(type){GLMAT_ARRAY_TYPE=type};if(typeof exports!=="undefined"){exports.glMatrix=glMatrix}var vec2={};vec2.create=function(){var out=new GLMAT_ARRAY_TYPE(2);out[0]=0;out[1]=0;return out};vec2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new GLMAT_ARRAY_TYPE(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.sub=vec2.subtract;vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.mul=vec2.multiply;vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.div=vec2.divide;vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.dist=vec2.distance;vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.sqrDist=vec2.squaredDistance;vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.len=vec2.length;vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.sqrLen=vec2.squaredLength;vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out};vec2.transformMat2d=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out};vec2.transformMat3=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out};vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out};vec2.forEach=function(){var vec=vec2.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}},{}],2:[function(_dereq_,module,exports){var Scalar=_dereq_("./Scalar");module.exports=Line;function Line(){}Line.lineInt=function(l1,l2,precision){precision=precision||0;var i=[0,0];var a1,b1,c1,a2,b2,c2,det;a1=l1[1][1]-l1[0][1];b1=l1[0][0]-l1[1][0];c1=a1*l1[0][0]+b1*l1[0][1];a2=l2[1][1]-l2[0][1];b2=l2[0][0]-l2[1][0];c2=a2*l2[0][0]+b2*l2[0][1];det=a1*b2-a2*b1;if(!Scalar.eq(det,0,precision)){i[0]=(b2*c1-b1*c2)/det;i[1]=(a1*c2-a2*c1)/det}return i};Line.segmentsIntersect=function(p1,p2,q1,q2){var dx=p2[0]-p1[0];var dy=p2[1]-p1[1];var da=q2[0]-q1[0];var db=q2[1]-q1[1];if(da*dy-db*dx==0)return false;var s=(dx*(q1[1]-p1[1])+dy*(p1[0]-q1[0]))/(da*dy-db*dx);var t=(da*(p1[1]-q1[1])+db*(q1[0]-p1[0]))/(db*dx-da*dy);return s>=0&&s<=1&&t>=0&&t<=1}},{"./Scalar":5}],3:[function(_dereq_,module,exports){module.exports=Point;function Point(){}Point.area=function(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(c[0]-a[0])*(b[1]-a[1])};Point.left=function(a,b,c){return Point.area(a,b,c)>0};Point.leftOn=function(a,b,c){return Point.area(a,b,c)>=0};Point.right=function(a,b,c){return Point.area(a,b,c)<0};Point.rightOn=function(a,b,c){return Point.area(a,b,c)<=0};var tmpPoint1=[],tmpPoint2=[];Point.collinear=function(a,b,c,thresholdAngle){if(!thresholdAngle)return Point.area(a,b,c)==0;else{var ab=tmpPoint1,bc=tmpPoint2;ab[0]=b[0]-a[0];ab[1]=b[1]-a[1];bc[0]=c[0]-b[0];bc[1]=c[1]-b[1];var dot=ab[0]*bc[0]+ab[1]*bc[1],magA=Math.sqrt(ab[0]*ab[0]+ab[1]*ab[1]),magB=Math.sqrt(bc[0]*bc[0]+bc[1]*bc[1]),angle=Math.acos(dot/(magA*magB));return angle<thresholdAngle}};Point.sqdist=function(a,b){var dx=b[0]-a[0];var dy=b[1]-a[1];return dx*dx+dy*dy}},{}],4:[function(_dereq_,module,exports){var Line=_dereq_("./Line"),Point=_dereq_("./Point"),Scalar=_dereq_("./Scalar");module.exports=Polygon;function Polygon(){this.vertices=[]}Polygon.prototype.at=function(i){var v=this.vertices,s=v.length;return v[i<0?i%s+s:i%s]};Polygon.prototype.first=function(){return this.vertices[0]};Polygon.prototype.last=function(){return this.vertices[this.vertices.length-1]};Polygon.prototype.clear=function(){this.vertices.length=0};Polygon.prototype.append=function(poly,from,to){if(typeof from=="undefined")throw new Error("From is not given!");if(typeof to=="undefined")throw new Error("To is not given!");if(to-1<from)throw new Error("lol1");if(to>poly.vertices.length)throw new Error("lol2");if(from<0)throw new Error("lol3");for(var i=from;i<to;i++){this.vertices.push(poly.vertices[i])}};Polygon.prototype.makeCCW=function(){var br=0,v=this.vertices;for(var i=1;i<this.vertices.length;++i){if(v[i][1]<v[br][1]||v[i][1]==v[br][1]&&v[i][0]>v[br][0]){br=i}}if(!Point.left(this.at(br-1),this.at(br),this.at(br+1))){this.reverse()}};Polygon.prototype.reverse=function(){var tmp=[];for(var i=0,N=this.vertices.length;i!==N;i++){tmp.push(this.vertices.pop())}this.vertices=tmp};Polygon.prototype.isReflex=function(i){return Point.right(this.at(i-1),this.at(i),this.at(i+1))};var tmpLine1=[],tmpLine2=[];Polygon.prototype.canSee=function(a,b){var p,dist,l1=tmpLine1,l2=tmpLine2;if(Point.leftOn(this.at(a+1),this.at(a),this.at(b))&&Point.rightOn(this.at(a-1),this.at(a),this.at(b))){return false}dist=Point.sqdist(this.at(a),this.at(b));for(var i=0;i!==this.vertices.length;++i){if((i+1)%this.vertices.length===a||i===a)continue;if(Point.leftOn(this.at(a),this.at(b),this.at(i+1))&&Point.rightOn(this.at(a),this.at(b),this.at(i))){l1[0]=this.at(a);l1[1]=this.at(b);l2[0]=this.at(i);l2[1]=this.at(i+1);p=Line.lineInt(l1,l2);if(Point.sqdist(this.at(a),p)<dist){return false}}}return true};Polygon.prototype.copy=function(i,j,targetPoly){var p=targetPoly||new Polygon;p.clear();if(i<j){for(var k=i;k<=j;k++)p.vertices.push(this.vertices[k])}else{for(var k=0;k<=j;k++)p.vertices.push(this.vertices[k]);for(var k=i;k<this.vertices.length;k++)p.vertices.push(this.vertices[k])}return p};Polygon.prototype.getCutEdges=function(){var min=[],tmp1=[],tmp2=[],tmpPoly=new Polygon;var nDiags=Number.MAX_VALUE;for(var i=0;i<this.vertices.length;++i){if(this.isReflex(i)){for(var j=0;j<this.vertices.length;++j){if(this.canSee(i,j)){tmp1=this.copy(i,j,tmpPoly).getCutEdges();tmp2=this.copy(j,i,tmpPoly).getCutEdges();for(var k=0;k<tmp2.length;k++)tmp1.push(tmp2[k]);if(tmp1.length<nDiags){min=tmp1;nDiags=tmp1.length;min.push([this.at(i),this.at(j)])}}}}}return min};Polygon.prototype.decomp=function(){var edges=this.getCutEdges();if(edges.length>0)return this.slice(edges);else return[this]};Polygon.prototype.slice=function(cutEdges){if(cutEdges.length==0)return[this];if(cutEdges instanceof Array&&cutEdges.length&&cutEdges[0]instanceof Array&&cutEdges[0].length==2&&cutEdges[0][0]instanceof Array){var polys=[this];for(var i=0;i<cutEdges.length;i++){var cutEdge=cutEdges[i];for(var j=0;j<polys.length;j++){var poly=polys[j];var result=poly.slice(cutEdge);if(result){polys.splice(j,1);polys.push(result[0],result[1]);break}}}return polys}else{var cutEdge=cutEdges;var i=this.vertices.indexOf(cutEdge[0]);var j=this.vertices.indexOf(cutEdge[1]);if(i!=-1&&j!=-1){return[this.copy(i,j),this.copy(j,i)]}else{return false}}};Polygon.prototype.isSimple=function(){var path=this.vertices;for(var i=0;i<path.length-1;i++){for(var j=0;j<i-1;j++){if(Line.segmentsIntersect(path[i],path[i+1],path[j],path[j+1])){return false}}}for(var i=1;i<path.length-2;i++){if(Line.segmentsIntersect(path[0],path[path.length-1],path[i],path[i+1])){return false}}return true};function getIntersectionPoint(p1,p2,q1,q2,delta){delta=delta||0;var a1=p2[1]-p1[1];var b1=p1[0]-p2[0];var c1=a1*p1[0]+b1*p1[1];var a2=q2[1]-q1[1];var b2=q1[0]-q2[0];var c2=a2*q1[0]+b2*q1[1];var det=a1*b2-a2*b1;if(!Scalar.eq(det,0,delta))return[(b2*c1-b1*c2)/det,(a1*c2-a2*c1)/det];else return[0,0]}Polygon.prototype.quickDecomp=function(result,reflexVertices,steinerPoints,delta,maxlevel,level){maxlevel=maxlevel||100;level=level||0;delta=delta||25;result=typeof result!="undefined"?result:[];reflexVertices=reflexVertices||[];steinerPoints=steinerPoints||[];var upperInt=[0,0],lowerInt=[0,0],p=[0,0];var upperDist=0,lowerDist=0,d=0,closestDist=0;var upperIndex=0,lowerIndex=0,closestIndex=0;var lowerPoly=new Polygon,upperPoly=new Polygon;var poly=this,v=this.vertices;if(v.length<3)return result;level++;if(level>maxlevel){console.warn("quickDecomp: max level ("+maxlevel+") reached.");return result}for(var i=0;i<this.vertices.length;++i){if(poly.isReflex(i)){reflexVertices.push(poly.vertices[i]);upperDist=lowerDist=Number.MAX_VALUE;for(var j=0;j<this.vertices.length;++j){if(Point.left(poly.at(i-1),poly.at(i),poly.at(j))&&Point.rightOn(poly.at(i-1),poly.at(i),poly.at(j-1))){p=getIntersectionPoint(poly.at(i-1),poly.at(i),poly.at(j),poly.at(j-1));if(Point.right(poly.at(i+1),poly.at(i),p)){d=Point.sqdist(poly.vertices[i],p);if(d<lowerDist){lowerDist=d;lowerInt=p;lowerIndex=j}}}if(Point.left(poly.at(i+1),poly.at(i),poly.at(j+1))&&Point.rightOn(poly.at(i+1),poly.at(i),poly.at(j))){p=getIntersectionPoint(poly.at(i+1),poly.at(i),poly.at(j),poly.at(j+1));if(Point.left(poly.at(i-1),poly.at(i),p)){d=Point.sqdist(poly.vertices[i],p);if(d<upperDist){upperDist=d;upperInt=p;upperIndex=j}}}}if(lowerIndex==(upperIndex+1)%this.vertices.length){p[0]=(lowerInt[0]+upperInt[0])/2;p[1]=(lowerInt[1]+upperInt[1])/2;steinerPoints.push(p);if(i<upperIndex){lowerPoly.append(poly,i,upperIndex+1);lowerPoly.vertices.push(p);upperPoly.vertices.push(p);if(lowerIndex!=0){upperPoly.append(poly,lowerIndex,poly.vertices.length)}upperPoly.append(poly,0,i+1)}else{if(i!=0){lowerPoly.append(poly,i,poly.vertices.length)}lowerPoly.append(poly,0,upperIndex+1);lowerPoly.vertices.push(p);upperPoly.vertices.push(p);upperPoly.append(poly,lowerIndex,i+1)}}else{if(lowerIndex>upperIndex){upperIndex+=this.vertices.length}closestDist=Number.MAX_VALUE;if(upperIndex<lowerIndex){return result}for(var j=lowerIndex;j<=upperIndex;++j){if(Point.leftOn(poly.at(i-1),poly.at(i),poly.at(j))&&Point.rightOn(poly.at(i+1),poly.at(i),poly.at(j))){d=Point.sqdist(poly.at(i),poly.at(j));if(d<closestDist){closestDist=d;closestIndex=j%this.vertices.length}}}if(i<closestIndex){lowerPoly.append(poly,i,closestIndex+1);if(closestIndex!=0){upperPoly.append(poly,closestIndex,v.length)}upperPoly.append(poly,0,i+1)}else{if(i!=0){lowerPoly.append(poly,i,v.length)}lowerPoly.append(poly,0,closestIndex+1);upperPoly.append(poly,closestIndex,i+1)}}if(lowerPoly.vertices.length<upperPoly.vertices.length){lowerPoly.quickDecomp(result,reflexVertices,steinerPoints,delta,maxlevel,level);upperPoly.quickDecomp(result,reflexVertices,steinerPoints,delta,maxlevel,level)}else{upperPoly.quickDecomp(result,reflexVertices,steinerPoints,delta,maxlevel,level);lowerPoly.quickDecomp(result,reflexVertices,steinerPoints,delta,maxlevel,level)}return result}}result.push(this);return result};Polygon.prototype.removeCollinearPoints=function(precision){var num=0;for(var i=this.vertices.length-1;this.vertices.length>3&&i>=0;--i){if(Point.collinear(this.at(i-1),this.at(i),this.at(i+1),precision)){this.vertices.splice(i%this.vertices.length,1);i--;num++}}return num}},{"./Line":2,"./Point":3,"./Scalar":5}],5:[function(_dereq_,module,exports){module.exports=Scalar;function Scalar(){}Scalar.eq=function(a,b,precision){precision=precision||0;return Math.abs(a-b)<precision}},{}],6:[function(_dereq_,module,exports){module.exports={Polygon:_dereq_("./Polygon"),Point:_dereq_("./Point")}},{"./Point":3,"./Polygon":4}],7:[function(_dereq_,module,exports){module.exports={name:"p2",version:"0.5.0",description:"A JavaScript 2D physics engine.",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["p2.js","p2","physics","engine","2d"],main:"./src/p2.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/p2.js.git"},bugs:{url:"https://github.com/schteppe/p2.js/issues"},licenses:[{type:"MIT"}],devDependencies:{grunt:"~0.4.0","grunt-contrib-jshint":"~0.9.2","grunt-contrib-nodeunit":"~0.1.2","grunt-contrib-uglify":"~0.4.0","grunt-browserify":"~2.0.1","z-schema":"~2.4.6"},dependencies:{"poly-decomp":"git://github.com/schteppe/poly-decomp.js","gl-matrix":"2.1.0"}}},{}],8:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),Utils=_dereq_("../utils/Utils");module.exports=AABB;function AABB(options){this.lowerBound=vec2.create();if(options&&options.lowerBound){vec2.copy(this.lowerBound,options.lowerBound)}this.upperBound=vec2.create();if(options&&options.upperBound){vec2.copy(this.upperBound,options.upperBound)}}var tmp=vec2.create();AABB.prototype.setFromPoints=function(points,position,angle){var l=this.lowerBound,u=this.upperBound;vec2.set(l,Number.MAX_VALUE,Number.MAX_VALUE);vec2.set(u,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<points.length;i++){var p=points[i];if(typeof angle==="number"){vec2.rotate(tmp,p,angle);p=tmp}for(var j=0;j<2;j++){if(p[j]>u[j]){u[j]=p[j]}if(p[j]<l[j]){l[j]=p[j]}}}if(position){vec2.add(this.lowerBound,this.lowerBound,position);vec2.add(this.upperBound,this.upperBound,position)}};AABB.prototype.copy=function(aabb){vec2.copy(this.lowerBound,aabb.lowerBound);vec2.copy(this.upperBound,aabb.upperBound)};AABB.prototype.extend=function(aabb){for(var i=0;i<2;i++){if(aabb.lowerBound[i]<this.lowerBound[i]){this.lowerBound[i]=aabb.lowerBound[i]}if(aabb.upperBound[i]>this.upperBound[i]){this.upperBound[i]=aabb.upperBound[i]}}};AABB.prototype.overlaps=function(aabb){var l1=this.lowerBound,u1=this.upperBound,l2=aabb.lowerBound,u2=aabb.upperBound;return(l2[0]<=u1[0]&&u1[0]<=u2[0]||l1[0]<=u2[0]&&u2[0]<=u1[0])&&(l2[1]<=u1[1]&&u1[1]<=u2[1]||l1[1]<=u2[1]&&u2[1]<=u1[1])}},{"../math/vec2":30,"../utils/Utils":45}],9:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2");var Body=_dereq_("../objects/Body");module.exports=Broadphase;function Broadphase(type){this.type=type;this.result=[];this.world=null;this.boundingVolumeType=Broadphase.AABB}Broadphase.AABB=1;Broadphase.BOUNDING_CIRCLE=2;Broadphase.prototype.setWorld=function(world){this.world=world};Broadphase.prototype.getCollisionPairs=function(world){throw new Error("getCollisionPairs must be implemented in a subclass!")};var dist=vec2.create();Broadphase.boundingRadiusCheck=function(bodyA,bodyB){vec2.sub(dist,bodyA.position,bodyB.position);var d2=vec2.squaredLength(dist),r=bodyA.boundingRadius+bodyB.boundingRadius;return d2<=r*r};Broadphase.aabbCheck=function(bodyA,bodyB){if(bodyA.aabbNeedsUpdate){bodyA.updateAABB()}if(bodyB.aabbNeedsUpdate){bodyB.updateAABB()}return bodyA.aabb.overlaps(bodyB.aabb)};Broadphase.prototype.boundingVolumeCheck=function(bodyA,bodyB){var result;switch(this.boundingVolumeType){case Broadphase.BOUNDING_CIRCLE:result=Broadphase.boundingRadiusCheck(bodyA,bodyB);break;case Broadphase.AABB:result=Broadphase.aabbCheck(bodyA,bodyB);break;default:throw new Error("Bounding volume type not recognized: "+this.boundingVolumeType)}return result};Broadphase.canCollide=function(bodyA,bodyB){if(bodyA.motionState===Body.STATIC&&bodyB.motionState===Body.STATIC){return false}if(bodyA.motionState===Body.KINEMATIC&&bodyB.motionState===Body.STATIC||bodyA.motionState===Body.STATIC&&bodyB.motionState===Body.KINEMATIC){return false}if(bodyA.motionState===Body.KINEMATIC&&bodyB.motionState===Body.KINEMATIC){return false}if(bodyA.sleepState===Body.SLEEPING&&bodyB.sleepState===Body.SLEEPING){return false}if(bodyA.sleepState===Body.SLEEPING&&bodyB.motionState===Body.STATIC||bodyB.sleepState===Body.SLEEPING&&bodyA.motionState===Body.STATIC){return false}return true};Broadphase.NAIVE=1;Broadphase.SAP=2},{"../math/vec2":30,"../objects/Body":31}],10:[function(_dereq_,module,exports){var Circle=_dereq_("../shapes/Circle"),Plane=_dereq_("../shapes/Plane"),Particle=_dereq_("../shapes/Particle"),Broadphase=_dereq_("../collision/Broadphase"),vec2=_dereq_("../math/vec2"),Utils=_dereq_("../utils/Utils");module.exports=GridBroadphase;function GridBroadphase(options){options=options||{};Broadphase.apply(this);Utils.extend(options,{xmin:-100,xmax:100,ymin:-100,ymax:100,nx:10,ny:10});this.xmin=options.xmin;this.ymin=options.ymin;this.xmax=options.xmax;this.ymax=options.ymax;this.nx=options.nx;this.ny=options.ny;this.binsizeX=(this.xmax-this.xmin)/this.nx;this.binsizeY=(this.ymax-this.ymin)/this.ny}GridBroadphase.prototype=new Broadphase;GridBroadphase.prototype.getCollisionPairs=function(world){var result=[],bodies=world.bodies,Ncolliding=bodies.length,binsizeX=this.binsizeX,binsizeY=this.binsizeY,nx=this.nx,ny=this.ny,xmin=this.xmin,ymin=this.ymin,xmax=this.xmax,ymax=this.ymax;var bins=[],Nbins=nx*ny;for(var i=0;i<Nbins;i++){bins.push([])}var xmult=nx/(xmax-xmin);var ymult=ny/(ymax-ymin);for(var i=0;i!==Ncolliding;i++){var bi=bodies[i];var aabb=bi.aabb;var lowerX=Math.max(aabb.lowerBound[0],xmin);var lowerY=Math.max(aabb.lowerBound[1],ymin);var upperX=Math.min(aabb.upperBound[0],xmax);
var upperY=Math.min(aabb.upperBound[1],ymax);var xi1=Math.floor(xmult*(lowerX-xmin));var yi1=Math.floor(ymult*(lowerY-ymin));var xi2=Math.floor(xmult*(upperX-xmin));var yi2=Math.floor(ymult*(upperY-ymin));for(var j=xi1;j<=xi2;j++){for(var k=yi1;k<=yi2;k++){var xi=j;var yi=k;var idx=xi*(ny-1)+yi;if(idx>=0&&idx<Nbins){bins[idx].push(bi)}}}}for(var i=0;i!==Nbins;i++){var bin=bins[i];for(var j=0,NbodiesInBin=bin.length;j!==NbodiesInBin;j++){var bi=bin[j];for(var k=0;k!==j;k++){var bj=bin[k];if(Broadphase.canCollide(bi,bj)&&this.boundingVolumeCheck(bi,bj)){result.push(bi,bj)}}}}return result}},{"../collision/Broadphase":9,"../math/vec2":30,"../shapes/Circle":35,"../shapes/Particle":39,"../shapes/Plane":40,"../utils/Utils":45}],11:[function(_dereq_,module,exports){var Circle=_dereq_("../shapes/Circle"),Plane=_dereq_("../shapes/Plane"),Shape=_dereq_("../shapes/Shape"),Particle=_dereq_("../shapes/Particle"),Broadphase=_dereq_("../collision/Broadphase"),vec2=_dereq_("../math/vec2");module.exports=NaiveBroadphase;function NaiveBroadphase(){Broadphase.call(this,Broadphase.NAIVE)}NaiveBroadphase.prototype=new Broadphase;NaiveBroadphase.prototype.getCollisionPairs=function(world){var bodies=world.bodies,result=this.result;result.length=0;for(var i=0,Ncolliding=bodies.length;i!==Ncolliding;i++){var bi=bodies[i];for(var j=0;j<i;j++){var bj=bodies[j];if(Broadphase.canCollide(bi,bj)&&this.boundingVolumeCheck(bi,bj)){result.push(bi,bj)}}}return result}},{"../collision/Broadphase":9,"../math/vec2":30,"../shapes/Circle":35,"../shapes/Particle":39,"../shapes/Plane":40,"../shapes/Shape":42}],12:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),sub=vec2.sub,add=vec2.add,dot=vec2.dot,Utils=_dereq_("../utils/Utils"),ContactEquation=_dereq_("../equations/ContactEquation"),FrictionEquation=_dereq_("../equations/FrictionEquation"),Circle=_dereq_("../shapes/Circle"),Shape=_dereq_("../shapes/Shape"),Body=_dereq_("../objects/Body"),Rectangle=_dereq_("../shapes/Rectangle");module.exports=Narrowphase;var yAxis=vec2.fromValues(0,1);var tmp1=vec2.fromValues(0,0),tmp2=vec2.fromValues(0,0),tmp3=vec2.fromValues(0,0),tmp4=vec2.fromValues(0,0),tmp5=vec2.fromValues(0,0),tmp6=vec2.fromValues(0,0),tmp7=vec2.fromValues(0,0),tmp8=vec2.fromValues(0,0),tmp9=vec2.fromValues(0,0),tmp10=vec2.fromValues(0,0),tmp11=vec2.fromValues(0,0),tmp12=vec2.fromValues(0,0),tmp13=vec2.fromValues(0,0),tmp14=vec2.fromValues(0,0),tmp15=vec2.fromValues(0,0),tmp16=vec2.fromValues(0,0),tmp17=vec2.fromValues(0,0),tmp18=vec2.fromValues(0,0),tmpArray=[];function Narrowphase(){this.contactEquations=[];this.frictionEquations=[];this.enableFriction=true;this.slipForce=10;this.frictionCoefficient=.3;this.surfaceVelocity=0;this.reuseObjects=true;this.reusableContactEquations=[];this.reusableFrictionEquations=[];this.restitution=0;this.stiffness=1e7;this.relaxation=3;this.frictionStiffness=1e7;this.frictionRelaxation=3;this.collidingBodiesLastStep={keys:[]}}Narrowphase.prototype.collidedLastStep=function(bi,bj){var id1=bi.id,id2=bj.id;if(id1>id2){var tmp=id1;id1=id2;id2=tmp}return!!this.collidingBodiesLastStep[id1+" "+id2]};function clearObject(obj){for(var i=0,l=obj.keys.length;i<l;i++){delete obj[obj.keys[i]]}obj.keys.length=0}Narrowphase.prototype.reset=function(world){clearObject(this.collidingBodiesLastStep);for(var i=0;i!==this.contactEquations.length;i++){var eq=this.contactEquations[i],id1=eq.bodyA.id,id2=eq.bodyB.id;if(id1>id2){var tmp=id1;id1=id2;id2=tmp}var key=id1+" "+id2;if(!this.collidingBodiesLastStep[key]){this.collidingBodiesLastStep[key]=true;this.collidingBodiesLastStep.keys.push(key)}}if(this.reuseObjects){var ce=this.contactEquations,fe=this.frictionEquations,rfe=this.reusableFrictionEquations,rce=this.reusableContactEquations;Utils.appendArray(rce,ce);Utils.appendArray(rfe,fe)}this.contactEquations.length=this.frictionEquations.length=0};Narrowphase.prototype.createContactEquation=function(bodyA,bodyB,shapeA,shapeB){var c=this.reusableContactEquations.length?this.reusableContactEquations.pop():new ContactEquation(bodyA,bodyB);c.bodyA=bodyA;c.bodyB=bodyB;c.shapeA=shapeA;c.shapeB=shapeB;c.restitution=this.restitution;c.firstImpact=!this.collidedLastStep(bodyA,bodyB);c.stiffness=this.stiffness;c.relaxation=this.relaxation;c.needsUpdate=true;c.enabled=true;return c};Narrowphase.prototype.createFrictionEquation=function(bodyA,bodyB,shapeA,shapeB){var c=this.reusableFrictionEquations.length?this.reusableFrictionEquations.pop():new FrictionEquation(bodyA,bodyB);c.bodyA=bodyA;c.bodyB=bodyB;c.shapeA=shapeA;c.shapeB=shapeB;c.setSlipForce(this.slipForce);c.frictionCoefficient=this.frictionCoefficient;c.relativeVelocity=this.surfaceVelocity;c.enabled=true;c.needsUpdate=true;c.stiffness=this.frictionStiffness;c.relaxation=this.frictionRelaxation;return c};Narrowphase.prototype.createFrictionFromContact=function(c){var eq=this.createFrictionEquation(c.bodyA,c.bodyB,c.shapeA,c.shapeB);vec2.copy(eq.contactPointA,c.contactPointA);vec2.copy(eq.contactPointB,c.contactPointB);vec2.rotate(eq.t,c.normalA,-Math.PI/2);eq.contactEquation=c;return eq};Narrowphase.prototype[Shape.LINE|Shape.CONVEX]=Narrowphase.prototype.convexLine=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){if(justTest)return false;else return 0};Narrowphase.prototype[Shape.LINE|Shape.RECTANGLE]=Narrowphase.prototype.lineRectangle=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){if(justTest)return false;else return 0};function setConvexToCapsuleShapeMiddle(convexShape,capsuleShape){vec2.set(convexShape.vertices[0],-capsuleShape.length*.5,-capsuleShape.radius);vec2.set(convexShape.vertices[1],capsuleShape.length*.5,-capsuleShape.radius);vec2.set(convexShape.vertices[2],capsuleShape.length*.5,capsuleShape.radius);vec2.set(convexShape.vertices[3],-capsuleShape.length*.5,capsuleShape.radius)}var convexCapsule_tempRect=new Rectangle(1,1),convexCapsule_tempVec=vec2.create();Narrowphase.prototype[Shape.CAPSULE|Shape.CONVEX]=Narrowphase.prototype[Shape.CAPSULE|Shape.RECTANGLE]=Narrowphase.prototype.convexCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var circlePos=convexCapsule_tempVec;vec2.set(circlePos,sj.length/2,0);vec2.rotate(circlePos,circlePos,aj);vec2.add(circlePos,circlePos,xj);var result1=this.circleConvex(bj,sj,circlePos,aj,bi,si,xi,ai,justTest,sj.radius);vec2.set(circlePos,-sj.length/2,0);vec2.rotate(circlePos,circlePos,aj);vec2.add(circlePos,circlePos,xj);var result2=this.circleConvex(bj,sj,circlePos,aj,bi,si,xi,ai,justTest,sj.radius);if(justTest&&(result1||result2))return true;var r=convexCapsule_tempRect;setConvexToCapsuleShapeMiddle(r,sj);var result=this.convexConvex(bi,si,xi,ai,bj,r,xj,aj,justTest);return result+result1+result2};Narrowphase.prototype[Shape.CAPSULE|Shape.LINE]=Narrowphase.prototype.lineCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){if(justTest)return false;else return 0};var capsuleCapsule_tempVec1=vec2.create();var capsuleCapsule_tempVec2=vec2.create();var capsuleCapsule_tempRect1=new Rectangle(1,1);Narrowphase.prototype[Shape.CAPSULE|Shape.CAPSULE]=Narrowphase.prototype.capsuleCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var circlePosi=capsuleCapsule_tempVec1,circlePosj=capsuleCapsule_tempVec2;var numContacts=0;for(var i=0;i<2;i++){vec2.set(circlePosi,(i==0?-1:1)*si.length/2,0);vec2.rotate(circlePosi,circlePosi,ai);vec2.add(circlePosi,circlePosi,xi);for(var j=0;j<2;j++){vec2.set(circlePosj,(j==0?-1:1)*sj.length/2,0);vec2.rotate(circlePosj,circlePosj,aj);vec2.add(circlePosj,circlePosj,xj);var result=this.circleCircle(bi,si,circlePosi,ai,bj,sj,circlePosj,aj,justTest,si.radius,sj.radius);if(justTest&&result)return true;numContacts+=result}}var rect=capsuleCapsule_tempRect1;setConvexToCapsuleShapeMiddle(rect,si);var result1=this.convexCapsule(bi,rect,xi,ai,bj,sj,xj,aj,justTest);if(justTest&&result1)return true;numContacts+=result1;setConvexToCapsuleShapeMiddle(rect,sj);var result2=this.convexCapsule(bj,rect,xj,aj,bi,si,xi,ai,justTest);if(justTest&&result2)return true;numContacts+=result2;return numContacts};Narrowphase.prototype[Shape.LINE|Shape.LINE]=Narrowphase.prototype.lineLine=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){if(justTest)return false;else return 0};Narrowphase.prototype[Shape.PLANE|Shape.LINE]=Narrowphase.prototype.planeLine=function(planeBody,planeShape,planeOffset,planeAngle,lineBody,lineShape,lineOffset,lineAngle,justTest){var worldVertex0=tmp1,worldVertex1=tmp2,worldVertex01=tmp3,worldVertex11=tmp4,worldEdge=tmp5,worldEdgeUnit=tmp6,dist=tmp7,worldNormal=tmp8,worldTangent=tmp9,verts=tmpArray;numContacts=0;vec2.set(worldVertex0,-lineShape.length/2,0);vec2.set(worldVertex1,lineShape.length/2,0);vec2.rotate(worldVertex01,worldVertex0,lineAngle);vec2.rotate(worldVertex11,worldVertex1,lineAngle);add(worldVertex01,worldVertex01,lineOffset);add(worldVertex11,worldVertex11,lineOffset);vec2.copy(worldVertex0,worldVertex01);vec2.copy(worldVertex1,worldVertex11);sub(worldEdge,worldVertex1,worldVertex0);vec2.normalize(worldEdgeUnit,worldEdge);vec2.rotate(worldTangent,worldEdgeUnit,-Math.PI/2);vec2.rotate(worldNormal,yAxis,planeAngle);verts[0]=worldVertex0;verts[1]=worldVertex1;for(var i=0;i<verts.length;i++){var v=verts[i];sub(dist,v,planeOffset);var d=dot(dist,worldNormal);if(d<0){if(justTest)return true;var c=this.createContactEquation(planeBody,lineBody,planeShape,lineShape);numContacts++;vec2.copy(c.normalA,worldNormal);vec2.normalize(c.normalA,c.normalA);vec2.scale(dist,worldNormal,d);sub(c.contactPointA,v,dist);sub(c.contactPointA,c.contactPointA,planeBody.position);sub(c.contactPointB,v,lineOffset);add(c.contactPointB,c.contactPointB,lineOffset);sub(c.contactPointB,c.contactPointB,lineBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}}}return numContacts};Narrowphase.prototype[Shape.PARTICLE|Shape.CAPSULE]=Narrowphase.prototype.particleCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){return this.circleLine(bi,si,xi,ai,bj,sj,xj,aj,justTest,sj.radius,0)};Narrowphase.prototype[Shape.CIRCLE|Shape.LINE]=Narrowphase.prototype.circleLine=function(bi,si,xi,ai,bj,sj,xj,aj,justTest,lineRadius,circleRadius){var lineShape=sj,lineAngle=aj,lineBody=bj,lineOffset=xj,circleOffset=xi,circleBody=bi,circleShape=si,lineRadius=lineRadius||0,circleRadius=typeof circleRadius!="undefined"?circleRadius:circleShape.radius,orthoDist=tmp1,lineToCircleOrthoUnit=tmp2,projectedPoint=tmp3,centerDist=tmp4,worldTangent=tmp5,worldEdge=tmp6,worldEdgeUnit=tmp7,worldVertex0=tmp8,worldVertex1=tmp9,worldVertex01=tmp10,worldVertex11=tmp11,dist=tmp12,lineToCircle=tmp13,lineEndToLineRadius=tmp14,verts=tmpArray;vec2.set(worldVertex0,-lineShape.length/2,0);vec2.set(worldVertex1,lineShape.length/2,0);vec2.rotate(worldVertex01,worldVertex0,lineAngle);vec2.rotate(worldVertex11,worldVertex1,lineAngle);add(worldVertex01,worldVertex01,lineOffset);add(worldVertex11,worldVertex11,lineOffset);vec2.copy(worldVertex0,worldVertex01);vec2.copy(worldVertex1,worldVertex11);sub(worldEdge,worldVertex1,worldVertex0);vec2.normalize(worldEdgeUnit,worldEdge);vec2.rotate(worldTangent,worldEdgeUnit,-Math.PI/2);sub(dist,circleOffset,worldVertex0);var d=dot(dist,worldTangent);sub(centerDist,worldVertex0,lineOffset);sub(lineToCircle,circleOffset,lineOffset);if(Math.abs(d)<circleRadius+lineRadius){vec2.scale(orthoDist,worldTangent,d);sub(projectedPoint,circleOffset,orthoDist);vec2.scale(lineToCircleOrthoUnit,worldTangent,dot(worldTangent,lineToCircle));vec2.normalize(lineToCircleOrthoUnit,lineToCircleOrthoUnit);vec2.scale(lineToCircleOrthoUnit,lineToCircleOrthoUnit,lineRadius);add(projectedPoint,projectedPoint,lineToCircleOrthoUnit);var pos=dot(worldEdgeUnit,projectedPoint);var pos0=dot(worldEdgeUnit,worldVertex0);var pos1=dot(worldEdgeUnit,worldVertex1);if(pos>pos0&&pos<pos1){if(justTest)return true;var c=this.createContactEquation(circleBody,lineBody,si,sj);vec2.scale(c.normalA,orthoDist,-1);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,circleRadius);add(c.contactPointA,c.contactPointA,circleOffset);sub(c.contactPointA,c.contactPointA,circleBody.position);sub(c.contactPointB,projectedPoint,lineOffset);add(c.contactPointB,c.contactPointB,lineOffset);sub(c.contactPointB,c.contactPointB,lineBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1}}verts[0]=worldVertex0;verts[1]=worldVertex1;for(var i=0;i<verts.length;i++){var v=verts[i];sub(dist,v,circleOffset);if(vec2.squaredLength(dist)<(circleRadius+lineRadius)*(circleRadius+lineRadius)){if(justTest)return true;var c=this.createContactEquation(circleBody,lineBody,si,sj);vec2.copy(c.normalA,dist);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,circleRadius);add(c.contactPointA,c.contactPointA,circleOffset);sub(c.contactPointA,c.contactPointA,circleBody.position);sub(c.contactPointB,v,lineOffset);vec2.scale(lineEndToLineRadius,c.normalA,-lineRadius);add(c.contactPointB,c.contactPointB,lineEndToLineRadius);add(c.contactPointB,c.contactPointB,lineOffset);sub(c.contactPointB,c.contactPointB,lineBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1}}return 0};Narrowphase.prototype[Shape.CIRCLE|Shape.CAPSULE]=Narrowphase.prototype.circleCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){return this.circleLine(bi,si,xi,ai,bj,sj,xj,aj,justTest,sj.radius)};Narrowphase.prototype[Shape.CIRCLE|Shape.CONVEX]=Narrowphase.prototype[Shape.CIRCLE|Shape.RECTANGLE]=Narrowphase.prototype.circleConvex=function(bi,si,xi,ai,bj,sj,xj,aj,justTest,circleRadius){var convexShape=sj,convexAngle=aj,convexBody=bj,convexOffset=xj,circleOffset=xi,circleBody=bi,circleShape=si,circleRadius=typeof circleRadius=="number"?circleRadius:circleShape.radius;var worldVertex0=tmp1,worldVertex1=tmp2,worldEdge=tmp3,worldEdgeUnit=tmp4,worldTangent=tmp5,centerDist=tmp6,convexToCircle=tmp7,orthoDist=tmp8,projectedPoint=tmp9,dist=tmp10,worldVertex=tmp11,closestEdge=-1,closestEdgeDistance=null,closestEdgeOrthoDist=tmp12,closestEdgeProjectedPoint=tmp13,candidate=tmp14,candidateDist=tmp15,minCandidate=tmp16,found=false,minCandidateDistance=Number.MAX_VALUE;var numReported=0;verts=convexShape.vertices;for(var i=0;i!==verts.length+1;i++){var v0=verts[i%verts.length],v1=verts[(i+1)%verts.length];vec2.rotate(worldVertex0,v0,convexAngle);vec2.rotate(worldVertex1,v1,convexAngle);add(worldVertex0,worldVertex0,convexOffset);add(worldVertex1,worldVertex1,convexOffset);sub(worldEdge,worldVertex1,worldVertex0);vec2.normalize(worldEdgeUnit,worldEdge);vec2.rotate(worldTangent,worldEdgeUnit,-Math.PI/2);vec2.scale(candidate,worldTangent,-circleShape.radius);add(candidate,candidate,circleOffset);if(pointInConvex(candidate,convexShape,convexOffset,convexAngle)){vec2.sub(candidateDist,worldVertex0,candidate);var candidateDistance=Math.abs(vec2.dot(candidateDist,worldTangent));if(candidateDistance<minCandidateDistance){vec2.copy(minCandidate,candidate);minCandidateDistance=candidateDistance;vec2.scale(closestEdgeProjectedPoint,worldTangent,candidateDistance);vec2.add(closestEdgeProjectedPoint,closestEdgeProjectedPoint,candidate);found=true}}}if(found){if(justTest)return true;var c=this.createContactEquation(circleBody,convexBody,si,sj);vec2.sub(c.normalA,minCandidate,circleOffset);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,circleRadius);add(c.contactPointA,c.contactPointA,circleOffset);sub(c.contactPointA,c.contactPointA,circleBody.position);sub(c.contactPointB,closestEdgeProjectedPoint,convexOffset);add(c.contactPointB,c.contactPointB,convexOffset);sub(c.contactPointB,c.contactPointB,convexBody.position);this.contactEquations.push(c);if(this.enableFriction)this.frictionEquations.push(this.createFrictionFromContact(c));return 1}if(circleRadius>0){for(var i=0;i<verts.length;i++){var localVertex=verts[i];vec2.rotate(worldVertex,localVertex,convexAngle);add(worldVertex,worldVertex,convexOffset);sub(dist,worldVertex,circleOffset);if(vec2.squaredLength(dist)<circleRadius*circleRadius){if(justTest)return true;var c=this.createContactEquation(circleBody,convexBody,si,sj);vec2.copy(c.normalA,dist);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,circleRadius);add(c.contactPointA,c.contactPointA,circleOffset);sub(c.contactPointA,c.contactPointA,circleBody.position);sub(c.contactPointB,worldVertex,convexOffset);add(c.contactPointB,c.contactPointB,convexOffset);sub(c.contactPointB,c.contactPointB,convexBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1}}}return 0};var pic_worldVertex0=vec2.create(),pic_worldVertex1=vec2.create(),pic_r0=vec2.create(),pic_r1=vec2.create();function pointInConvex(worldPoint,convexShape,convexOffset,convexAngle){var worldVertex0=pic_worldVertex0,worldVertex1=pic_worldVertex1,r0=pic_r0,r1=pic_r1,point=worldPoint,verts=convexShape.vertices,lastCross=null;for(var i=0;i!==verts.length+1;i++){var v0=verts[i%verts.length],v1=verts[(i+1)%verts.length];vec2.rotate(worldVertex0,v0,convexAngle);vec2.rotate(worldVertex1,v1,convexAngle);add(worldVertex0,worldVertex0,convexOffset);add(worldVertex1,worldVertex1,convexOffset);sub(r0,worldVertex0,point);sub(r1,worldVertex1,point);var cross=vec2.crossLength(r0,r1);if(lastCross===null)lastCross=cross;if(cross*lastCross<=0){return false}lastCross=cross}return true}Narrowphase.prototype[Shape.PARTICLE|Shape.CONVEX]=Narrowphase.prototype[Shape.PARTICLE|Shape.RECTANGLE]=Narrowphase.prototype.particleConvex=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var convexShape=sj,convexAngle=aj,convexBody=bj,convexOffset=xj,particleOffset=xi,particleBody=bi,particleShape=si,worldVertex0=tmp1,worldVertex1=tmp2,worldEdge=tmp3,worldEdgeUnit=tmp4,worldTangent=tmp5,centerDist=tmp6,convexToparticle=tmp7,orthoDist=tmp8,projectedPoint=tmp9,dist=tmp10,worldVertex=tmp11,closestEdge=-1,closestEdgeDistance=null,closestEdgeOrthoDist=tmp12,closestEdgeProjectedPoint=tmp13,r0=tmp14,r1=tmp15,localPoint=tmp16,candidateDist=tmp17,minEdgeNormal=tmp18,minCandidateDistance=Number.MAX_VALUE;var numReported=0,found=false,verts=convexShape.vertices;if(!pointInConvex(particleOffset,convexShape,convexOffset,convexAngle))return 0;if(justTest)return true;var lastCross=null;for(var i=0;i!==verts.length+1;i++){var v0=verts[i%verts.length],v1=verts[(i+1)%verts.length];vec2.rotate(worldVertex0,v0,convexAngle);vec2.rotate(worldVertex1,v1,convexAngle);add(worldVertex0,worldVertex0,convexOffset);add(worldVertex1,worldVertex1,convexOffset);sub(worldEdge,worldVertex1,worldVertex0);vec2.normalize(worldEdgeUnit,worldEdge);vec2.rotate(worldTangent,worldEdgeUnit,-Math.PI/2);sub(dist,particleOffset,worldVertex0);var d=dot(dist,worldTangent);sub(centerDist,worldVertex0,convexOffset);sub(convexToparticle,particleOffset,convexOffset);vec2.sub(candidateDist,worldVertex0,particleOffset);var candidateDistance=Math.abs(vec2.dot(candidateDist,worldTangent));if(candidateDistance<minCandidateDistance){minCandidateDistance=candidateDistance;vec2.scale(closestEdgeProjectedPoint,worldTangent,candidateDistance);vec2.add(closestEdgeProjectedPoint,closestEdgeProjectedPoint,particleOffset);vec2.copy(minEdgeNormal,worldTangent);found=true}}if(found){var c=this.createContactEquation(particleBody,convexBody,si,sj);vec2.scale(c.normalA,minEdgeNormal,-1);vec2.normalize(c.normalA,c.normalA);vec2.set(c.contactPointA,0,0);add(c.contactPointA,c.contactPointA,particleOffset);sub(c.contactPointA,c.contactPointA,particleBody.position);sub(c.contactPointB,closestEdgeProjectedPoint,convexOffset);add(c.contactPointB,c.contactPointB,convexOffset);sub(c.contactPointB,c.contactPointB,convexBody.position);this.contactEquations.push(c);if(this.enableFriction)this.frictionEquations.push(this.createFrictionFromContact(c));return 1}return 0};Narrowphase.prototype[Shape.CIRCLE]=Narrowphase.prototype.circleCircle=function(bi,si,xi,ai,bj,sj,xj,aj,justTest,radiusA,radiusB){var bodyA=bi,shapeA=si,offsetA=xi,bodyB=bj,shapeB=sj,offsetB=xj,dist=tmp1,radiusA=radiusA||shapeA.radius,radiusB=radiusB||shapeB.radius;sub(dist,xi,xj);var r=radiusA+radiusB;if(vec2.squaredLength(dist)>r*r){return 0}if(justTest){return true}var c=this.createContactEquation(bodyA,bodyB,si,sj);sub(c.normalA,offsetB,offsetA);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,radiusA);vec2.scale(c.contactPointB,c.normalA,-radiusB);add(c.contactPointA,c.contactPointA,offsetA);sub(c.contactPointA,c.contactPointA,bodyA.position);add(c.contactPointB,c.contactPointB,offsetB);sub(c.contactPointB,c.contactPointB,bodyB.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1};Narrowphase.prototype[Shape.PLANE|Shape.CONVEX]=Narrowphase.prototype[Shape.PLANE|Shape.RECTANGLE]=Narrowphase.prototype.planeConvex=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var convexBody=bj,convexOffset=xj,convexShape=sj,convexAngle=aj,planeBody=bi,planeShape=si,planeOffset=xi,planeAngle=ai;var worldVertex=tmp1,worldNormal=tmp2,dist=tmp3;var numReported=0;vec2.rotate(worldNormal,yAxis,planeAngle);for(var i=0;i<convexShape.vertices.length;i++){var v=convexShape.vertices[i];vec2.rotate(worldVertex,v,convexAngle);add(worldVertex,worldVertex,convexOffset);sub(dist,worldVertex,planeOffset);if(dot(dist,worldNormal)<=Narrowphase.convexPrecision){if(justTest){return true}numReported++;var c=this.createContactEquation(planeBody,convexBody,planeShape,convexShape);sub(dist,worldVertex,planeOffset);vec2.copy(c.normalA,worldNormal);var d=dot(dist,c.normalA);vec2.scale(dist,c.normalA,d);sub(c.contactPointB,worldVertex,convexBody.position);sub(c.contactPointA,worldVertex,dist);sub(c.contactPointA,c.contactPointA,planeBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}}}return numReported};Narrowphase.prototype.convexPlane=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){console.warn("Narrowphase.prototype.convexPlane is deprecated. Use planeConvex instead!");return this.planeConvex(bj,sj,xj,aj,bi,si,xi,ai,justTest)};Narrowphase.prototype[Shape.PARTICLE|Shape.PLANE]=Narrowphase.prototype.particlePlane=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var particleBody=bi,particleShape=si,particleOffset=xi,planeBody=bj,planeShape=sj,planeOffset=xj,planeAngle=aj;var dist=tmp1,worldNormal=tmp2;planeAngle=planeAngle||0;sub(dist,particleOffset,planeOffset);vec2.rotate(worldNormal,yAxis,planeAngle);var d=dot(dist,worldNormal);if(d>0)return 0;if(justTest)return true;var c=this.createContactEquation(planeBody,particleBody,sj,si);vec2.copy(c.normalA,worldNormal);vec2.scale(dist,c.normalA,d);sub(c.contactPointA,particleOffset,dist);sub(c.contactPointA,c.contactPointA,planeBody.position);sub(c.contactPointB,particleOffset,particleBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1};Narrowphase.prototype[Shape.CIRCLE|Shape.PARTICLE]=Narrowphase.prototype.circleParticle=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var circleBody=bi,circleShape=si,circleOffset=xi,particleBody=bj,particleShape=sj,particleOffset=xj,dist=tmp1;sub(dist,particleOffset,circleOffset);if(vec2.squaredLength(dist)>circleShape.radius*circleShape.radius)return 0;if(justTest)return true;var c=this.createContactEquation(circleBody,particleBody,si,sj);vec2.copy(c.normalA,dist);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointA,c.normalA,circleShape.radius);add(c.contactPointA,c.contactPointA,circleOffset);sub(c.contactPointA,c.contactPointA,circleBody.position);sub(c.contactPointB,particleOffset,particleBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1};var capsulePlane_tmpCircle=new Circle(1),capsulePlane_tmp1=vec2.create(),capsulePlane_tmp2=vec2.create(),capsulePlane_tmp3=vec2.create();Narrowphase.prototype[Shape.PLANE|Shape.CAPSULE]=Narrowphase.prototype.planeCapsule=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var end1=capsulePlane_tmp1,end2=capsulePlane_tmp2,circle=capsulePlane_tmpCircle,dst=capsulePlane_tmp3;vec2.set(end1,-sj.length/2,0);vec2.rotate(end1,end1,aj);add(end1,end1,xj);vec2.set(end2,sj.length/2,0);vec2.rotate(end2,end2,aj);add(end2,end2,xj);circle.radius=sj.radius;var numContacts1=this.circlePlane(bj,circle,end1,0,bi,si,xi,ai,justTest),numContacts2=this.circlePlane(bj,circle,end2,0,bi,si,xi,ai,justTest);if(justTest)return numContacts1||numContacts2;else return numContacts1+numContacts2};Narrowphase.prototype.capsulePlane=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){console.warn("Narrowphase.prototype.capsulePlane() is deprecated. Use .planeCapsule() instead!");return this.planeCapsule(bj,sj,xj,aj,bi,si,xi,ai,justTest)};Narrowphase.prototype[Shape.CIRCLE|Shape.PLANE]=Narrowphase.prototype.circlePlane=function(bi,si,xi,ai,bj,sj,xj,aj,justTest){var circleBody=bi,circleShape=si,circleOffset=xi,planeBody=bj,shapeB=sj,planeOffset=xj,planeAngle=aj;planeAngle=planeAngle||0;var planeToCircle=tmp1,worldNormal=tmp2,temp=tmp3;sub(planeToCircle,circleOffset,planeOffset);vec2.rotate(worldNormal,yAxis,planeAngle);var d=dot(worldNormal,planeToCircle);if(d>circleShape.radius){return 0}if(justTest){return true}var contact=this.createContactEquation(planeBody,circleBody,sj,si);vec2.copy(contact.normalA,worldNormal);vec2.scale(contact.contactPointB,contact.normalA,-circleShape.radius);add(contact.contactPointB,contact.contactPointB,circleOffset);sub(contact.contactPointB,contact.contactPointB,circleBody.position);vec2.scale(temp,contact.normalA,d);sub(contact.contactPointA,planeToCircle,temp);add(contact.contactPointA,contact.contactPointA,planeOffset);sub(contact.contactPointA,contact.contactPointA,planeBody.position);this.contactEquations.push(contact);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(contact))}return 1};Narrowphase.convexPrecision=1e-7;Narrowphase.prototype[Shape.CONVEX]=Narrowphase.prototype[Shape.CONVEX|Shape.RECTANGLE]=Narrowphase.prototype[Shape.RECTANGLE]=Narrowphase.prototype.convexConvex=function(bi,si,xi,ai,bj,sj,xj,aj,justTest,precision){var sepAxis=tmp1,worldPoint=tmp2,worldPoint0=tmp3,worldPoint1=tmp4,worldEdge=tmp5,projected=tmp6,penetrationVec=tmp7,dist=tmp8,worldNormal=tmp9,numContacts=0,precision=precision||Narrowphase.convexPrecision;var found=Narrowphase.findSeparatingAxis(si,xi,ai,sj,xj,aj,sepAxis);if(!found){return 0}sub(dist,xj,xi);if(dot(sepAxis,dist)>0){vec2.scale(sepAxis,sepAxis,-1)}var closestEdge1=Narrowphase.getClosestEdge(si,ai,sepAxis,true),closestEdge2=Narrowphase.getClosestEdge(sj,aj,sepAxis);if(closestEdge1===-1||closestEdge2===-1){return 0}for(var k=0;k<2;k++){var closestEdgeA=closestEdge1,closestEdgeB=closestEdge2,shapeA=si,shapeB=sj,offsetA=xi,offsetB=xj,angleA=ai,angleB=aj,bodyA=bi,bodyB=bj;if(k===0){var tmp;tmp=closestEdgeA;closestEdgeA=closestEdgeB;closestEdgeB=tmp;tmp=shapeA;shapeA=shapeB;shapeB=tmp;tmp=offsetA;offsetA=offsetB;offsetB=tmp;tmp=angleA;angleA=angleB;angleB=tmp;tmp=bodyA;bodyA=bodyB;bodyB=tmp}for(var j=closestEdgeB;j<closestEdgeB+2;j++){var v=shapeB.vertices[(j+shapeB.vertices.length)%shapeB.vertices.length];vec2.rotate(worldPoint,v,angleB);add(worldPoint,worldPoint,offsetB);var insideNumEdges=0;for(var i=closestEdgeA-1;i<closestEdgeA+2;i++){var v0=shapeA.vertices[(i+shapeA.vertices.length)%shapeA.vertices.length],v1=shapeA.vertices[(i+1+shapeA.vertices.length)%shapeA.vertices.length];vec2.rotate(worldPoint0,v0,angleA);vec2.rotate(worldPoint1,v1,angleA);add(worldPoint0,worldPoint0,offsetA);add(worldPoint1,worldPoint1,offsetA);sub(worldEdge,worldPoint1,worldPoint0);vec2.rotate(worldNormal,worldEdge,-Math.PI/2);vec2.normalize(worldNormal,worldNormal);sub(dist,worldPoint,worldPoint0);var d=dot(worldNormal,dist);if(d<=precision){insideNumEdges++}}if(insideNumEdges>=3){if(justTest){return true}var c=this.createContactEquation(bodyA,bodyB,shapeA,shapeB);numContacts++;var v0=shapeA.vertices[closestEdgeA%shapeA.vertices.length],v1=shapeA.vertices[(closestEdgeA+1)%shapeA.vertices.length];vec2.rotate(worldPoint0,v0,angleA);vec2.rotate(worldPoint1,v1,angleA);add(worldPoint0,worldPoint0,offsetA);add(worldPoint1,worldPoint1,offsetA);sub(worldEdge,worldPoint1,worldPoint0);vec2.rotate(c.normalA,worldEdge,-Math.PI/2);vec2.normalize(c.normalA,c.normalA);sub(dist,worldPoint,worldPoint0);var d=dot(c.normalA,dist);vec2.scale(penetrationVec,c.normalA,d);sub(c.contactPointA,worldPoint,offsetA);sub(c.contactPointA,c.contactPointA,penetrationVec);add(c.contactPointA,c.contactPointA,offsetA);sub(c.contactPointA,c.contactPointA,bodyA.position);sub(c.contactPointB,worldPoint,offsetB);add(c.contactPointB,c.contactPointB,offsetB);sub(c.contactPointB,c.contactPointB,bodyB.position);this.contactEquations.push(c);if(this.enableFriction)this.frictionEquations.push(this.createFrictionFromContact(c))}}}return numContacts};var pcoa_tmp1=vec2.fromValues(0,0);Narrowphase.projectConvexOntoAxis=function(convexShape,convexOffset,convexAngle,worldAxis,result){var max=null,min=null,v,value,localAxis=pcoa_tmp1;vec2.rotate(localAxis,worldAxis,-convexAngle);for(var i=0;i<convexShape.vertices.length;i++){v=convexShape.vertices[i];value=dot(v,localAxis);if(max===null||value>max)max=value;if(min===null||value<min)min=value}if(min>max){var t=min;min=max;max=t}var offset=dot(convexOffset,worldAxis);vec2.set(result,min+offset,max+offset)};var fsa_tmp1=vec2.fromValues(0,0),fsa_tmp2=vec2.fromValues(0,0),fsa_tmp3=vec2.fromValues(0,0),fsa_tmp4=vec2.fromValues(0,0),fsa_tmp5=vec2.fromValues(0,0),fsa_tmp6=vec2.fromValues(0,0);Narrowphase.findSeparatingAxis=function(c1,offset1,angle1,c2,offset2,angle2,sepAxis){var maxDist=null,overlap=false,found=false,edge=fsa_tmp1,worldPoint0=fsa_tmp2,worldPoint1=fsa_tmp3,normal=fsa_tmp4,span1=fsa_tmp5,span2=fsa_tmp6;for(var j=0;j!==2;j++){var c=c1,angle=angle1;if(j===1){c=c2;angle=angle2}for(var i=0;i!==c.vertices.length;i++){vec2.rotate(worldPoint0,c.vertices[i],angle);vec2.rotate(worldPoint1,c.vertices[(i+1)%c.vertices.length],angle);sub(edge,worldPoint1,worldPoint0);vec2.rotate(normal,edge,-Math.PI/2);vec2.normalize(normal,normal);Narrowphase.projectConvexOntoAxis(c1,offset1,angle1,normal,span1);Narrowphase.projectConvexOntoAxis(c2,offset2,angle2,normal,span2);var a=span1,b=span2,swapped=false;if(span1[0]>span2[0]){b=span1;a=span2;swapped=true}var dist=b[0]-a[1];overlap=dist<=Narrowphase.convexPrecision;if(maxDist===null||dist>maxDist){vec2.copy(sepAxis,normal);maxDist=dist;found=overlap}}}return found};var gce_tmp1=vec2.fromValues(0,0),gce_tmp2=vec2.fromValues(0,0),gce_tmp3=vec2.fromValues(0,0);Narrowphase.getClosestEdge=function(c,angle,axis,flip){var localAxis=gce_tmp1,edge=gce_tmp2,normal=gce_tmp3;vec2.rotate(localAxis,axis,-angle);if(flip){vec2.scale(localAxis,localAxis,-1)}var closestEdge=-1,N=c.vertices.length,halfPi=Math.PI/2;for(var i=0;i!==N;i++){sub(edge,c.vertices[(i+1)%N],c.vertices[i%N]);vec2.rotate(normal,edge,-halfPi);vec2.normalize(normal,normal);var d=dot(normal,localAxis);if(closestEdge==-1||d>maxDot){closestEdge=i%N;maxDot=d}}return closestEdge};var circleHeightfield_candidate=vec2.create(),circleHeightfield_dist=vec2.create(),circleHeightfield_v0=vec2.create(),circleHeightfield_v1=vec2.create(),circleHeightfield_minCandidate=vec2.create(),circleHeightfield_worldNormal=vec2.create(),circleHeightfield_minCandidateNormal=vec2.create();Narrowphase.prototype[Shape.CIRCLE|Shape.HEIGHTFIELD]=Narrowphase.prototype.circleHeightfield=function(circleBody,circleShape,circlePos,circleAngle,hfBody,hfShape,hfPos,hfAngle,justTest,radius){var data=hfShape.data,radius=radius||circleShape.radius,w=hfShape.elementWidth,dist=circleHeightfield_dist,candidate=circleHeightfield_candidate,minCandidate=circleHeightfield_minCandidate,minCandidateNormal=circleHeightfield_minCandidateNormal,worldNormal=circleHeightfield_worldNormal,v0=circleHeightfield_v0,v1=circleHeightfield_v1;
var idxA=Math.floor((circlePos[0]-radius-hfPos[0])/w),idxB=Math.ceil((circlePos[0]+radius-hfPos[0])/w);if(idxA<0)idxA=0;if(idxB>=data.length)idxB=data.length-1;var max=data[idxA],min=data[idxB];for(var i=idxA;i<idxB;i++){if(data[i]<min)min=data[i];if(data[i]>max)max=data[i]}if(circlePos[1]-radius>max)return justTest?false:0;if(circlePos[1]+radius<min){}var found=false,minDist=false;for(var i=idxA;i<idxB;i++){vec2.set(v0,i*w,data[i]);vec2.set(v1,(i+1)*w,data[i+1]);vec2.add(v0,v0,hfPos);vec2.add(v1,v1,hfPos);vec2.sub(worldNormal,v1,v0);vec2.rotate(worldNormal,worldNormal,Math.PI/2);vec2.normalize(worldNormal,worldNormal);vec2.scale(candidate,worldNormal,-radius);vec2.add(candidate,candidate,circlePos);vec2.sub(dist,candidate,v0);var d=vec2.dot(dist,worldNormal);if(candidate[0]>=v0[0]&&candidate[0]<v1[0]&&d<=0){if(minDist===false||Math.abs(d)<minDist){vec2.scale(dist,worldNormal,-d);vec2.add(minCandidate,candidate,dist);vec2.copy(minCandidateNormal,worldNormal);found=true;minDist=Math.abs(d);if(justTest)return true}}}if(found){var c=this.createContactEquation(hfBody,circleBody,hfShape,circleShape);vec2.copy(c.normalA,minCandidateNormal);vec2.scale(c.contactPointB,c.normalA,-radius);add(c.contactPointB,c.contactPointB,circlePos);sub(c.contactPointB,c.contactPointB,circleBody.position);vec2.copy(c.contactPointA,minCandidate);vec2.sub(c.contactPointA,c.contactPointA,hfBody.position);this.contactEquations.push(c);if(this.enableFriction)this.frictionEquations.push(this.createFrictionFromContact(c));return 1}if(radius>0){for(var i=idxA;i<=idxB;i++){vec2.set(v0,i*w,data[i]);vec2.add(v0,v0,hfPos);vec2.sub(dist,circlePos,v0);if(vec2.squaredLength(dist)<radius*radius){if(justTest)return true;var c=this.createContactEquation(hfBody,circleBody,hfShape,circleShape);vec2.copy(c.normalA,dist);vec2.normalize(c.normalA,c.normalA);vec2.scale(c.contactPointB,c.normalA,-radius);add(c.contactPointB,c.contactPointB,circlePos);sub(c.contactPointB,c.contactPointB,circleBody.position);sub(c.contactPointA,v0,hfPos);add(c.contactPointA,c.contactPointA,hfPos);sub(c.contactPointA,c.contactPointA,hfBody.position);this.contactEquations.push(c);if(this.enableFriction){this.frictionEquations.push(this.createFrictionFromContact(c))}return 1}}}return 0}},{"../equations/ContactEquation":21,"../equations/FrictionEquation":23,"../math/vec2":30,"../objects/Body":31,"../shapes/Circle":35,"../shapes/Rectangle":41,"../shapes/Shape":42,"../utils/Utils":45}],13:[function(_dereq_,module,exports){var Circle=_dereq_("../shapes/Circle"),Plane=_dereq_("../shapes/Plane"),Shape=_dereq_("../shapes/Shape"),Particle=_dereq_("../shapes/Particle"),Utils=_dereq_("../utils/Utils"),Broadphase=_dereq_("../collision/Broadphase"),vec2=_dereq_("../math/vec2");module.exports=SAPBroadphase;function SAPBroadphase(){Broadphase.call(this,Broadphase.SAP);this.axisListX=[];this.axisListY=[];this.world=null;var axisListX=this.axisListX,axisListY=this.axisListY;this._addBodyHandler=function(e){axisListX.push(e.body);axisListY.push(e.body)};this._removeBodyHandler=function(e){var idx=axisListX.indexOf(e.body);if(idx!==-1)axisListX.splice(idx,1);idx=axisListY.indexOf(e.body);if(idx!==-1)axisListY.splice(idx,1)}}SAPBroadphase.prototype=new Broadphase;SAPBroadphase.prototype.setWorld=function(world){this.axisListX.length=this.axisListY.length=0;Utils.appendArray(this.axisListX,world.bodies);Utils.appendArray(this.axisListY,world.bodies);world.off("addBody",this._addBodyHandler).off("removeBody",this._removeBodyHandler);world.on("addBody",this._addBodyHandler).on("removeBody",this._removeBodyHandler);this.world=world};SAPBroadphase.sortAxisListX=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound[0]<=v.aabb.lowerBound[0])break;a[j+1]=a[j]}a[j+1]=v}return a};SAPBroadphase.sortAxisListY=function(a){for(var i=1,l=a.length;i<l;i++){var v=a[i];for(var j=i-1;j>=0;j--){if(a[j].aabb.lowerBound[1]<=v.aabb.lowerBound[1])break;a[j+1]=a[j]}a[j+1]=v}return a};var preliminaryList={keys:[]};SAPBroadphase.prototype.getCollisionPairs=function(world){var bodiesX=this.axisListX,bodiesY=this.axisListY,result=this.result,axisIndex=this.axisIndex;result.length=0;for(var i=0;i!==bodiesX.length;i++){var b=bodiesX[i];if(b.aabbNeedsUpdate)b.updateAABB()}SAPBroadphase.sortAxisListX(bodiesX);SAPBroadphase.sortAxisListY(bodiesY);for(var i=0,N=bodiesX.length;i!==N;i++){var bi=bodiesX[i];for(var j=i+1;j<N;j++){var bj=bodiesX[j];if(!SAPBroadphase.checkBounds(bi,bj,0))break;if(Broadphase.canCollide(bi,bj)){var key=bi.id<bj.id?bi.id+" "+bj.id:bj.id+" "+bi.id;preliminaryList[key]=true;preliminaryList.keys.push(key)}}}for(var i=0,N=bodiesY.length;i!==N;i++){var bi=bodiesY[i];for(var j=i+1;j<N;j++){var bj=bodiesY[j];if(!SAPBroadphase.checkBounds(bi,bj,1)){break}if(Broadphase.canCollide(bi,bj)){var key=bi.id<bj.id?bi.id+" "+bj.id:bj.id+" "+bi.id;if(preliminaryList[key]&&this.boundingVolumeCheck(bi,bj)){result.push(bi,bj)}}}}var keys=preliminaryList.keys;for(var i=0,N=keys.length;i!==N;i++){delete preliminaryList[keys[i]]}keys.length=0;return result};SAPBroadphase.checkBounds=function(bi,bj,axisIndex){return bj.aabb.lowerBound[axisIndex]<=bi.aabb.upperBound[axisIndex]}},{"../collision/Broadphase":9,"../math/vec2":30,"../shapes/Circle":35,"../shapes/Particle":39,"../shapes/Plane":40,"../shapes/Shape":42,"../utils/Utils":45}],14:[function(_dereq_,module,exports){module.exports=Constraint;function Constraint(bodyA,bodyB,type,options){options=options||{};this.type=type;this.equations=[];this.bodyA=bodyA;this.bodyB=bodyB;this.collideConnected=typeof options.collideConnected!=="undefined"?options.collideConnected:true;if(bodyA)bodyA.wakeUp();if(bodyB)bodyB.wakeUp()}Constraint.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};Constraint.DISTANCE=1;Constraint.GEAR=2;Constraint.LOCK=3;Constraint.PRISMATIC=4;Constraint.REVOLUTE=5;Constraint.prototype.setStiffness=function(stiffness){var eqs=this.equations;for(var i=0;i!==eqs.length;i++){var eq=eqs[i];eq.stiffness=stiffness;eq.needsUpdate=true}};Constraint.prototype.setRelaxation=function(relaxation){var eqs=this.equations;for(var i=0;i!==eqs.length;i++){var eq=eqs[i];eq.relaxation=relaxation;eq.needsUpdate=true}}},{}],15:[function(_dereq_,module,exports){var Constraint=_dereq_("./Constraint"),Equation=_dereq_("../equations/Equation"),vec2=_dereq_("../math/vec2");module.exports=DistanceConstraint;function DistanceConstraint(bodyA,bodyB,distance,options){options=options||{};Constraint.call(this,bodyA,bodyB,Constraint.DISTANCE,options);this.distance=distance;var maxForce;if(typeof options.maxForce==="undefined"){maxForce=Number.MAX_VALUE}else{maxForce=options.maxForce}var normal=new Equation(bodyA,bodyB,-maxForce,maxForce);this.equations=[normal];var r=vec2.create();normal.computeGq=function(){vec2.sub(r,bodyB.position,bodyA.position);return vec2.length(r)-distance};this.setMaxForce(maxForce)}DistanceConstraint.prototype=new Constraint;var n=vec2.create();DistanceConstraint.prototype.update=function(){var normal=this.equations[0],bodyA=this.bodyA,bodyB=this.bodyB,distance=this.distance,G=normal.G;vec2.sub(n,bodyB.position,bodyA.position);vec2.normalize(n,n);G[0]=-n[0];G[1]=-n[1];G[3]=n[0];G[4]=n[1]};DistanceConstraint.prototype.setMaxForce=function(f){var normal=this.equations[0];normal.minForce=-f;normal.maxForce=f};DistanceConstraint.prototype.getMaxForce=function(f){var normal=this.equations[0];return normal.maxForce}},{"../equations/Equation":22,"../math/vec2":30,"./Constraint":14}],16:[function(_dereq_,module,exports){var Constraint=_dereq_("./Constraint"),Equation=_dereq_("../equations/Equation"),AngleLockEquation=_dereq_("../equations/AngleLockEquation"),vec2=_dereq_("../math/vec2");module.exports=GearConstraint;function GearConstraint(bodyA,bodyB,options){options=options||{};Constraint.call(this,bodyA,bodyB,Constraint.GEAR,options);this.equations=[new AngleLockEquation(bodyA,bodyB,options)];this.angle=typeof options.angle==="number"?options.angle:0;this.ratio=typeof options.ratio==="number"?options.ratio:1;if(typeof options.maxTorque==="number"){this.setMaxTorque(options.maxTorque)}}GearConstraint.prototype=new Constraint;GearConstraint.prototype.update=function(){var eq=this.equations[0];if(eq.ratio!==this.ratio){eq.setRatio(this.ratio)}eq.angle=this.angle};GearConstraint.prototype.setMaxTorque=function(torque){this.equations[0].setMaxTorque(torque)};GearConstraint.prototype.getMaxTorque=function(torque){return this.equations[0].maxForce}},{"../equations/AngleLockEquation":20,"../equations/Equation":22,"../math/vec2":30,"./Constraint":14}],17:[function(_dereq_,module,exports){var Constraint=_dereq_("./Constraint"),vec2=_dereq_("../math/vec2"),Equation=_dereq_("../equations/Equation");module.exports=LockConstraint;function LockConstraint(bodyA,bodyB,options){options=options||{};Constraint.call(this,bodyA,bodyB,Constraint.LOCK,options);var maxForce=typeof options.maxForce==="undefined"?Number.MAX_VALUE:options.maxForce;var localOffsetB=options.localOffsetB||vec2.fromValues(0,0);localOffsetB=vec2.fromValues(localOffsetB[0],localOffsetB[1]);var localAngleB=options.localAngleB||0;var x=new Equation(bodyA,bodyB,-maxForce,maxForce),y=new Equation(bodyA,bodyB,-maxForce,maxForce),rot=new Equation(bodyA,bodyB,-maxForce,maxForce);var l=vec2.create(),g=vec2.create(),that=this;x.computeGq=function(){vec2.rotate(l,that.localOffsetB,bodyA.angle);vec2.sub(g,bodyB.position,bodyA.position);vec2.sub(g,g,l);return g[0]};y.computeGq=function(){vec2.rotate(l,that.localOffsetB,bodyA.angle);vec2.sub(g,bodyB.position,bodyA.position);vec2.sub(g,g,l);return g[1]};var r=vec2.create(),t=vec2.create();rot.computeGq=function(){vec2.rotate(r,that.localOffsetB,bodyB.angle-that.localAngleB);vec2.scale(r,r,-1);vec2.sub(g,bodyA.position,bodyB.position);vec2.add(g,g,r);vec2.rotate(t,r,-Math.PI/2);vec2.normalize(t,t);return vec2.dot(g,t)};this.localOffsetB=localOffsetB;this.localAngleB=localAngleB;this.equations.push(x,y,rot);this.setMaxForce(maxForce)}LockConstraint.prototype=new Constraint;LockConstraint.prototype.setMaxForce=function(force){var eqs=this.equations;for(var i=0;i<this.equations.length;i++){eqs[i].maxForce=force;eqs[i].minForce=-force}};LockConstraint.prototype.getMaxForce=function(){return this.equations[0].maxForce};var l=vec2.create();var r=vec2.create();var t=vec2.create();var xAxis=vec2.fromValues(1,0);var yAxis=vec2.fromValues(0,1);LockConstraint.prototype.update=function(){var x=this.equations[0],y=this.equations[1],rot=this.equations[2],bodyA=this.bodyA,bodyB=this.bodyB;vec2.rotate(l,this.localOffsetB,bodyA.angle);vec2.rotate(r,this.localOffsetB,bodyB.angle-this.localAngleB);vec2.scale(r,r,-1);vec2.rotate(t,r,Math.PI/2);vec2.normalize(t,t);x.G[0]=-1;x.G[1]=0;x.G[2]=-vec2.crossLength(l,xAxis);x.G[3]=1;y.G[0]=0;y.G[1]=-1;y.G[2]=-vec2.crossLength(l,yAxis);y.G[4]=1;rot.G[0]=-t[0];rot.G[1]=-t[1];rot.G[3]=t[0];rot.G[4]=t[1];rot.G[5]=vec2.crossLength(r,t)}},{"../equations/Equation":22,"../math/vec2":30,"./Constraint":14}],18:[function(_dereq_,module,exports){var Constraint=_dereq_("./Constraint"),ContactEquation=_dereq_("../equations/ContactEquation"),Equation=_dereq_("../equations/Equation"),vec2=_dereq_("../math/vec2"),RotationalLockEquation=_dereq_("../equations/RotationalLockEquation");module.exports=PrismaticConstraint;function PrismaticConstraint(bodyA,bodyB,options){options=options||{};Constraint.call(this,bodyA,bodyB,Constraint.PRISMATIC,options);var localAnchorA=vec2.fromValues(0,0),localAxisA=vec2.fromValues(1,0),localAnchorB=vec2.fromValues(0,0);if(options.localAnchorA)vec2.copy(localAnchorA,options.localAnchorA);if(options.localAxisA)vec2.copy(localAxisA,options.localAxisA);if(options.localAnchorB)vec2.copy(localAnchorB,options.localAnchorB);this.localAnchorA=localAnchorA;this.localAnchorB=localAnchorB;this.localAxisA=localAxisA;var maxForce=this.maxForce=typeof options.maxForce!="undefined"?options.maxForce:Number.MAX_VALUE;var trans=new Equation(bodyA,bodyB,-maxForce,maxForce);var ri=new vec2.create,rj=new vec2.create,gg=new vec2.create,t=new vec2.create;trans.computeGq=function(){return vec2.dot(gg,t)};trans.updateJacobian=function(){var G=this.G,xi=bodyA.position,xj=bodyB.position;vec2.rotate(ri,localAnchorA,bodyA.angle);vec2.rotate(rj,localAnchorB,bodyB.angle);vec2.add(gg,xj,rj);vec2.sub(gg,gg,xi);vec2.sub(gg,gg,ri);vec2.rotate(t,localAxisA,bodyA.angle+Math.PI/2);G[0]=-t[0];G[1]=-t[1];G[2]=-vec2.crossLength(ri,t)+vec2.crossLength(t,gg);G[3]=t[0];G[4]=t[1];G[5]=vec2.crossLength(rj,t)};this.equations.push(trans);if(!options.disableRotationalLock){var rot=new RotationalLockEquation(bodyA,bodyB,-maxForce,maxForce);this.equations.push(rot)}this.position=0;this.velocity=0;this.lowerLimitEnabled=typeof options.lowerLimit!=="undefined"?true:false;this.upperLimitEnabled=typeof options.upperLimit!=="undefined"?true:false;this.lowerLimit=typeof options.lowerLimit!=="undefined"?options.lowerLimit:0;this.upperLimit=typeof options.upperLimit!=="undefined"?options.upperLimit:1;this.upperLimitEquation=new ContactEquation(bodyA,bodyB);this.lowerLimitEquation=new ContactEquation(bodyA,bodyB);this.upperLimitEquation.minForce=this.lowerLimitEquation.minForce=0;this.upperLimitEquation.maxForce=this.lowerLimitEquation.maxForce=maxForce;this.motorEquation=new Equation(bodyA,bodyB);this.motorEnabled=false;this.motorSpeed=0;var that=this;var motorEquation=this.motorEquation;var old=motorEquation.computeGW;motorEquation.computeGq=function(){return 0};motorEquation.computeGW=function(){var G=this.G,bi=this.bodyA,bj=this.bodyB,vi=bi.velocity,vj=bj.velocity,wi=bi.angularVelocity,wj=bj.angularVelocity;return this.transformedGmult(G,vi,wi,vj,wj)+that.motorSpeed}}PrismaticConstraint.prototype=new Constraint;var worldAxisA=vec2.create(),worldAnchorA=vec2.create(),worldAnchorB=vec2.create(),orientedAnchorA=vec2.create(),orientedAnchorB=vec2.create(),tmp=vec2.create();PrismaticConstraint.prototype.update=function(){var eqs=this.equations,trans=eqs[0],upperLimit=this.upperLimit,lowerLimit=this.lowerLimit,upperLimitEquation=this.upperLimitEquation,lowerLimitEquation=this.lowerLimitEquation,bodyA=this.bodyA,bodyB=this.bodyB,localAxisA=this.localAxisA,localAnchorA=this.localAnchorA,localAnchorB=this.localAnchorB;trans.updateJacobian();vec2.rotate(worldAxisA,localAxisA,bodyA.angle);vec2.rotate(orientedAnchorA,localAnchorA,bodyA.angle);vec2.add(worldAnchorA,orientedAnchorA,bodyA.position);vec2.rotate(orientedAnchorB,localAnchorB,bodyB.angle);vec2.add(worldAnchorB,orientedAnchorB,bodyB.position);var relPosition=this.position=vec2.dot(worldAnchorB,worldAxisA)-vec2.dot(worldAnchorA,worldAxisA);if(this.motorEnabled){var G=this.motorEquation.G;G[0]=worldAxisA[0];G[1]=worldAxisA[1];G[2]=vec2.crossLength(worldAxisA,orientedAnchorB);G[3]=-worldAxisA[0];G[4]=-worldAxisA[1];G[5]=-vec2.crossLength(worldAxisA,orientedAnchorA)}if(this.upperLimitEnabled&&relPosition>upperLimit){vec2.scale(upperLimitEquation.normalA,worldAxisA,-1);vec2.sub(upperLimitEquation.contactPointA,worldAnchorA,bodyA.position);vec2.sub(upperLimitEquation.contactPointB,worldAnchorB,bodyB.position);vec2.scale(tmp,worldAxisA,upperLimit);vec2.add(upperLimitEquation.contactPointA,upperLimitEquation.contactPointA,tmp);if(eqs.indexOf(upperLimitEquation)==-1)eqs.push(upperLimitEquation)}else{var idx=eqs.indexOf(upperLimitEquation);if(idx!=-1)eqs.splice(idx,1)}if(this.lowerLimitEnabled&&relPosition<lowerLimit){vec2.scale(lowerLimitEquation.normalA,worldAxisA,1);vec2.sub(lowerLimitEquation.contactPointA,worldAnchorA,bodyA.position);vec2.sub(lowerLimitEquation.contactPointB,worldAnchorB,bodyB.position);vec2.scale(tmp,worldAxisA,lowerLimit);vec2.sub(lowerLimitEquation.contactPointB,lowerLimitEquation.contactPointB,tmp);if(eqs.indexOf(lowerLimitEquation)==-1)eqs.push(lowerLimitEquation)}else{var idx=eqs.indexOf(lowerLimitEquation);if(idx!=-1)eqs.splice(idx,1)}};PrismaticConstraint.prototype.enableMotor=function(){if(this.motorEnabled)return;this.equations.push(this.motorEquation);this.motorEnabled=true};PrismaticConstraint.prototype.disableMotor=function(){if(!this.motorEnabled)return;var i=this.equations.indexOf(this.motorEquation);this.equations.splice(i,1);this.motorEnabled=false}},{"../equations/ContactEquation":21,"../equations/Equation":22,"../equations/RotationalLockEquation":24,"../math/vec2":30,"./Constraint":14}],19:[function(_dereq_,module,exports){var Constraint=_dereq_("./Constraint"),Equation=_dereq_("../equations/Equation"),RotationalVelocityEquation=_dereq_("../equations/RotationalVelocityEquation"),RotationalLockEquation=_dereq_("../equations/RotationalLockEquation"),vec2=_dereq_("../math/vec2");module.exports=RevoluteConstraint;var worldPivotA=vec2.create(),worldPivotB=vec2.create(),xAxis=vec2.fromValues(1,0),yAxis=vec2.fromValues(0,1),g=vec2.create();function RevoluteConstraint(bodyA,pivotA,bodyB,pivotB,options){options=options||{};Constraint.call(this,bodyA,bodyB,Constraint.REVOLUTE,options);var maxForce=this.maxForce=typeof options.maxForce!=="undefined"?options.maxForce:Number.MAX_VALUE;this.pivotA=pivotA;this.pivotB=pivotB;var eqs=this.equations=[new Equation(bodyA,bodyB,-maxForce,maxForce),new Equation(bodyA,bodyB,-maxForce,maxForce)];var x=eqs[0];var y=eqs[1];var that=this;x.computeGq=function(){vec2.rotate(worldPivotA,that.pivotA,bodyA.angle);vec2.rotate(worldPivotB,that.pivotB,bodyB.angle);vec2.add(g,bodyB.position,worldPivotB);vec2.sub(g,g,bodyA.position);vec2.sub(g,g,worldPivotA);return vec2.dot(g,xAxis)};y.computeGq=function(){vec2.rotate(worldPivotA,that.pivotA,bodyA.angle);vec2.rotate(worldPivotB,that.pivotB,bodyB.angle);vec2.add(g,bodyB.position,worldPivotB);vec2.sub(g,g,bodyA.position);vec2.sub(g,g,worldPivotA);return vec2.dot(g,yAxis)};y.minForce=x.minForce=-maxForce;y.maxForce=x.maxForce=maxForce;this.motorEquation=new RotationalVelocityEquation(bodyA,bodyB);this.motorEnabled=false;this.angle=0;this.lowerLimitEnabled=false;this.upperLimitEnabled=false;this.lowerLimit=0;this.upperLimit=0;this.upperLimitEquation=new RotationalLockEquation(bodyA,bodyB);this.lowerLimitEquation=new RotationalLockEquation(bodyA,bodyB);this.upperLimitEquation.minForce=0;this.lowerLimitEquation.maxForce=0}RevoluteConstraint.prototype=new Constraint;RevoluteConstraint.prototype.update=function(){var bodyA=this.bodyA,bodyB=this.bodyB,pivotA=this.pivotA,pivotB=this.pivotB,eqs=this.equations,normal=eqs[0],tangent=eqs[1],x=eqs[0],y=eqs[1],upperLimit=this.upperLimit,lowerLimit=this.lowerLimit,upperLimitEquation=this.upperLimitEquation,lowerLimitEquation=this.lowerLimitEquation;var relAngle=this.angle=bodyB.angle-bodyA.angle;if(this.upperLimitEnabled&&relAngle>upperLimit){upperLimitEquation.angle=upperLimit;if(eqs.indexOf(upperLimitEquation)==-1)eqs.push(upperLimitEquation)}else{var idx=eqs.indexOf(upperLimitEquation);if(idx!=-1)eqs.splice(idx,1)}if(this.lowerLimitEnabled&&relAngle<lowerLimit){lowerLimitEquation.angle=lowerLimit;if(eqs.indexOf(lowerLimitEquation)==-1)eqs.push(lowerLimitEquation)}else{var idx=eqs.indexOf(lowerLimitEquation);if(idx!=-1)eqs.splice(idx,1)}vec2.rotate(worldPivotA,pivotA,bodyA.angle);vec2.rotate(worldPivotB,pivotB,bodyB.angle);x.G[0]=-1;x.G[1]=0;x.G[2]=-vec2.crossLength(worldPivotA,xAxis);x.G[3]=1;x.G[4]=0;x.G[5]=vec2.crossLength(worldPivotB,xAxis);y.G[0]=0;y.G[1]=-1;y.G[2]=-vec2.crossLength(worldPivotA,yAxis);y.G[3]=0;y.G[4]=1;y.G[5]=vec2.crossLength(worldPivotB,yAxis)};RevoluteConstraint.prototype.enableMotor=function(){if(this.motorEnabled)return;this.equations.push(this.motorEquation);this.motorEnabled=true};RevoluteConstraint.prototype.disableMotor=function(){if(!this.motorEnabled)return;var i=this.equations.indexOf(this.motorEquation);this.equations.splice(i,1);this.motorEnabled=false};RevoluteConstraint.prototype.motorIsEnabled=function(){return!!this.motorEnabled};RevoluteConstraint.prototype.setMotorSpeed=function(speed){if(!this.motorEnabled){return}var i=this.equations.indexOf(this.motorEquation);this.equations[i].relativeVelocity=speed};RevoluteConstraint.prototype.getMotorSpeed=function(){if(!this.motorEnabled)return false;return this.motorEquation.relativeVelocity}},{"../equations/Equation":22,"../equations/RotationalLockEquation":24,"../equations/RotationalVelocityEquation":25,"../math/vec2":30,"./Constraint":14}],20:[function(_dereq_,module,exports){var Equation=_dereq_("./Equation"),vec2=_dereq_("../math/vec2");module.exports=AngleLockEquation;function AngleLockEquation(bodyA,bodyB,options){options=options||{};Equation.call(this,bodyA,bodyB,-Number.MAX_VALUE,Number.MAX_VALUE);this.angle=options.angle||0;this.ratio=typeof options.ratio==="number"?options.ratio:1;this.setRatio(this.ratio)}AngleLockEquation.prototype=new Equation;AngleLockEquation.prototype.constructor=AngleLockEquation;AngleLockEquation.prototype.computeGq=function(){return this.ratio*this.bodyA.angle-this.bodyB.angle+this.angle};AngleLockEquation.prototype.setRatio=function(ratio){var G=this.G;G[2]=ratio;G[5]=-1;this.ratio=ratio};AngleLockEquation.prototype.setMaxTorque=function(torque){this.maxForce=torque;this.minForce=-torque}},{"../math/vec2":30,"./Equation":22}],21:[function(_dereq_,module,exports){var Equation=_dereq_("./Equation"),vec2=_dereq_("../math/vec2");module.exports=ContactEquation;function ContactEquation(bodyA,bodyB){Equation.call(this,bodyA,bodyB,0,Number.MAX_VALUE);this.contactPointA=vec2.create();this.penetrationVec=vec2.create();this.contactPointB=vec2.create();this.normalA=vec2.create();this.restitution=0;this.firstImpact=false;this.shapeA=null;this.shapeB=null}ContactEquation.prototype=new Equation;ContactEquation.prototype.constructor=ContactEquation;ContactEquation.prototype.computeB=function(a,b,h){var bi=this.bodyA,bj=this.bodyB,ri=this.contactPointA,rj=this.contactPointB,xi=bi.position,xj=bj.position;var penetrationVec=this.penetrationVec,n=this.normalA,G=this.G;var rixn=vec2.crossLength(ri,n),rjxn=vec2.crossLength(rj,n);G[0]=-n[0];G[1]=-n[1];G[2]=-rixn;G[3]=n[0];G[4]=n[1];G[5]=rjxn;vec2.add(penetrationVec,xj,rj);vec2.sub(penetrationVec,penetrationVec,xi);vec2.sub(penetrationVec,penetrationVec,ri);var GW,Gq;if(this.firstImpact&&this.restitution!==0){Gq=0;GW=1/b*(1+this.restitution)*this.computeGW()}else{Gq=vec2.dot(n,penetrationVec);GW=this.computeGW()}var GiMf=this.computeGiMf();var B=-Gq*a-GW*b-h*GiMf;return B}},{"../math/vec2":30,"./Equation":22}],22:[function(_dereq_,module,exports){module.exports=Equation;var vec2=_dereq_("../math/vec2"),Utils=_dereq_("../utils/Utils"),Body=_dereq_("../objects/Body");function Equation(bodyA,bodyB,minForce,maxForce){this.minForce=typeof minForce==="undefined"?-Number.MAX_VALUE:minForce;this.maxForce=typeof maxForce==="undefined"?Number.MAX_VALUE:maxForce;this.bodyA=bodyA;this.bodyB=bodyB;this.stiffness=Equation.DEFAULT_STIFFNESS;this.relaxation=Equation.DEFAULT_RELAXATION;this.G=new Utils.ARRAY_TYPE(6);for(var i=0;i<6;i++){this.G[i]=0}this.offset=0;this.a=0;this.b=0;this.epsilon=0;this.timeStep=1/60;this.needsUpdate=true;this.multiplier=0;this.relativeVelocity=0;this.enabled=true}Equation.prototype.constructor=Equation;Equation.DEFAULT_STIFFNESS=1e6;Equation.DEFAULT_RELAXATION=4;Equation.prototype.update=function(){var k=this.stiffness,d=this.relaxation,h=this.timeStep;this.a=4/(h*(1+4*d));this.b=4*d/(1+4*d);this.epsilon=4/(h*h*k*(1+4*d));this.needsUpdate=false};function Gmult(G,vi,wi,vj,wj){return G[0]*vi[0]+G[1]*vi[1]+G[2]*wi+G[3]*vj[0]+G[4]*vj[1]+G[5]*wj}Equation.prototype.computeB=function(a,b,h){var GW=this.computeGW();var Gq=this.computeGq();var GiMf=this.computeGiMf();return-Gq*a-GW*b-GiMf*h};var qi=vec2.create(),qj=vec2.create();Equation.prototype.computeGq=function(){var G=this.G,bi=this.bodyA,bj=this.bodyB,xi=bi.position,xj=bj.position,ai=bi.angle,aj=bj.angle;return Gmult(G,qi,ai,qj,aj)+this.offset};var tmp_i=vec2.create(),tmp_j=vec2.create();Equation.prototype.transformedGmult=function(G,vi,wi,vj,wj){return Gmult(G,vi,wi,vj,wj)};Equation.prototype.computeGW=function(){var G=this.G,bi=this.bodyA,bj=this.bodyB,vi=bi.velocity,vj=bj.velocity,wi=bi.angularVelocity,wj=bj.angularVelocity;return this.transformedGmult(G,vi,wi,vj,wj)+this.relativeVelocity};Equation.prototype.computeGWlambda=function(){var G=this.G,bi=this.bodyA,bj=this.bodyB,vi=bi.vlambda,vj=bj.vlambda,wi=bi.wlambda,wj=bj.wlambda;return Gmult(G,vi,wi,vj,wj)};var iMfi=vec2.create(),iMfj=vec2.create();Equation.prototype.computeGiMf=function(){var bi=this.bodyA,bj=this.bodyB,fi=bi.force,ti=bi.angularForce,fj=bj.force,tj=bj.angularForce,invMassi=getBodyInvMass(bi),invMassj=getBodyInvMass(bj),invIi=getBodyInvInertia(bi),invIj=getBodyInvInertia(bj),G=this.G;vec2.scale(iMfi,fi,invMassi);vec2.scale(iMfj,fj,invMassj);return this.transformedGmult(G,iMfi,ti*invIi,iMfj,tj*invIj)};function getBodyInvMass(body){if(body.sleepState===Body.SLEEPING){return 0}else{return body.invMass}}function getBodyInvInertia(body){if(body.sleepState===Body.SLEEPING){return 0}else{return body.invInertia}}Equation.prototype.computeGiMGt=function(){var bi=this.bodyA,bj=this.bodyB,invMassi=getBodyInvMass(bi),invMassj=getBodyInvMass(bj),invIi=getBodyInvInertia(bi),invIj=getBodyInvInertia(bj),G=this.G;return G[0]*G[0]*invMassi+G[1]*G[1]*invMassi+G[2]*G[2]*invIi+G[3]*G[3]*invMassj+G[4]*G[4]*invMassj+G[5]*G[5]*invIj};var addToWlambda_temp=vec2.create(),addToWlambda_Gi=vec2.create(),addToWlambda_Gj=vec2.create(),addToWlambda_ri=vec2.create(),addToWlambda_rj=vec2.create(),addToWlambda_Mdiag=vec2.create();Equation.prototype.addToWlambda=function(deltalambda){var bi=this.bodyA,bj=this.bodyB,temp=addToWlambda_temp,Gi=addToWlambda_Gi,Gj=addToWlambda_Gj,ri=addToWlambda_ri,rj=addToWlambda_rj,invMassi=getBodyInvMass(bi),invMassj=getBodyInvMass(bj),invIi=getBodyInvInertia(bi),invIj=getBodyInvInertia(bj),Mdiag=addToWlambda_Mdiag,G=this.G;Gi[0]=G[0];Gi[1]=G[1];Gj[0]=G[3];Gj[1]=G[4];vec2.scale(temp,Gi,invMassi*deltalambda);vec2.add(bi.vlambda,bi.vlambda,temp);bi.wlambda+=invIi*G[2]*deltalambda;vec2.scale(temp,Gj,invMassj*deltalambda);vec2.add(bj.vlambda,bj.vlambda,temp);bj.wlambda+=invIj*G[5]*deltalambda};Equation.prototype.computeInvC=function(eps){return 1/(this.computeGiMGt()+eps)}},{"../math/vec2":30,"../objects/Body":31,"../utils/Utils":45}],23:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),Equation=_dereq_("./Equation"),Utils=_dereq_("../utils/Utils");module.exports=FrictionEquation;function FrictionEquation(bodyA,bodyB,slipForce){Equation.call(this,bodyA,bodyB,-slipForce,slipForce);this.contactPointA=vec2.create();this.contactPointB=vec2.create();this.t=vec2.create();this.contactEquation=null;this.shapeA=null;this.shapeB=null;this.frictionCoefficient=.3}FrictionEquation.prototype=new Equation;FrictionEquation.prototype.constructor=FrictionEquation;FrictionEquation.prototype.setSlipForce=function(slipForce){this.maxForce=slipForce;this.minForce=-slipForce};FrictionEquation.prototype.getSlipForce=function(){return this.maxForce};FrictionEquation.prototype.computeB=function(a,b,h){var bi=this.bodyA,bj=this.bodyB,ri=this.contactPointA,rj=this.contactPointB,t=this.t,G=this.G;G[0]=-t[0];G[1]=-t[1];G[2]=-vec2.crossLength(ri,t);G[3]=t[0];G[4]=t[1];G[5]=vec2.crossLength(rj,t);var GW=this.computeGW(),GiMf=this.computeGiMf();var B=-GW*b-h*GiMf;return B}},{"../math/vec2":30,"../utils/Utils":45,"./Equation":22}],24:[function(_dereq_,module,exports){var Equation=_dereq_("./Equation"),vec2=_dereq_("../math/vec2");module.exports=RotationalLockEquation;function RotationalLockEquation(bodyA,bodyB,options){options=options||{};Equation.call(this,bodyA,bodyB,-Number.MAX_VALUE,Number.MAX_VALUE);this.angle=options.angle||0;var G=this.G;G[2]=1;G[5]=-1}RotationalLockEquation.prototype=new Equation;RotationalLockEquation.prototype.constructor=RotationalLockEquation;var worldVectorA=vec2.create(),worldVectorB=vec2.create(),xAxis=vec2.fromValues(1,0),yAxis=vec2.fromValues(0,1);RotationalLockEquation.prototype.computeGq=function(){vec2.rotate(worldVectorA,xAxis,this.bodyA.angle+this.angle);vec2.rotate(worldVectorB,yAxis,this.bodyB.angle);return vec2.dot(worldVectorA,worldVectorB)}},{"../math/vec2":30,"./Equation":22}],25:[function(_dereq_,module,exports){var Equation=_dereq_("./Equation"),vec2=_dereq_("../math/vec2");module.exports=RotationalVelocityEquation;function RotationalVelocityEquation(bodyA,bodyB){Equation.call(this,bodyA,bodyB,-Number.MAX_VALUE,Number.MAX_VALUE);this.relativeVelocity=1;this.ratio=1}RotationalVelocityEquation.prototype=new Equation;RotationalVelocityEquation.prototype.constructor=RotationalVelocityEquation;RotationalVelocityEquation.prototype.computeB=function(a,b,h){var G=this.G;G[2]=-1;G[5]=this.ratio;var GiMf=this.computeGiMf();var GW=this.computeGW();var B=-GW*b-h*GiMf;return B}},{"../math/vec2":30,"./Equation":22}],26:[function(_dereq_,module,exports){var EventEmitter=function(){};module.exports=EventEmitter;EventEmitter.prototype={constructor:EventEmitter,on:function(type,listener,context){listener.context=context||this;if(this._listeners===undefined)this._listeners={};var listeners=this._listeners;if(listeners[type]===undefined){listeners[type]=[]}if(listeners[type].indexOf(listener)===-1){listeners[type].push(listener)}return this},has:function(type,listener){if(this._listeners===undefined)return false;var listeners=this._listeners;if(listeners[type]!==undefined&&listeners[type].indexOf(listener)!==-1){return true}return false},off:function(type,listener){if(this._listeners===undefined)return this;var listeners=this._listeners;var index=listeners[type].indexOf(listener);if(index!==-1){listeners[type].splice(index,1)}return this},emit:function(event){if(this._listeners===undefined)return this;var listeners=this._listeners;var listenerArray=listeners[event.type];if(listenerArray!==undefined){event.target=this;for(var i=0,l=listenerArray.length;i<l;i++){var listener=listenerArray[i];listener.call(listener.context,event)}}return this}}},{}],27:[function(_dereq_,module,exports){var Material=_dereq_("./Material");var Equation=_dereq_("../equations/Equation");module.exports=ContactMaterial;function ContactMaterial(materialA,materialB,options){options=options||{};if(!(materialA instanceof Material)||!(materialB instanceof Material))throw new Error("First two arguments must be Material instances.");this.id=ContactMaterial.idCounter++;this.materialA=materialA;this.materialB=materialB;this.friction=typeof options.friction!=="undefined"?Number(options.friction):.3;this.restitution=typeof options.restitution!=="undefined"?Number(options.restitution):0;this.stiffness=typeof options.stiffness!=="undefined"?Number(options.stiffness):Equation.DEFAULT_STIFFNESS;this.relaxation=typeof options.relaxation!=="undefined"?Number(options.relaxation):Equation.DEFAULT_RELAXATION;this.frictionStiffness=typeof options.frictionStiffness!=="undefined"?Number(options.frictionStiffness):Equation.DEFAULT_STIFFNESS;this.frictionRelaxation=typeof options.frictionRelaxation!=="undefined"?Number(options.frictionRelaxation):Equation.DEFAULT_RELAXATION;this.surfaceVelocity=typeof options.surfaceVelocity!=="undefined"?Number(options.surfaceVelocity):0}ContactMaterial.idCounter=0},{"../equations/Equation":22,"./Material":28}],28:[function(_dereq_,module,exports){module.exports=Material;function Material(){this.id=Material.idCounter++}Material.idCounter=0},{}],29:[function(_dereq_,module,exports){var PolyK={};PolyK.GetArea=function(p){if(p.length<6)return 0;var l=p.length-2;var sum=0;for(var i=0;i<l;i+=2)sum+=(p[i+2]-p[i])*(p[i+1]+p[i+3]);sum+=(p[0]-p[l])*(p[l+1]+p[1]);return-sum*.5};PolyK.Triangulate=function(p){var n=p.length>>1;if(n<3)return[];var tgs=[];var avl=[];for(var i=0;i<n;i++)avl.push(i);var i=0;var al=n;while(al>3){var i0=avl[(i+0)%al];var i1=avl[(i+1)%al];var i2=avl[(i+2)%al];var ax=p[2*i0],ay=p[2*i0+1];var bx=p[2*i1],by=p[2*i1+1];var cx=p[2*i2],cy=p[2*i2+1];var earFound=false;if(PolyK._convex(ax,ay,bx,by,cx,cy)){earFound=true;for(var j=0;j<al;j++){var vi=avl[j];if(vi==i0||vi==i1||vi==i2)continue;if(PolyK._PointInTriangle(p[2*vi],p[2*vi+1],ax,ay,bx,by,cx,cy)){earFound=false;
break}}}if(earFound){tgs.push(i0,i1,i2);avl.splice((i+1)%al,1);al--;i=0}else if(i++>3*al)break}tgs.push(avl[0],avl[1],avl[2]);return tgs};PolyK._PointInTriangle=function(px,py,ax,ay,bx,by,cx,cy){var v0x=cx-ax;var v0y=cy-ay;var v1x=bx-ax;var v1y=by-ay;var v2x=px-ax;var v2y=py-ay;var dot00=v0x*v0x+v0y*v0y;var dot01=v0x*v1x+v0y*v1y;var dot02=v0x*v2x+v0y*v2y;var dot11=v1x*v1x+v1y*v1y;var dot12=v1x*v2x+v1y*v2y;var invDenom=1/(dot00*dot11-dot01*dot01);var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;return u>=0&&v>=0&&u+v<1};PolyK._convex=function(ax,ay,bx,by,cx,cy){return(ay-by)*(cx-bx)+(bx-ax)*(cy-by)>=0};module.exports=PolyK},{}],30:[function(_dereq_,module,exports){var vec2=_dereq_("../../build/vec2").vec2;vec2.crossLength=function(a,b){return a[0]*b[1]-a[1]*b[0]};vec2.crossVZ=function(out,vec,zcomp){vec2.rotate(out,vec,-Math.PI/2);vec2.scale(out,out,zcomp);return out};vec2.crossZV=function(out,zcomp,vec){vec2.rotate(out,vec,Math.PI/2);vec2.scale(out,out,zcomp);return out};vec2.rotate=function(out,a,angle){var c=Math.cos(angle),s=Math.sin(angle),x=a[0],y=a[1];out[0]=c*x-s*y;out[1]=s*x+c*y};vec2.toLocalFrame=function(out,worldPoint,framePosition,frameAngle){vec2.copy(out,worldPoint);vec2.sub(out,out,framePosition);vec2.rotate(out,out,-frameAngle)};vec2.toGlobalFrame=function(out,localPoint,framePosition,frameAngle){vec2.copy(out,localPoint);vec2.rotate(out,out,frameAngle);vec2.add(out,out,framePosition)};vec2.centroid=function(out,a,b,c){vec2.add(out,a,b);vec2.add(out,out,c);vec2.scale(out,out,1/3);return out};module.exports=vec2},{"../../build/vec2":1}],31:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),decomp=_dereq_("poly-decomp"),Convex=_dereq_("../shapes/Convex"),AABB=_dereq_("../collision/AABB"),EventEmitter=_dereq_("../events/EventEmitter");module.exports=Body;function Body(options){options=options||{};EventEmitter.call(this);this.id=++Body._idCounter;this.world=null;this.shapes=[];this.shapeOffsets=[];this.shapeAngles=[];this.mass=options.mass||0;this.invMass=0;this.inertia=0;this.invInertia=0;this.fixedRotation=!!options.fixedRotation||false;this.position=vec2.fromValues(0,0);if(options.position){vec2.copy(this.position,options.position)}this.interpolatedPosition=vec2.fromValues(0,0);this.interpolatedAngle=0;this.previousPosition=vec2.fromValues(0,0);this.previousAngle=0;this.velocity=vec2.fromValues(0,0);if(options.velocity){vec2.copy(this.velocity,options.velocity)}this.vlambda=vec2.fromValues(0,0);this.wlambda=0;this.angle=options.angle||0;this.angularVelocity=options.angularVelocity||0;this.force=vec2.create();if(options.force)vec2.copy(this.force,options.force);this.angularForce=options.angularForce||0;this.damping=typeof options.damping=="number"?options.damping:.1;this.angularDamping=typeof options.angularDamping=="number"?options.angularDamping:.1;this.motionState=this.mass===0?Body.STATIC:Body.DYNAMIC;this.boundingRadius=0;this.aabb=new AABB;this.aabbNeedsUpdate=true;this.allowSleep=true;this.wantsToSleep=false;this.sleepState=Body.AWAKE;this.sleepSpeedLimit=.2;this.sleepTimeLimit=1;this.gravityScale=1;this.timeLastSleepy=0;this.concavePath=null;this.lastDampingScale=1;this.lastAngularDampingScale=1;this.lastDampingTimeStep=-1;this.updateMassProperties()}Body.prototype=new EventEmitter;Body._idCounter=0;Body.prototype.setDensity=function(density){var totalArea=this.getArea();this.mass=totalArea*density;this.updateMassProperties()};Body.prototype.getArea=function(){var totalArea=0;for(var i=0;i<this.shapes.length;i++){totalArea+=this.shapes[i].area}return totalArea};var shapeAABB=new AABB,tmp=vec2.create();Body.prototype.updateAABB=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,shapeAngles=this.shapeAngles,N=shapes.length;for(var i=0;i!==N;i++){var shape=shapes[i],offset=tmp,angle=shapeAngles[i]+this.angle;vec2.rotate(offset,shapeOffsets[i],this.angle);vec2.add(offset,offset,this.position);shape.computeAABB(shapeAABB,offset,angle);if(i===0)this.aabb.copy(shapeAABB);else this.aabb.extend(shapeAABB)}this.aabbNeedsUpdate=false};Body.prototype.updateBoundingRadius=function(){var shapes=this.shapes,shapeOffsets=this.shapeOffsets,N=shapes.length,radius=0;for(var i=0;i!==N;i++){var shape=shapes[i],offset=vec2.length(shapeOffsets[i]),r=shape.boundingRadius;if(offset+r>radius){radius=offset+r}}this.boundingRadius=radius};Body.prototype.addShape=function(shape,offset,angle){angle=angle||0;if(offset){offset=vec2.fromValues(offset[0],offset[1])}else{offset=vec2.fromValues(0,0)}this.shapes.push(shape);this.shapeOffsets.push(offset);this.shapeAngles.push(angle);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=true};Body.prototype.removeShape=function(shape){var idx=this.shapes.indexOf(shape);if(idx!==-1){this.shapes.splice(idx,1);this.shapeOffsets.splice(idx,1);this.shapeAngles.splice(idx,1);this.aabbNeedsUpdate=true;return true}else{return false}};Body.prototype.updateMassProperties=function(){if(this.motionState===Body.STATIC||this.motionState===Body.KINEMATIC){this.mass=Number.MAX_VALUE;this.invMass=0;this.inertia=Number.MAX_VALUE;this.invInertia=0}else{var shapes=this.shapes,N=shapes.length,m=this.mass/N,I=0;if(!this.fixedRotation){for(var i=0;i<N;i++){var shape=shapes[i],r2=vec2.squaredLength(this.shapeOffsets[i]),Icm=shape.computeMomentOfInertia(m);I+=Icm+m*r2}this.inertia=I;this.invInertia=I>0?1/I:0}else{this.inertia=Number.MAX_VALUE;this.invInertia=0}this.invMass=1/this.mass}};var Body_applyForce_r=vec2.create();Body.prototype.applyForce=function(force,worldPoint){var r=Body_applyForce_r;vec2.sub(r,worldPoint,this.position);vec2.add(this.force,this.force,force);var rotForce=vec2.crossLength(r,force);this.angularForce+=rotForce};Body.prototype.toLocalFrame=function(out,worldPoint){vec2.toLocalFrame(out,worldPoint,this.position,this.angle)};Body.prototype.toWorldFrame=function(out,localPoint){vec2.toGlobalFrame(out,localPoint,this.position,this.angle)};Body.prototype.fromPolygon=function(path,options){options=options||{};for(var i=this.shapes.length;i>=0;--i)this.removeShape(this.shapes[i]);var p=new decomp.Polygon;p.vertices=path;p.makeCCW();if(typeof options.removeCollinearPoints=="number"){p.removeCollinearPoints(options.removeCollinearPoints)}if(typeof options.skipSimpleCheck=="undefined"){if(!p.isSimple())return false}this.concavePath=p.vertices.slice(0);for(var i=0;i<this.concavePath.length;i++){var v=[0,0];vec2.copy(v,this.concavePath[i]);this.concavePath[i]=v}var convexes;if(options.optimalDecomp)convexes=p.decomp();else convexes=p.quickDecomp();var cm=vec2.create();for(var i=0;i!==convexes.length;i++){var c=new Convex(convexes[i].vertices);for(var j=0;j!==c.vertices.length;j++){var v=c.vertices[j];vec2.sub(v,v,c.centerOfMass)}vec2.scale(cm,c.centerOfMass,1);c.updateTriangles();c.updateCenterOfMass();c.updateBoundingRadius();this.addShape(c,cm)}this.adjustCenterOfMass();this.aabbNeedsUpdate=true;return true};var adjustCenterOfMass_tmp1=vec2.fromValues(0,0),adjustCenterOfMass_tmp2=vec2.fromValues(0,0),adjustCenterOfMass_tmp3=vec2.fromValues(0,0),adjustCenterOfMass_tmp4=vec2.fromValues(0,0);Body.prototype.adjustCenterOfMass=function(){var offset_times_area=adjustCenterOfMass_tmp2,sum=adjustCenterOfMass_tmp3,cm=adjustCenterOfMass_tmp4,totalArea=0;vec2.set(sum,0,0);for(var i=0;i!==this.shapes.length;i++){var s=this.shapes[i],offset=this.shapeOffsets[i];vec2.scale(offset_times_area,offset,s.area);vec2.add(sum,sum,offset_times_area);totalArea+=s.area}vec2.scale(cm,sum,1/totalArea);for(var i=0;i!==this.shapes.length;i++){var s=this.shapes[i],offset=this.shapeOffsets[i];if(!offset){offset=this.shapeOffsets[i]=vec2.create()}vec2.sub(offset,offset,cm)}vec2.add(this.position,this.position,cm);for(var i=0;this.concavePath&&i<this.concavePath.length;i++){vec2.sub(this.concavePath[i],this.concavePath[i],cm)}this.updateMassProperties();this.updateBoundingRadius()};Body.prototype.setZeroForce=function(){vec2.set(this.force,0,0);this.angularForce=0};Body.prototype.resetConstraintVelocity=function(){var b=this,vlambda=b.vlambda;vec2.set(vlambda,0,0);b.wlambda=0};Body.prototype.addConstraintVelocity=function(){var b=this,v=b.velocity;vec2.add(v,v,b.vlambda);b.angularVelocity+=b.wlambda};Body.prototype.applyDamping=function(dt){if(this.motionState===Body.DYNAMIC){if(dt!==this.lastDampingTimeStep){this.lastDampingScale=Math.pow(1-this.damping,dt);this.lastAngularDampingScale=Math.pow(1-this.angularDamping,dt);this.lastDampingTimeStep=dt}var v=this.velocity;vec2.scale(v,v,this.lastDampingScale);this.angularVelocity*=this.lastAngularDampingScale}};Body.prototype.wakeUp=function(){var s=this.sleepState;this.sleepState=Body.AWAKE;this.idleTime=0;if(s!==Body.AWAKE){this.emit(Body.wakeUpEvent)}};Body.prototype.sleep=function(){this.sleepState=Body.SLEEPING;this.angularVelocity=0;this.angularForce=0;vec2.set(this.velocity,0,0);vec2.set(this.force,0,0);this.emit(Body.sleepEvent)};Body.prototype.sleepTick=function(time,dontSleep,dt){if(!this.allowSleep||this.motionState===Body.SLEEPING){return}this.wantsToSleep=false;var sleepState=this.sleepState,speedSquared=vec2.squaredLength(this.velocity)+Math.pow(this.angularVelocity,2),speedLimitSquared=Math.pow(this.sleepSpeedLimit,2);if(speedSquared>=speedLimitSquared){this.idleTime=0;this.sleepState=Body.AWAKE}else{this.idleTime+=dt;this.sleepState=Body.SLEEPY}if(this.idleTime>this.sleepTimeLimit){if(!dontSleep){this.sleep()}else{this.wantsToSleep=true}}};Body.prototype.getVelocityFromPosition=function(store,timeStep){store=store||vec2.create();vec2.sub(store,this.position,this.previousPosition);vec2.scale(store,store,1/timeStep);return store};Body.prototype.getAngularVelocityFromPosition=function(timeStep){return(this.angle-this.previousAngle)/timeStep};Body.sleepyEvent={type:"sleepy"};Body.sleepEvent={type:"sleep"};Body.wakeUpEvent={type:"wakeup"};Body.DYNAMIC=1;Body.STATIC=2;Body.KINEMATIC=4;Body.AWAKE=0;Body.SLEEPY=1;Body.SLEEPING=2},{"../collision/AABB":8,"../events/EventEmitter":26,"../math/vec2":30,"../shapes/Convex":36,"poly-decomp":6}],32:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2");module.exports=Spring;function Spring(bodyA,bodyB,options){options=options||{};this.restLength=typeof options.restLength=="number"?options.restLength:1;this.stiffness=options.stiffness||100;this.damping=options.damping||1;this.bodyA=bodyA;this.bodyB=bodyB;this.localAnchorA=vec2.fromValues(0,0);this.localAnchorB=vec2.fromValues(0,0);if(options.localAnchorA)vec2.copy(this.localAnchorA,options.localAnchorA);if(options.localAnchorB)vec2.copy(this.localAnchorB,options.localAnchorB);if(options.worldAnchorA)this.setWorldAnchorA(options.worldAnchorA);if(options.worldAnchorB)this.setWorldAnchorB(options.worldAnchorB)}Spring.prototype.setWorldAnchorA=function(worldAnchorA){this.bodyA.toLocalFrame(this.localAnchorA,worldAnchorA)};Spring.prototype.setWorldAnchorB=function(worldAnchorB){this.bodyB.toLocalFrame(this.localAnchorB,worldAnchorB)};Spring.prototype.getWorldAnchorA=function(result){this.bodyA.toWorldFrame(result,this.localAnchorA)};Spring.prototype.getWorldAnchorB=function(result){this.bodyB.toWorldFrame(result,this.localAnchorB)};var applyForce_r=vec2.create(),applyForce_r_unit=vec2.create(),applyForce_u=vec2.create(),applyForce_f=vec2.create(),applyForce_worldAnchorA=vec2.create(),applyForce_worldAnchorB=vec2.create(),applyForce_ri=vec2.create(),applyForce_rj=vec2.create(),applyForce_tmp=vec2.create();Spring.prototype.applyForce=function(){var k=this.stiffness,d=this.damping,l=this.restLength,bodyA=this.bodyA,bodyB=this.bodyB,r=applyForce_r,r_unit=applyForce_r_unit,u=applyForce_u,f=applyForce_f,tmp=applyForce_tmp;var worldAnchorA=applyForce_worldAnchorA,worldAnchorB=applyForce_worldAnchorB,ri=applyForce_ri,rj=applyForce_rj;this.getWorldAnchorA(worldAnchorA);this.getWorldAnchorB(worldAnchorB);vec2.sub(ri,worldAnchorA,bodyA.position);vec2.sub(rj,worldAnchorB,bodyB.position);vec2.sub(r,worldAnchorB,worldAnchorA);var rlen=vec2.len(r);vec2.normalize(r_unit,r);vec2.sub(u,bodyB.velocity,bodyA.velocity);vec2.crossZV(tmp,bodyB.angularVelocity,rj);vec2.add(u,u,tmp);vec2.crossZV(tmp,bodyA.angularVelocity,ri);vec2.sub(u,u,tmp);vec2.scale(f,r_unit,-k*(rlen-l)-d*vec2.dot(u,r_unit));vec2.sub(bodyA.force,bodyA.force,f);vec2.add(bodyB.force,bodyB.force,f);var ri_x_f=vec2.crossLength(ri,f);var rj_x_f=vec2.crossLength(rj,f);bodyA.angularForce-=ri_x_f;bodyB.angularForce+=rj_x_f}},{"../math/vec2":30}],33:[function(_dereq_,module,exports){module.exports={AABB:_dereq_("./collision/AABB"),AngleLockEquation:_dereq_("./equations/AngleLockEquation"),Body:_dereq_("./objects/Body"),Broadphase:_dereq_("./collision/Broadphase"),Capsule:_dereq_("./shapes/Capsule"),Circle:_dereq_("./shapes/Circle"),Constraint:_dereq_("./constraints/Constraint"),ContactEquation:_dereq_("./equations/ContactEquation"),ContactMaterial:_dereq_("./material/ContactMaterial"),Convex:_dereq_("./shapes/Convex"),DistanceConstraint:_dereq_("./constraints/DistanceConstraint"),Equation:_dereq_("./equations/Equation"),EventEmitter:_dereq_("./events/EventEmitter"),FrictionEquation:_dereq_("./equations/FrictionEquation"),GearConstraint:_dereq_("./constraints/GearConstraint"),GridBroadphase:_dereq_("./collision/GridBroadphase"),GSSolver:_dereq_("./solver/GSSolver"),Heightfield:_dereq_("./shapes/Heightfield"),Line:_dereq_("./shapes/Line"),LockConstraint:_dereq_("./constraints/LockConstraint"),Material:_dereq_("./material/Material"),Narrowphase:_dereq_("./collision/Narrowphase"),NaiveBroadphase:_dereq_("./collision/NaiveBroadphase"),Particle:_dereq_("./shapes/Particle"),Plane:_dereq_("./shapes/Plane"),RevoluteConstraint:_dereq_("./constraints/RevoluteConstraint"),PrismaticConstraint:_dereq_("./constraints/PrismaticConstraint"),Rectangle:_dereq_("./shapes/Rectangle"),RotationalVelocityEquation:_dereq_("./equations/RotationalVelocityEquation"),SAPBroadphase:_dereq_("./collision/SAPBroadphase"),Shape:_dereq_("./shapes/Shape"),Solver:_dereq_("./solver/Solver"),Spring:_dereq_("./objects/Spring"),Utils:_dereq_("./utils/Utils"),World:_dereq_("./world/World"),vec2:_dereq_("./math/vec2"),version:_dereq_("../package.json").version}},{"../package.json":7,"./collision/AABB":8,"./collision/Broadphase":9,"./collision/GridBroadphase":10,"./collision/NaiveBroadphase":11,"./collision/Narrowphase":12,"./collision/SAPBroadphase":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/GearConstraint":16,"./constraints/LockConstraint":17,"./constraints/PrismaticConstraint":18,"./constraints/RevoluteConstraint":19,"./equations/AngleLockEquation":20,"./equations/ContactEquation":21,"./equations/Equation":22,"./equations/FrictionEquation":23,"./equations/RotationalVelocityEquation":25,"./events/EventEmitter":26,"./material/ContactMaterial":27,"./material/Material":28,"./math/vec2":30,"./objects/Body":31,"./objects/Spring":32,"./shapes/Capsule":34,"./shapes/Circle":35,"./shapes/Convex":36,"./shapes/Heightfield":37,"./shapes/Line":38,"./shapes/Particle":39,"./shapes/Plane":40,"./shapes/Rectangle":41,"./shapes/Shape":42,"./solver/GSSolver":43,"./solver/Solver":44,"./utils/Utils":45,"./world/World":49}],34:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2");module.exports=Capsule;function Capsule(length,radius){this.length=length||1;this.radius=radius||1;Shape.call(this,Shape.CAPSULE)}Capsule.prototype=new Shape;Capsule.prototype.computeMomentOfInertia=function(mass){var r=this.radius,w=this.length+r,h=r*2;return mass*(h*h+w*w)/12};Capsule.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius+this.length/2};Capsule.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius+this.radius*2*this.length};var r=vec2.create();Capsule.prototype.computeAABB=function(out,position,angle){var radius=this.radius;vec2.set(r,this.length,0);vec2.rotate(r,r,angle);vec2.set(out.upperBound,Math.max(r[0]+radius,-r[0]+radius),Math.max(r[1]+radius,-r[1]+radius));vec2.set(out.lowerBound,Math.min(r[0]-radius,-r[0]-radius),Math.min(r[1]-radius,-r[1]-radius));vec2.add(out.lowerBound,out.lowerBound,position);vec2.add(out.upperBound,out.upperBound,position)}},{"../math/vec2":30,"./Shape":42}],35:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2");module.exports=Circle;function Circle(radius){this.radius=radius||1;Shape.call(this,Shape.CIRCLE)}Circle.prototype=new Shape;Circle.prototype.computeMomentOfInertia=function(mass){var r=this.radius;return mass*r*r/2};Circle.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius};Circle.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius};Circle.prototype.computeAABB=function(out,position,angle){var r=this.radius;vec2.set(out.upperBound,r,r);vec2.set(out.lowerBound,-r,-r);if(position){vec2.add(out.lowerBound,out.lowerBound,position);vec2.add(out.upperBound,out.upperBound,position)}}},{"../math/vec2":30,"./Shape":42}],36:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2"),polyk=_dereq_("../math/polyk"),decomp=_dereq_("poly-decomp");module.exports=Convex;function Convex(vertices){this.vertices=[];for(var i=0;i<vertices.length;i++){var v=vec2.create();vec2.copy(v,vertices[i]);this.vertices.push(v)}this.centerOfMass=vec2.fromValues(0,0);this.triangles=[];if(this.vertices.length){this.updateTriangles();this.updateCenterOfMass()}this.boundingRadius=0;Shape.call(this,Shape.CONVEX);this.updateBoundingRadius();this.updateArea();if(this.area<0)throw new Error("Convex vertices must be given in conter-clockwise winding.")}Convex.prototype=new Shape;Convex.prototype.updateTriangles=function(){this.triangles.length=0;var polykVerts=[];for(var i=0;i<this.vertices.length;i++){var v=this.vertices[i];polykVerts.push(v[0],v[1])}var triangles=polyk.Triangulate(polykVerts);for(var i=0;i<triangles.length;i+=3){var id1=triangles[i],id2=triangles[i+1],id3=triangles[i+2];this.triangles.push([id1,id2,id3])}};var updateCenterOfMass_centroid=vec2.create(),updateCenterOfMass_centroid_times_mass=vec2.create(),updateCenterOfMass_a=vec2.create(),updateCenterOfMass_b=vec2.create(),updateCenterOfMass_c=vec2.create(),updateCenterOfMass_ac=vec2.create(),updateCenterOfMass_ca=vec2.create(),updateCenterOfMass_cb=vec2.create(),updateCenterOfMass_n=vec2.create();Convex.prototype.updateCenterOfMass=function(){var triangles=this.triangles,verts=this.vertices,cm=this.centerOfMass,centroid=updateCenterOfMass_centroid,n=updateCenterOfMass_n,a=updateCenterOfMass_a,b=updateCenterOfMass_b,c=updateCenterOfMass_c,ac=updateCenterOfMass_ac,ca=updateCenterOfMass_ca,cb=updateCenterOfMass_cb,centroid_times_mass=updateCenterOfMass_centroid_times_mass;vec2.set(cm,0,0);var totalArea=0;for(var i=0;i!==triangles.length;i++){var t=triangles[i],a=verts[t[0]],b=verts[t[1]],c=verts[t[2]];vec2.centroid(centroid,a,b,c);var m=Convex.triangleArea(a,b,c);totalArea+=m;vec2.scale(centroid_times_mass,centroid,m);vec2.add(cm,cm,centroid_times_mass)}vec2.scale(cm,cm,1/totalArea)};Convex.prototype.computeMomentOfInertia=function(mass){var denom=0,numer=0,N=this.vertices.length;for(var j=N-1,i=0;i<N;j=i,i++){var p0=this.vertices[j];var p1=this.vertices[i];var a=Math.abs(vec2.crossLength(p0,p1));var b=vec2.dot(p1,p1)+vec2.dot(p1,p0)+vec2.dot(p0,p0);denom+=a*b;numer+=a}return mass/6*(denom/numer)};Convex.prototype.updateBoundingRadius=function(){var verts=this.vertices,r2=0;for(var i=0;i!==verts.length;i++){var l2=vec2.squaredLength(verts[i]);if(l2>r2)r2=l2}this.boundingRadius=Math.sqrt(r2)};Convex.triangleArea=function(a,b,c){return((b[0]-a[0])*(c[1]-a[1])-(c[0]-a[0])*(b[1]-a[1]))*.5};Convex.prototype.updateArea=function(){this.updateTriangles();this.area=0;var triangles=this.triangles,verts=this.vertices;for(var i=0;i!==triangles.length;i++){var t=triangles[i],a=verts[t[0]],b=verts[t[1]],c=verts[t[2]];var m=Convex.triangleArea(a,b,c);this.area+=m}};Convex.prototype.computeAABB=function(out,position,angle){out.setFromPoints(this.vertices,position,angle)}},{"../math/polyk":29,"../math/vec2":30,"./Shape":42,"poly-decomp":6}],37:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2");module.exports=Heightfield;function Heightfield(data,maxValue,elementWidth){this.data=data;this.maxValue=maxValue;this.elementWidth=elementWidth;Shape.call(this,Shape.HEIGHTFIELD)}Heightfield.prototype=new Shape;Heightfield.prototype.computeMomentOfInertia=function(mass){return Number.MAX_VALUE};Heightfield.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};Heightfield.prototype.updateArea=function(){var data=this.data,area=0;for(var i=0;i<data.length-1;i++){area+=(data[i]+data[i+1])/2*this.elementWidth}this.area=area};Heightfield.prototype.computeAABB=function(out,position,angle){out.upperBound[0]=this.elementWidth*this.data.length+position[0];out.upperBound[1]=this.maxValue+position[1];out.lowerBound[0]=position[0];out.lowerBound[1]=-Number.MAX_VALUE}},{"../math/vec2":30,"./Shape":42}],38:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2");module.exports=Line;function Line(length){this.length=length;Shape.call(this,Shape.LINE)}Line.prototype=new Shape;Line.prototype.computeMomentOfInertia=function(mass){return mass*Math.pow(this.length,2)/12};Line.prototype.updateBoundingRadius=function(){this.boundingRadius=this.length/2};var points=[vec2.create(),vec2.create()];Line.prototype.computeAABB=function(out,position,angle){var l=this.length;vec2.set(points[0],-l/2,0);vec2.set(points[1],l/2,0);out.setFromPoints(points,position,angle)}},{"../math/vec2":30,"./Shape":42}],39:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2");module.exports=Particle;function Particle(){Shape.call(this,Shape.PARTICLE)}Particle.prototype=new Shape;Particle.prototype.computeMomentOfInertia=function(mass){return 0};Particle.prototype.updateBoundingRadius=function(){this.boundingRadius=0};Particle.prototype.computeAABB=function(out,position,angle){var l=this.length;vec2.copy(out.lowerBound,position);vec2.copy(out.upperBound,position)}},{"../math/vec2":30,"./Shape":42}],40:[function(_dereq_,module,exports){var Shape=_dereq_("./Shape"),vec2=_dereq_("../math/vec2"),Utils=_dereq_("../utils/Utils");module.exports=Plane;function Plane(){Shape.call(this,Shape.PLANE)}Plane.prototype=new Shape;Plane.prototype.computeMomentOfInertia=function(mass){return 0};Plane.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};Plane.prototype.computeAABB=function(out,position,angle){var a=0,set=vec2.set;if(typeof angle=="number")a=angle%(2*Math.PI);if(a==0){set(out.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE);set(out.upperBound,Number.MAX_VALUE,0)}else if(a==Math.PI/2){set(out.lowerBound,0,-Number.MAX_VALUE);set(out.upperBound,Number.MAX_VALUE,Number.MAX_VALUE)}else if(a==Math.PI){set(out.lowerBound,-Number.MAX_VALUE,0);set(out.upperBound,Number.MAX_VALUE,Number.MAX_VALUE)}else if(a==3*Math.PI/2){set(out.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE);set(out.upperBound,0,Number.MAX_VALUE)}else{set(out.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE);set(out.upperBound,Number.MAX_VALUE,Number.MAX_VALUE)}vec2.add(out.lowerBound,out.lowerBound,position);vec2.add(out.upperBound,out.upperBound,position)};Plane.prototype.updateArea=function(){this.area=Number.MAX_VALUE}},{"../math/vec2":30,"../utils/Utils":45,"./Shape":42}],41:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),Shape=_dereq_("./Shape"),Convex=_dereq_("./Convex");module.exports=Rectangle;function Rectangle(w,h){var verts=[vec2.fromValues(-w/2,-h/2),vec2.fromValues(w/2,-h/2),vec2.fromValues(w/2,h/2),vec2.fromValues(-w/2,h/2)];this.width=w;this.height=h;Convex.call(this,verts);this.type=Shape.RECTANGLE}Rectangle.prototype=new Convex([]);Rectangle.prototype.computeMomentOfInertia=function(mass){var w=this.width,h=this.height;return mass*(h*h+w*w)/12};Rectangle.prototype.updateBoundingRadius=function(){var w=this.width,h=this.height;this.boundingRadius=Math.sqrt(w*w+h*h)/2};var corner1=vec2.create(),corner2=vec2.create(),corner3=vec2.create(),corner4=vec2.create();Rectangle.prototype.computeAABB=function(out,position,angle){out.setFromPoints(this.vertices,position,angle)};Rectangle.prototype.updateArea=function(){this.area=this.width*this.height}},{"../math/vec2":30,"./Convex":36,"./Shape":42}],42:[function(_dereq_,module,exports){module.exports=Shape;function Shape(type){this.type=type;this.id=Shape.idCounter++;this.boundingRadius=0;this.collisionGroup=1;this.collisionMask=1;if(type)this.updateBoundingRadius();this.material=null;this.area=0;this.sensor=false;this.updateArea()}Shape.idCounter=0;Shape.CIRCLE=1;Shape.PARTICLE=2;Shape.PLANE=4;Shape.CONVEX=8;Shape.LINE=16;Shape.RECTANGLE=32;Shape.CAPSULE=64;Shape.HEIGHTFIELD=128;Shape.prototype.computeMomentOfInertia=function(mass){throw new Error("Shape.computeMomentOfInertia is not implemented in this Shape...")};Shape.prototype.updateBoundingRadius=function(){throw new Error("Shape.updateBoundingRadius is not implemented in this Shape...")};Shape.prototype.updateArea=function(){};Shape.prototype.computeAABB=function(out,position,angle){}},{}],43:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),Solver=_dereq_("./Solver"),Utils=_dereq_("../utils/Utils"),FrictionEquation=_dereq_("../equations/FrictionEquation");module.exports=GSSolver;function GSSolver(options){Solver.call(this,options,Solver.GS);options=options||{};this.iterations=options.iterations||10;this.tolerance=options.tolerance||1e-10;this.arrayStep=30;this.lambda=new Utils.ARRAY_TYPE(this.arrayStep);this.Bs=new Utils.ARRAY_TYPE(this.arrayStep);this.invCs=new Utils.ARRAY_TYPE(this.arrayStep);this.useZeroRHS=false;this.frictionIterations=0;this.usedIterations=0}GSSolver.prototype=new Solver;function setArrayZero(array){for(var i=0;i!==array.length;i++){array[i]=0}}GSSolver.prototype.solve=function(h,world){this.sortEquations();var iter=0,maxIter=this.iterations,maxFrictionIter=this.frictionIterations,equations=this.equations,Neq=equations.length,tolSquared=Math.pow(this.tolerance*Neq,2),bodies=world.bodies,Nbodies=world.bodies.length,add=vec2.add,set=vec2.set,useZeroRHS=this.useZeroRHS,lambda=this.lambda;this.usedIterations=0;if(lambda.length<Neq){lambda=this.lambda=new Utils.ARRAY_TYPE(Neq+this.arrayStep);this.Bs=new Utils.ARRAY_TYPE(Neq+this.arrayStep);this.invCs=new Utils.ARRAY_TYPE(Neq+this.arrayStep)}setArrayZero(lambda);var invCs=this.invCs,Bs=this.Bs,lambda=this.lambda;for(var i=0;i!==equations.length;i++){var c=equations[i];if(c.timeStep!==h||c.needsUpdate){c.timeStep=h;c.update()}Bs[i]=c.computeB(c.a,c.b,h);invCs[i]=c.computeInvC(c.epsilon)}var q,B,c,deltalambdaTot,i,j;if(Neq!==0){for(i=0;i!==Nbodies;i++){bodies[i].resetConstraintVelocity()}if(maxFrictionIter){for(iter=0;iter!==maxFrictionIter;iter++){deltalambdaTot=0;for(j=0;j!==Neq;j++){c=equations[j];if(c instanceof FrictionEquation){}var deltalambda=GSSolver.iterateEquation(j,c,c.epsilon,Bs,invCs,lambda,useZeroRHS,h,iter);deltalambdaTot+=Math.abs(deltalambda)}this.usedIterations++;if(deltalambdaTot*deltalambdaTot<=tolSquared){break}}for(j=0;j!==Neq;j++){var eq=equations[j];if(eq instanceof FrictionEquation){var f=eq.contactEquation.multiplier*eq.frictionCoefficient;eq.maxForce=f;eq.minForce=-f}}}for(iter=0;iter!==maxIter;iter++){deltalambdaTot=0;for(j=0;j!==Neq;j++){c=equations[j];var deltalambda=GSSolver.iterateEquation(j,c,c.epsilon,Bs,invCs,lambda,useZeroRHS,h,iter);deltalambdaTot+=Math.abs(deltalambda)}this.usedIterations++;if(deltalambdaTot*deltalambdaTot<=tolSquared){break}}for(i=0;i!==Nbodies;i++){bodies[i].addConstraintVelocity()}}};GSSolver.iterateEquation=function(j,eq,eps,Bs,invCs,lambda,useZeroRHS,dt,iter){var B=Bs[j],invC=invCs[j],lambdaj=lambda[j],GWlambda=eq.computeGWlambda();var maxForce=eq.maxForce,minForce=eq.minForce;if(useZeroRHS){B=0}var deltalambda=invC*(B-GWlambda-eps*lambdaj);var lambdaj_plus_deltalambda=lambdaj+deltalambda;if(lambdaj_plus_deltalambda<minForce*dt){deltalambda=minForce*dt-lambdaj}else if(lambdaj_plus_deltalambda>maxForce*dt){deltalambda=maxForce*dt-lambdaj}lambda[j]+=deltalambda;eq.multiplier=lambda[j]/dt;eq.addToWlambda(deltalambda);return deltalambda}},{"../equations/FrictionEquation":23,"../math/vec2":30,"../utils/Utils":45,"./Solver":44}],44:[function(_dereq_,module,exports){var Utils=_dereq_("../utils/Utils"),EventEmitter=_dereq_("../events/EventEmitter");module.exports=Solver;function Solver(options,type){options=options||{};EventEmitter.call(this);this.type=type;this.equations=[];this.equationSortFunction=options.equationSortFunction||false}Solver.prototype=new EventEmitter;Solver.prototype.solve=function(dt,world){throw new Error("Solver.solve should be implemented by subclasses!")};var mockWorld={bodies:[]};Solver.prototype.solveIsland=function(dt,island){this.removeAllEquations();if(island.equations.length){this.addEquations(island.equations);mockWorld.bodies.length=0;island.getBodies(mockWorld.bodies);if(mockWorld.bodies.length){this.solve(dt,mockWorld)}}};Solver.prototype.sortEquations=function(){if(this.equationSortFunction){this.equations.sort(this.equationSortFunction)}};Solver.prototype.addEquation=function(eq){if(eq.enabled){this.equations.push(eq)}};Solver.prototype.addEquations=function(eqs){for(var i=0,N=eqs.length;i!==N;i++){var eq=eqs[i];if(eq.enabled){this.equations.push(eq)}}};Solver.prototype.removeEquation=function(eq){var i=this.equations.indexOf(eq);if(i!==-1){this.equations.splice(i,1)}};Solver.prototype.removeAllEquations=function(){this.equations.length=0};Solver.GS=1;Solver.ISLAND=2},{"../events/EventEmitter":26,"../utils/Utils":45}],45:[function(_dereq_,module,exports){module.exports=Utils;function Utils(){}Utils.appendArray=function(a,b){if(b.length<15e4){a.push.apply(a,b)}else{for(var i=0,len=b.length;i!==len;++i){a.push(b[i])}}};Utils.splice=function(array,index,howmany){howmany=howmany||1;for(var i=index,len=array.length-howmany;i<len;i++){array[i]=array[i+howmany]}array.length=len};Utils.ARRAY_TYPE=Float32Array||Array;Utils.extend=function(a,b){for(var key in b){a[key]=b[key]}}},{}],46:[function(_dereq_,module,exports){var Body=_dereq_("../objects/Body");module.exports=Island;function Island(){this.equations=[];this.bodies=[]}Island.prototype.reset=function(){this.equations.length=this.bodies.length=0};var bodyIds=[];Island.prototype.getBodies=function(result){var bodies=result||[],eqs=this.equations;bodyIds.length=0;for(var i=0;i!==eqs.length;i++){var eq=eqs[i];if(bodyIds.indexOf(eq.bodyA.id)===-1){bodies.push(eq.bodyA);bodyIds.push(eq.bodyA.id)}if(bodyIds.indexOf(eq.bodyB.id)===-1){bodies.push(eq.bodyB);bodyIds.push(eq.bodyB.id)}}return bodies};Island.prototype.wantsToSleep=function(){for(var i=0;i<this.bodies.length;i++){var b=this.bodies[i];if(b.motionState===Body.DYNAMIC&&!b.wantsToSleep){return false}}return true};Island.prototype.sleep=function(){for(var i=0;i<this.bodies.length;i++){var b=this.bodies[i];b.sleep()}return true}},{"../objects/Body":31}],47:[function(_dereq_,module,exports){var vec2=_dereq_("../math/vec2"),Island=_dereq_("./Island"),IslandNode=_dereq_("./IslandNode"),Body=_dereq_("../objects/Body");module.exports=IslandManager;function IslandManager(options){this._nodePool=[];this._islandPool=[];this.equations=[];this.islands=[];this.nodes=[];this.queue=[]}IslandManager.getUnvisitedNode=function(nodes){var Nnodes=nodes.length;for(var i=0;i!==Nnodes;i++){var node=nodes[i];if(!node.visited&&node.body.motionState===Body.DYNAMIC){return node}}return false};IslandManager.prototype.visit=function(node,bds,eqs){bds.push(node.body);var Neqs=node.equations.length;for(var i=0;i!==Neqs;i++){var eq=node.equations[i];if(eqs.indexOf(eq)===-1){eqs.push(eq)}}};IslandManager.prototype.bfs=function(root,bds,eqs){var queue=this.queue;queue.length=0;queue.push(root);root.visited=true;this.visit(root,bds,eqs);while(queue.length){var node=queue.pop();var child;
while(child=IslandManager.getUnvisitedNode(node.neighbors)){child.visited=true;this.visit(child,bds,eqs);if(child.body.motionState===Body.DYNAMIC){queue.push(child)}}}};IslandManager.prototype.split=function(world){var bodies=world.bodies,nodes=this.nodes,equations=this.equations;while(nodes.length){this._nodePool.push(nodes.pop())}for(var i=0;i!==bodies.length;i++){if(this._nodePool.length){var node=this._nodePool.pop();node.reset();node.body=bodies[i];nodes.push(node)}else{nodes.push(new IslandNode(bodies[i]))}}for(var k=0;k!==equations.length;k++){var eq=equations[k],i=bodies.indexOf(eq.bodyA),j=bodies.indexOf(eq.bodyB),ni=nodes[i],nj=nodes[j];ni.neighbors.push(nj);nj.neighbors.push(ni);ni.equations.push(eq);nj.equations.push(eq)}var islands=this.islands;while(islands.length){var island=islands.pop();island.reset();this._islandPool.push(island)}var child;while(child=IslandManager.getUnvisitedNode(nodes)){var island=this._islandPool.length?this._islandPool.pop():new Island;this.bfs(child,island.bodies,island.equations);islands.push(island)}return islands}},{"../math/vec2":30,"../objects/Body":31,"./Island":46,"./IslandNode":48}],48:[function(_dereq_,module,exports){module.exports=IslandNode;function IslandNode(body){this.body=body;this.neighbors=[];this.equations=[];this.visited=false}IslandNode.prototype.reset=function(){this.equations.length=0;this.neighbors.length=0;this.visited=false;this.body=null}},{}],49:[function(_dereq_,module,exports){var GSSolver=_dereq_("../solver/GSSolver"),Solver=_dereq_("../solver/Solver"),NaiveBroadphase=_dereq_("../collision/NaiveBroadphase"),vec2=_dereq_("../math/vec2"),Circle=_dereq_("../shapes/Circle"),Rectangle=_dereq_("../shapes/Rectangle"),Convex=_dereq_("../shapes/Convex"),Line=_dereq_("../shapes/Line"),Plane=_dereq_("../shapes/Plane"),Capsule=_dereq_("../shapes/Capsule"),Particle=_dereq_("../shapes/Particle"),EventEmitter=_dereq_("../events/EventEmitter"),Body=_dereq_("../objects/Body"),Shape=_dereq_("../shapes/Shape"),Spring=_dereq_("../objects/Spring"),Material=_dereq_("../material/Material"),ContactMaterial=_dereq_("../material/ContactMaterial"),DistanceConstraint=_dereq_("../constraints/DistanceConstraint"),Constraint=_dereq_("../constraints/Constraint"),LockConstraint=_dereq_("../constraints/LockConstraint"),RevoluteConstraint=_dereq_("../constraints/RevoluteConstraint"),PrismaticConstraint=_dereq_("../constraints/PrismaticConstraint"),GearConstraint=_dereq_("../constraints/GearConstraint"),pkg=_dereq_("../../package.json"),Broadphase=_dereq_("../collision/Broadphase"),SAPBroadphase=_dereq_("../collision/SAPBroadphase"),Narrowphase=_dereq_("../collision/Narrowphase"),Utils=_dereq_("../utils/Utils"),IslandManager=_dereq_("./IslandManager");module.exports=World;if(typeof performance==="undefined"){performance={}}if(!performance.now){var nowOffset=Date.now();if(performance.timing&&performance.timing.navigationStart){nowOffset=performance.timing.navigationStart}performance.now=function(){return Date.now()-nowOffset}}function World(options){EventEmitter.apply(this);options=options||{};this.springs=[];this.bodies=[];this.disabledBodyCollisionPairs=[];this.solver=options.solver||new GSSolver;this.narrowphase=new Narrowphase(this);this.islandManager=new IslandManager;this.gravity=options.gravity||vec2.fromValues(0,-9.78);this.frictionGravity=vec2.length(this.gravity)||10;this.useWorldGravityAsFrictionGravity=true;this.useFrictionGravityOnZeroGravity=true;this.doProfiling=options.doProfiling||false;this.lastStepTime=0;this.broadphase=options.broadphase||new NaiveBroadphase;this.broadphase.setWorld(this);this.constraints=[];this.defaultMaterial=new Material;this.defaultContactMaterial=new ContactMaterial(this.defaultMaterial,this.defaultMaterial);this.lastTimeStep=1/60;this.applySpringForces=true;this.applyDamping=true;this.applyGravity=true;this.solveConstraints=true;this.contactMaterials=[];this.time=0;this.stepping=false;this.bodiesToBeRemoved=[];this.fixedStepTime=0;this.islandSplit=typeof options.islandSplit!=="undefined"?!!options.islandSplit:false;this.emitImpactEvent=true;this._constraintIdCounter=0;this._bodyIdCounter=0;this.postStepEvent={type:"postStep"};this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null};this.addSpringEvent={type:"addSpring",spring:null};this.impactEvent={type:"impact",bodyA:null,bodyB:null,shapeA:null,shapeB:null,contactEquation:null};this.postBroadphaseEvent={type:"postBroadphase",pairs:null};this.enableBodySleeping=false;this.enableIslandSleeping=false;this.beginContactEvent={type:"beginContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null,contactEquations:[]};this.endContactEvent={type:"endContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null};this.preSolveEvent={type:"preSolve",contactEquations:null,frictionEquations:null};this.overlappingShapesLastState={keys:[]};this.overlappingShapesCurrentState={keys:[]};this.overlappingShapeLookup={keys:[]}}World.prototype=new Object(EventEmitter.prototype);World.prototype.addConstraint=function(c){this.constraints.push(c)};World.prototype.addContactMaterial=function(contactMaterial){this.contactMaterials.push(contactMaterial)};World.prototype.removeContactMaterial=function(cm){var idx=this.contactMaterials.indexOf(cm);if(idx!==-1){Utils.splice(this.contactMaterials,idx,1)}};World.prototype.getContactMaterial=function(materialA,materialB){var cmats=this.contactMaterials;for(var i=0,N=cmats.length;i!==N;i++){var cm=cmats[i];if(cm.materialA===materialA&&cm.materialB===materialB||cm.materialA===materialB&&cm.materialB===materialA){return cm}}return false};World.prototype.removeConstraint=function(c){var idx=this.constraints.indexOf(c);if(idx!==-1){Utils.splice(this.constraints,idx,1)}};var step_r=vec2.create(),step_runit=vec2.create(),step_u=vec2.create(),step_f=vec2.create(),step_fhMinv=vec2.create(),step_velodt=vec2.create(),step_mg=vec2.create(),xiw=vec2.fromValues(0,0),xjw=vec2.fromValues(0,0),zero=vec2.fromValues(0,0),interpvelo=vec2.fromValues(0,0);World.prototype.step=function(dt,timeSinceLastCalled,maxSubSteps){maxSubSteps=maxSubSteps||10;timeSinceLastCalled=timeSinceLastCalled||0;if(timeSinceLastCalled===0){this.internalStep(dt);this.time+=dt}else{var internalSteps=Math.floor((this.time+timeSinceLastCalled)/dt)-Math.floor(this.time/dt);internalSteps=Math.min(internalSteps,maxSubSteps);for(var i=0;i<internalSteps;i++){this.internalStep(dt)}this.time+=timeSinceLastCalled;var h=this.time%dt;for(var j=0;j!==this.bodies.length;j++){var b=this.bodies[j];if(b.motionState!==Body.STATIC&&b.sleepState!==Body.SLEEPING){vec2.sub(interpvelo,b.position,b.previousPosition);vec2.scale(interpvelo,interpvelo,h/dt);vec2.add(b.interpolatedPosition,b.position,interpvelo);b.interpolatedAngle=b.angle+(b.angle-b.previousAngle)*h/dt}else{vec2.copy(b.interpolatedPosition,b.position);b.interpolatedAngle=b.angle}}}};World.prototype.internalStep=function(dt){this.stepping=true;var that=this,doProfiling=this.doProfiling,Nsprings=this.springs.length,springs=this.springs,bodies=this.bodies,g=this.gravity,solver=this.solver,Nbodies=this.bodies.length,broadphase=this.broadphase,np=this.narrowphase,constraints=this.constraints,t0,t1,fhMinv=step_fhMinv,velodt=step_velodt,mg=step_mg,scale=vec2.scale,add=vec2.add,rotate=vec2.rotate,islandManager=this.islandManager;this.lastTimeStep=dt;if(doProfiling){t0=performance.now()}if(this.useWorldGravityAsFrictionGravity){var gravityLen=vec2.length(this.gravity);if(gravityLen===0&&this.useFrictionGravityOnZeroGravity){}else{this.frictionGravity=gravityLen}}if(this.applyGravity){for(var i=0;i!==Nbodies;i++){var b=bodies[i],fi=b.force;if(b.motionState!==Body.DYNAMIC||b.sleepState===Body.SLEEPING){continue}vec2.scale(mg,g,b.mass*b.gravityScale);add(fi,fi,mg)}}if(this.applySpringForces){for(var i=0;i!==Nsprings;i++){var s=springs[i];s.applyForce()}}if(this.applyDamping){for(var i=0;i!==Nbodies;i++){var b=bodies[i];if(b.motionState===Body.DYNAMIC){b.applyDamping(dt)}}}var result=broadphase.getCollisionPairs(this);var ignoredPairs=this.disabledBodyCollisionPairs;for(var i=ignoredPairs.length-2;i>=0;i-=2){for(var j=result.length-2;j>=0;j-=2){if(ignoredPairs[i]===result[j]&&ignoredPairs[i+1]===result[j+1]||ignoredPairs[i+1]===result[j]&&ignoredPairs[i]===result[j+1]){result.splice(j,2)}}}var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){var c=constraints[i];if(!c.collideConnected){for(var j=result.length-2;j>=0;j-=2){if(c.bodyA===result[j]&&c.bodyB===result[j+1]||c.bodyB===result[j]&&c.bodyA===result[j+1]){result.splice(j,2)}}}}this.postBroadphaseEvent.pairs=result;this.emit(this.postBroadphaseEvent);np.reset(this);for(var i=0,Nresults=result.length;i!==Nresults;i+=2){var bi=result[i],bj=result[i+1];for(var k=0,Nshapesi=bi.shapes.length;k!==Nshapesi;k++){var si=bi.shapes[k],xi=bi.shapeOffsets[k],ai=bi.shapeAngles[k];for(var l=0,Nshapesj=bj.shapes.length;l!==Nshapesj;l++){var sj=bj.shapes[l],xj=bj.shapeOffsets[l],aj=bj.shapeAngles[l];var cm=this.defaultContactMaterial;if(si.material&&sj.material){var tmp=this.getContactMaterial(si.material,sj.material);if(tmp){cm=tmp}}this.runNarrowphase(np,bi,si,xi,ai,bj,sj,xj,aj,cm,this.frictionGravity)}}}var last=this.overlappingShapesLastState;for(var i=0;i!==last.keys.length;i++){var key=last.keys[i];if(last[key]!==true){continue}if(!this.overlappingShapesCurrentState[key]){var e=this.endContactEvent;e.shapeA=last[key+"_shapeA"];e.shapeB=last[key+"_shapeB"];e.bodyA=last[key+"_bodyA"];e.bodyB=last[key+"_bodyB"];this.emit(e)}}for(var i=0;i!==last.keys.length;i++){delete last[last.keys[i]]}last.keys.length=0;var current=this.overlappingShapesCurrentState;for(var i=0;i!==current.keys.length;i++){last[current.keys[i]]=current[current.keys[i]];last.keys.push(current.keys[i])}for(var i=0;i!==current.keys.length;i++){delete current[current.keys[i]]}current.keys.length=0;var preSolveEvent=this.preSolveEvent;preSolveEvent.contactEquations=np.contactEquations;preSolveEvent.frictionEquations=np.frictionEquations;this.emit(preSolveEvent);var Nconstraints=constraints.length;for(i=0;i!==Nconstraints;i++){constraints[i].update()}if(np.contactEquations.length||np.frictionEquations.length||constraints.length){if(this.islandSplit){islandManager.equations.length=0;Utils.appendArray(islandManager.equations,np.contactEquations);Utils.appendArray(islandManager.equations,np.frictionEquations);for(i=0;i!==Nconstraints;i++){Utils.appendArray(islandManager.equations,constraints[i].equations)}islandManager.split(this);for(var i=0;i!==islandManager.islands.length;i++){var island=islandManager.islands[i];if(island.equations.length){solver.solveIsland(dt,island)}}}else{solver.addEquations(np.contactEquations);solver.addEquations(np.frictionEquations);for(i=0;i!==Nconstraints;i++){solver.addEquations(constraints[i].equations)}if(this.solveConstraints){solver.solve(dt,this)}solver.removeAllEquations()}}for(var i=0;i!==Nbodies;i++){var body=bodies[i];if(body.sleepState!==Body.SLEEPING&&body.motionState!==Body.STATIC){World.integrateBody(body,dt)}}for(var i=0;i!==Nbodies;i++){bodies[i].setZeroForce()}if(doProfiling){t1=performance.now();that.lastStepTime=t1-t0}if(this.emitImpactEvent){var ev=this.impactEvent;for(var i=0;i!==np.contactEquations.length;i++){var eq=np.contactEquations[i];if(eq.firstImpact){ev.bodyA=eq.bodyA;ev.bodyB=eq.bodyB;ev.shapeA=eq.shapeA;ev.shapeB=eq.shapeB;ev.contactEquation=eq;this.emit(ev)}}}if(this.enableBodySleeping){for(i=0;i!==Nbodies;i++){bodies[i].sleepTick(this.time,false,dt)}}else if(this.enableIslandSleeping&&this.islandSplit){for(i=0;i!==Nbodies;i++){bodies[i].sleepTick(this.time,true,dt)}for(var i=0;i<this.islandManager.islands.length;i++){var island=this.islandManager.islands[i];if(island.wantsToSleep()){island.sleep()}}}this.stepping=false;if(this.bodiesToBeRemoved.length){for(var i=0;i!==this.bodiesToBeRemoved.length;i++){this.removeBody(this.bodiesToBeRemoved[i])}this.bodiesToBeRemoved.length=0}this.emit(this.postStepEvent)};var ib_fhMinv=vec2.create();var ib_velodt=vec2.create();World.integrateBody=function(body,dt){var minv=body.invMass,f=body.force,pos=body.position,velo=body.velocity;vec2.copy(body.previousPosition,body.position);body.previousAngle=body.angle;if(!body.fixedRotation){body.angularVelocity+=body.angularForce*body.invInertia*dt;body.angle+=body.angularVelocity*dt}vec2.scale(ib_fhMinv,f,dt*minv);vec2.add(velo,ib_fhMinv,velo);vec2.scale(ib_velodt,velo,dt);vec2.add(pos,pos,ib_velodt);body.aabbNeedsUpdate=true};World.prototype.runNarrowphase=function(np,bi,si,xi,ai,bj,sj,xj,aj,cm,glen){if(!((si.collisionGroup&sj.collisionMask)!==0&&(sj.collisionGroup&si.collisionMask)!==0)){return}vec2.rotate(xiw,xi,bi.angle);vec2.rotate(xjw,xj,bj.angle);vec2.add(xiw,xiw,bi.position);vec2.add(xjw,xjw,bj.position);var aiw=ai+bi.angle;var ajw=aj+bj.angle;np.enableFriction=cm.friction>0;np.frictionCoefficient=cm.friction;var reducedMass;if(bi.motionState===Body.STATIC||bi.motionState===Body.KINEMATIC){reducedMass=bj.mass}else if(bj.motionState===Body.STATIC||bj.motionState===Body.KINEMATIC){reducedMass=bi.mass}else{reducedMass=bi.mass*bj.mass/(bi.mass+bj.mass)}np.slipForce=cm.friction*glen*reducedMass;np.restitution=cm.restitution;np.surfaceVelocity=cm.surfaceVelocity;np.frictionStiffness=cm.frictionStiffness;np.frictionRelaxation=cm.frictionRelaxation;np.stiffness=cm.stiffness;np.relaxation=cm.relaxation;var resolver=np[si.type|sj.type],numContacts=0;if(resolver){var sensor=si.sensor||sj.sensor;var numFrictionBefore=np.frictionEquations.length;if(si.type<sj.type){numContacts=resolver.call(np,bi,si,xiw,aiw,bj,sj,xjw,ajw,sensor)}else{numContacts=resolver.call(np,bj,sj,xjw,ajw,bi,si,xiw,aiw,sensor)}var numFrictionEquations=np.frictionEquations.length-numFrictionBefore;if(numContacts){var wakeUpA=false;var wakeUpB=false;var speedSquaredA=vec2.squaredLength(bi.velocity)+Math.pow(bi.angularVelocity,2);var speedLimitSquaredA=Math.pow(bi.sleepSpeedLimit,2);var speedSquaredB=vec2.squaredLength(bj.velocity)+Math.pow(bj.angularVelocity,2);var speedLimitSquaredB=Math.pow(bj.sleepSpeedLimit,2);if(bi.allowSleep&&bi.motionState===Body.DYNAMIC&&bi.sleepState===Body.SLEEPING&&bj.sleepState===Body.AWAKE&&bj.motionState!==Body.STATIC&&speedSquaredB>=speedLimitSquaredB*2){wakeUpA=true}if(bj.allowSleep&&bj.motionState===Body.DYNAMIC&&bj.sleepState===Body.SLEEPING&&bi.sleepState===Body.AWAKE&&bi.motionState!==Body.STATIC&&speedSquaredA>=speedLimitSquaredA*2){wakeUpB=true}if(wakeUpA){bi.wakeUp()}if(wakeUpB){bj.wakeUp()}var key=si.id<sj.id?si.id+" "+sj.id:sj.id+" "+si.id;if(!this.overlappingShapesLastState[key]){var e=this.beginContactEvent;e.shapeA=si;e.shapeB=sj;e.bodyA=bi;e.bodyB=bj;e.contactEquations.length=0;if(typeof numContacts==="number"){for(var i=np.contactEquations.length-numContacts;i<np.contactEquations.length;i++){e.contactEquations.push(np.contactEquations[i])}}this.emit(e)}var current=this.overlappingShapesCurrentState;if(!current[key]){current[key]=true;current.keys.push(key);current[key+"_shapeA"]=si;current.keys.push(key+"_shapeA");current[key+"_shapeB"]=sj;current.keys.push(key+"_shapeB");current[key+"_bodyA"]=bi;current.keys.push(key+"_bodyA");current[key+"_bodyB"]=bj;current.keys.push(key+"_bodyB")}if(typeof numContacts==="number"&&numFrictionEquations>1){for(var i=np.frictionEquations.length-numFrictionEquations;i<np.frictionEquations.length;i++){var f=np.frictionEquations[i];f.setSlipForce(f.getSlipForce()/numFrictionEquations)}}}}};World.prototype.addSpring=function(s){this.springs.push(s);this.addSpringEvent.spring=s;this.emit(this.addSpringEvent)};World.prototype.removeSpring=function(s){var idx=this.springs.indexOf(s);if(idx===-1){Utils.splice(this.springs,idx,1)}};World.prototype.addBody=function(body){if(this.bodies.indexOf(body)===-1){this.bodies.push(body);body.world=this;this.addBodyEvent.body=body;this.emit(this.addBodyEvent)}};World.prototype.removeBody=function(body){if(this.stepping){this.bodiesToBeRemoved.push(body)}else{body.world=null;var idx=this.bodies.indexOf(body);if(idx!==-1){Utils.splice(this.bodies,idx,1);this.removeBodyEvent.body=body;body.resetConstraintVelocity();this.emit(this.removeBodyEvent)}}};World.prototype.getBodyById=function(id){var bodies=this.bodies;for(var i=0;i<bodies.length;i++){var b=bodies[i];if(b.id===id){return b}}return false};World.prototype.disableBodyCollision=function(bodyA,bodyB){this.disabledBodyCollisionPairs.push(bodyA,bodyB)};World.prototype.enableBodyCollision=function(bodyA,bodyB){var pairs=this.disabledBodyCollisionPairs;for(var i=0;i<pairs.length;i+=2){if(pairs[i]===bodyA&&pairs[i+1]===bodyB||pairs[i+1]===bodyA&&pairs[i]===bodyB){pairs.splice(i,2);return}}};function v2a(v){if(!v)return v;return[v[0],v[1]]}function extend(a,b){for(var key in b)a[key]=b[key]}function contactMaterialToJSON(cm){return{id:cm.id,materialA:cm.materialA.id,materialB:cm.materialB.id,friction:cm.friction,restitution:cm.restitution,stiffness:cm.stiffness,relaxation:cm.relaxation,frictionStiffness:cm.frictionStiffness,frictionRelaxation:cm.frictionRelaxation}}World.prototype.toJSON=function(){var world=this;var json={p2:pkg.version,bodies:[],springs:[],solver:{},gravity:v2a(world.gravity),broadphase:{},distanceConstraints:[],revoluteConstraints:[],prismaticConstraints:[],lockConstraints:[],gearConstraints:[],contactMaterials:[],materials:[],defaultContactMaterial:contactMaterialToJSON(world.defaultContactMaterial),islandSplit:world.islandSplit,enableIslandSleeping:world.enableIslandSleeping,enableBodySleeping:world.enableBodySleeping};var js=json.solver,s=world.solver;if(s.type===Solver.GS){js.type="GSSolver";js.iterations=s.iterations}var jb=json.broadphase,wb=world.broadphase;if(wb.type===Broadphase.NAIVE){jb.type="NaiveBroadphase"}else if(wb.type===Broadphase.SAP){jb.type="SAPBroadphase"}else{console.error("Broadphase not supported: "+wb.type)}for(var i=0;i!==world.springs.length;i++){var s=world.springs[i];json.springs.push({bodyA:world.bodies.indexOf(s.bodyA),bodyB:world.bodies.indexOf(s.bodyB),stiffness:s.stiffness,damping:s.damping,restLength:s.restLength,localAnchorA:v2a(s.localAnchorA),localAnchorB:v2a(s.localAnchorB)})}for(var i=0;i<world.constraints.length;i++){var c=world.constraints[i];var jc={bodyA:world.bodies.indexOf(c.bodyA),bodyB:world.bodies.indexOf(c.bodyB),collideConnected:c.collideConnected};switch(c.type){case Constraint.DISTANCE:extend(jc,{distance:c.distance,maxForce:c.getMaxForce()});json.distanceConstraints.push(jc);break;case Constraint.REVOLUTE:extend(jc,{pivotA:v2a(c.pivotA),pivotB:v2a(c.pivotB),maxForce:c.maxForce,motorSpeed:c.getMotorSpeed()||0,motorEnabled:!!c.getMotorSpeed(),lowerLimit:c.lowerLimit,lowerLimitEnabled:c.lowerLimitEnabled,upperLimit:c.upperLimit,upperLimitEnabled:c.upperLimitEnabled});json.revoluteConstraints.push(jc);break;case Constraint.PRISMATIC:extend(jc,{localAxisA:v2a(c.localAxisA),localAnchorA:v2a(c.localAnchorA),localAnchorB:v2a(c.localAnchorB),maxForce:c.maxForce,upperLimitEnabled:c.upperLimitEnabled,lowerLimitEnabled:c.lowerLimitEnabled,upperLimit:c.upperLimit,lowerLimit:c.lowerLimit,motorEnabled:c.motorEnabled,motorSpeed:c.motorSpeed});json.prismaticConstraints.push(jc);break;case Constraint.LOCK:extend(jc,{localOffsetB:v2a(c.localOffsetB),localAngleB:c.localAngleB,maxForce:c.getMaxForce()});json.lockConstraints.push(jc);break;case Constraint.GEAR:extend(jc,{angle:c.angle,ratio:c.ratio,maxForce:c.maxForce||1e6});json.gearConstraints.push(jc);break;default:console.error("Constraint not supported yet: ",c.type);break}}for(var i=0;i!==world.bodies.length;i++){var b=world.bodies[i],ss=b.shapes,jsonBody={id:b.id,mass:b.mass,angle:b.angle,position:v2a(b.position),velocity:v2a(b.velocity),angularVelocity:b.angularVelocity,force:v2a(b.force),motionState:b.motionState,fixedRotation:b.fixedRotation,circleShapes:[],planeShapes:[],particleShapes:[],lineShapes:[],rectangleShapes:[],convexShapes:[],capsuleShapes:[]};if(b.concavePath){jsonBody.concavePath=b.concavePath}for(var j=0;j<ss.length;j++){var s=ss[j],jsonShape={};jsonShape.offset=v2a(b.shapeOffsets[j]);jsonShape.angle=b.shapeAngles[j];jsonShape.collisionGroup=s.collisionGroup;jsonShape.collisionMask=s.collisionMask;jsonShape.material=s.material?s.material.id:null;switch(s.type){case Shape.CIRCLE:extend(jsonShape,{radius:s.radius});jsonBody.circleShapes.push(jsonShape);break;case Shape.PLANE:jsonBody.planeShapes.push(jsonShape);break;case Shape.PARTICLE:jsonBody.particleShapes.push(jsonShape);break;case Shape.LINE:jsonShape.length=s.length;jsonBody.lineShapes.push(jsonShape);break;case Shape.RECTANGLE:extend(jsonShape,{width:s.width,height:s.height});jsonBody.rectangleShapes.push(jsonShape);break;case Shape.CONVEX:var verts=[];for(var k=0;k<s.vertices.length;k++){verts.push(v2a(s.vertices[k]))}extend(jsonShape,{vertices:verts});jsonBody.convexShapes.push(jsonShape);break;case Shape.CAPSULE:extend(jsonShape,{length:s.length,radius:s.radius});jsonBody.capsuleShapes.push(jsonShape);break;default:console.error("Shape type not supported yet!");break}}json.bodies.push(jsonBody)}for(var i=0;i<world.contactMaterials.length;i++){var cm=world.contactMaterials[i];json.contactMaterials.push(contactMaterialToJSON(cm))}var mats={};for(var i=0;i<world.contactMaterials.length;i++){var cm=world.contactMaterials[i];mats[cm.materialA.id+""]=cm.materialA;mats[cm.materialB.id+""]=cm.materialB}for(var matId in mats){var m=mats[parseInt(matId)];json.materials.push({id:m.id})}return json};World.prototype.fromJSON=function(json){this.clear();if(!json.p2){return false}var w=this;vec2.copy(w.gravity,json.gravity);w.islandSplit=json.islandSplit;w.enableIslandSleeping=json.enableIslandSleeping;w.enableBodySleeping=json.enableBodySleeping;switch(json.solver.type){case"GSSolver":var js=json.solver,s=new GSSolver;w.solver=s;s.iterations=js.iterations;break;default:throw new Error("Solver type not recognized: "+json.solver.type)}switch(json.broadphase.type){case"NaiveBroadphase":w.broadphase=new NaiveBroadphase;break;case"SAPBroadphase":w.broadphase=new SAPBroadphase;break}w.broadphase.setWorld(w);var bodies=w.bodies;var id2material={};for(var i=0;i!==json.materials.length;i++){var jm=json.materials[i];var m=new Material;id2material[jm.id+""]=m;m.id=jm.id}w.defaultMaterial.id=json.defaultContactMaterial.materialA;for(var i=0;i!==json.bodies.length;i++){var jb=json.bodies[i];var b=new Body({mass:jb.mass,position:jb.position,angle:jb.angle,velocity:jb.velocity,angularVelocity:jb.angularVelocity,force:jb.force,fixedRotation:jb.fixedRotation});b.id=jb.id;b.motionState=jb.motionState;for(var j=0;j<jb.circleShapes.length;j++){var s=jb.circleShapes[j];addShape(b,new Circle(s.radius),s)}for(var j=0;j<jb.planeShapes.length;j++){var s=jb.planeShapes[j];addShape(b,new Plane,s)}for(var j=0;j<jb.particleShapes.length;j++){var s=jb.particleShapes[j];addShape(b,new Particle,s)}for(var j=0;j<jb.lineShapes.length;j++){var s=jb.lineShapes[j];addShape(b,new Line(s.length),s)}for(var j=0;j<jb.rectangleShapes.length;j++){var s=jb.rectangleShapes[j];addShape(b,new Rectangle(s.width,s.height),s)}for(var j=0;j<jb.convexShapes.length;j++){var s=jb.convexShapes[j];addShape(b,new Convex(s.vertices),s)}for(var j=0;j<jb.capsuleShapes.length;j++){var s=jb.capsuleShapes[j];addShape(b,new Capsule(s.length,s.radius),s)}function addShape(body,shape,shapeJSON){shape.collisionMask=shapeJSON.collisionMask;shape.collisionGroup=shapeJSON.collisionGroup;if(shapeJSON.material){shape.material=id2material[shapeJSON.material+""]}body.addShape(shape,shapeJSON.offset,shapeJSON.angle)}if(jb.concavePath){b.concavePath=jb.concavePath}w.addBody(b)}for(var i=0;i<json.springs.length;i++){var js=json.springs[i];var bodyA=bodies[js.bodyA],bodyB=bodies[js.bodyB];if(!bodyA){this.error="instance.springs["+i+"] references instance.body["+js.bodyA+"], which does not exist.";return false}if(!bodyB){this.error="instance.springs["+i+"] references instance.body["+js.bodyB+"], which does not exist.";return false}var s=new Spring(bodyA,bodyB,{stiffness:js.stiffness,damping:js.damping,restLength:js.restLength,localAnchorA:js.localAnchorA,localAnchorB:js.localAnchorB});w.addSpring(s)}for(var i=0;i<json.contactMaterials.length;i++){var jm=json.contactMaterials[i],matA=id2material[jm.materialA+""],matB=id2material[jm.materialB+""];if(!matA){this.error="Reference to material id "+jm.materialA+": material not found";return false}if(!matB){this.error="Reference to material id "+jm.materialB+": material not found";return false}var cm=new ContactMaterial(matA,matB,{friction:jm.friction,restitution:jm.restitution,stiffness:jm.stiffness,relaxation:jm.relaxation,frictionStiffness:jm.frictionStiffness,frictionRelaxation:jm.frictionRelaxation});cm.id=jm.id;w.addContactMaterial(cm)}var jm=json.defaultContactMaterial,matA=w.defaultMaterial,matB=w.defaultMaterial;var cm=new ContactMaterial(matA,matB,{friction:jm.friction,restitution:jm.restitution,stiffness:jm.stiffness,relaxation:jm.relaxation,frictionStiffness:jm.frictionStiffness,frictionRelaxation:jm.frictionRelaxation});cm.id=jm.id;w.defaultContactMaterial=cm;for(var i=0;i<json.distanceConstraints.length;i++){var c=json.distanceConstraints[i];w.addConstraint(new DistanceConstraint(bodies[c.bodyA],bodies[c.bodyB],c.distance,{maxForce:c.maxForce,collideConnected:c.collideConnected}))}for(var i=0;i<json.revoluteConstraints.length;i++){var c=json.revoluteConstraints[i];var revolute=new RevoluteConstraint(bodies[c.bodyA],c.pivotA,bodies[c.bodyB],c.pivotB,{maxForce:c.maxForce,collideConnected:c.collideConnected});if(c.motorEnabled){revolute.enableMotor()}revolute.setMotorSpeed(c.motorSpeed);revolute.lowerLimit=c.lowerLimit;revolute.upperLimit=c.upperLimit;revolute.lowerLimitEnabled=c.lowerLimitEnabled;revolute.upperLimitEnabled=c.upperLimitEnabled;w.addConstraint(revolute)}for(var i=0;i<json.prismaticConstraints.length;i++){var c=json.prismaticConstraints[i],p=new PrismaticConstraint(bodies[c.bodyA],bodies[c.bodyB],{maxForce:c.maxForce,localAxisA:c.localAxisA,localAnchorA:c.localAnchorA,localAnchorB:c.localAnchorB,collideConnected:c.collideConnected});p.motorSpeed=c.motorSpeed;w.addConstraint(p)}for(var i=0;i<json.lockConstraints.length;i++){var c=json.lockConstraints[i];w.addConstraint(new LockConstraint(bodies[c.bodyA],bodies[c.bodyB],{maxForce:c.maxForce,localOffsetB:c.localOffsetB,localAngleB:c.localAngleB,collideConnected:c.collideConnected}))}for(var i=0;i<json.gearConstraints.length;i++){var c=json.gearConstraints[i];w.addConstraint(new GearConstraint(bodies[c.bodyA],bodies[c.bodyB],{maxForce:c.maxForce,angle:c.angle,ratio:c.ratio,collideConnected:c.collideConnected}))}return true};World.prototype.clear=function(){this.time=0;this.fixedStepTime=0;if(this.solver&&this.solver.equations.length){this.solver.removeAllEquations()}var cs=this.constraints;for(var i=cs.length-1;i>=0;i--){this.removeConstraint(cs[i])}var bodies=this.bodies;for(var i=bodies.length-1;i>=0;i--){this.removeBody(bodies[i])}var springs=this.springs;for(var i=springs.length-1;i>=0;i--){this.removeSpring(springs[i])}var cms=this.contactMaterials;for(var i=cms.length-1;i>=0;i--){this.removeContactMaterial(cms[i])}World.apply(this)};World.prototype.clone=function(){var world=new World;world.fromJSON(this.toJSON());return world};var hitTest_tmp1=vec2.create(),hitTest_zero=vec2.fromValues(0,0),hitTest_tmp2=vec2.fromValues(0,0);World.prototype.hitTest=function(worldPoint,bodies,precision){precision=precision||0;var pb=new Body({position:worldPoint}),ps=new Particle,px=worldPoint,pa=0,x=hitTest_tmp1,zero=hitTest_zero,tmp=hitTest_tmp2;pb.addShape(ps);var n=this.narrowphase,result=[];for(var i=0,N=bodies.length;i!==N;i++){var b=bodies[i];for(var j=0,NS=b.shapes.length;j!==NS;j++){var s=b.shapes[j],offset=b.shapeOffsets[j]||zero,angle=b.shapeAngles[j]||0;vec2.rotate(x,offset,b.angle);vec2.add(x,x,b.position);var a=angle+b.angle;if(s instanceof Circle&&n.circleParticle(b,s,x,a,pb,ps,px,pa,true)||s instanceof Convex&&n.particleConvex(pb,ps,px,pa,b,s,x,a,true)||s instanceof Plane&&n.particlePlane(pb,ps,px,pa,b,s,x,a,true)||s instanceof Capsule&&n.particleCapsule(pb,ps,px,pa,b,s,x,a,true)||s instanceof Particle&&vec2.squaredLength(vec2.sub(tmp,x,worldPoint))<precision*precision){result.push(b)}}}return result};World.prototype.setGlobalEquationParameters=function(parameters){parameters=parameters||{};for(var i=0;i!==this.constraints.length;i++){var c=this.constraints[i];for(var j=0;j!==c.equations.length;j++){var eq=c.equations[j];if(typeof parameters.stiffness!=="undefined"){eq.stiffness=parameters.stiffness}if(typeof parameters.relaxation!=="undefined"){eq.relaxation=parameters.relaxation}eq.needsUpdate=true}}for(var i=0;i!==this.contactMaterials.length;i++){var c=this.contactMaterials[i];if(typeof parameters.stiffness!=="undefined"){c.stiffness=parameters.stiffness;c.frictionStiffness=parameters.stiffness}if(typeof parameters.relaxation!=="undefined"){c.relaxation=parameters.relaxation;c.frictionRelaxation=parameters.relaxation}}var c=this.defaultContactMaterial;if(typeof parameters.stiffness!=="undefined"){c.stiffness=parameters.stiffness;c.frictionStiffness=parameters.stiffness}if(typeof parameters.relaxation!=="undefined"){c.relaxation=parameters.relaxation;c.frictionRelaxation=parameters.relaxation}};World.prototype.setGlobalStiffness=function(stiffness){this.setGlobalEquationParameters({stiffness:stiffness})};World.prototype.setGlobalRelaxation=function(relaxation){this.setGlobalEquationParameters({relaxation:relaxation})}},{"../../package.json":7,"../collision/Broadphase":9,"../collision/NaiveBroadphase":11,"../collision/Narrowphase":12,"../collision/SAPBroadphase":13,"../constraints/Constraint":14,"../constraints/DistanceConstraint":15,"../constraints/GearConstraint":16,"../constraints/LockConstraint":17,"../constraints/PrismaticConstraint":18,"../constraints/RevoluteConstraint":19,"../events/EventEmitter":26,"../material/ContactMaterial":27,"../material/Material":28,"../math/vec2":30,"../objects/Body":31,"../objects/Spring":32,"../shapes/Capsule":34,"../shapes/Circle":35,"../shapes/Convex":36,"../shapes/Line":38,"../shapes/Particle":39,"../shapes/Plane":40,"../shapes/Rectangle":41,"../shapes/Shape":42,"../solver/GSSolver":43,"../solver/Solver":44,"../utils/Utils":45,"./IslandManager":47}]},{},[33])(33)});(function(){var cache={};var ctx=null,usingWebAudio=true,noAudio=false;try{if(typeof AudioContext!=="undefined"){ctx=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){ctx=new webkitAudioContext}else{usingWebAudio=false}}catch(e){usingWebAudio=false}if(!usingWebAudio){if(typeof Audio!=="undefined"){try{new Audio}catch(e){noAudio=true}}else{noAudio=true}}if(usingWebAudio){var masterGain=typeof ctx.createGain==="undefined"?ctx.createGainNode():ctx.createGain();masterGain.gain.value=1;masterGain.connect(ctx.destination)}var HowlerGlobal=function(){this._volume=1;this._muted=false;this.usingWebAudio=usingWebAudio;this.noAudio=noAudio;this._howls=[]};HowlerGlobal.prototype={volume:function(vol){var self=this;vol=parseFloat(vol);if(vol>=0&&vol<=1){self._volume=vol;if(usingWebAudio){masterGain.gain.value=vol}for(var key in self._howls){if(self._howls.hasOwnProperty(key)&&self._howls[key]._webAudio===false){for(var i=0;i<self._howls[key]._audioNode.length;i++){self._howls[key]._audioNode[i].volume=self._howls[key]._volume*self._volume}}}return self}return usingWebAudio?masterGain.gain.value:self._volume},mute:function(){this._setMuted(true);return this},unmute:function(){this._setMuted(false);return this},_setMuted:function(muted){var self=this;self._muted=muted;if(usingWebAudio){masterGain.gain.value=muted?0:self._volume}for(var key in self._howls){if(self._howls.hasOwnProperty(key)&&self._howls[key]._webAudio===false){for(var i=0;i<self._howls[key]._audioNode.length;i++){self._howls[key]._audioNode[i].muted=muted}}}}};var Howler=new HowlerGlobal;var audioTest=null;if(!noAudio){audioTest=new Audio;var codecs={mp3:!!audioTest.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!audioTest.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!audioTest.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!audioTest.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(audioTest.canPlayType("audio/x-m4a;")||audioTest.canPlayType("audio/m4a;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(audioTest.canPlayType("audio/x-mp4;")||audioTest.canPlayType("audio/mp4;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!audioTest.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")}
}var Howl=function(o){var self=this;self._autoplay=o.autoplay||false;self._buffer=o.buffer||false;self._duration=o.duration||0;self._format=o.format||null;self._loop=o.loop||false;self._loaded=false;self._sprite=o.sprite||{};self._src=o.src||"";self._pos3d=o.pos3d||[0,0,-.5];self._volume=o.volume!==undefined?o.volume:1;self._urls=o.urls||[];self._rate=o.rate||1;self._model=o.model||null;self._onload=[o.onload||function(){}];self._onloaderror=[o.onloaderror||function(){}];self._onend=[o.onend||function(){}];self._onpause=[o.onpause||function(){}];self._onplay=[o.onplay||function(){}];self._onendTimer=[];self._webAudio=usingWebAudio&&!self._buffer;self._audioNode=[];if(self._webAudio){self._setupAudioNode()}Howler._howls.push(self);self.load()};Howl.prototype={load:function(){var self=this,url=null;if(noAudio){self.on("loaderror");return}for(var i=0;i<self._urls.length;i++){var ext,urlItem;if(self._format){ext=self._format}else{urlItem=self._urls[i].toLowerCase().split("?")[0];ext=urlItem.match(/.+\.([^?]+)(\?|$)/);ext=ext&&ext.length>=2?ext:urlItem.match(/data\:audio\/([^?]+);/);if(ext){ext=ext[1]}else{self.on("loaderror");return}}if(codecs[ext]){url=self._urls[i];break}}if(!url){self.on("loaderror");return}self._src=url;if(self._webAudio){loadBuffer(self,url)}else{var newNode=new Audio;newNode.addEventListener("error",function(){if(newNode.error&&newNode.error.code===4){HowlerGlobal.noAudio=true}self.on("loaderror",{type:newNode.error?newNode.error.code:0})},false);self._audioNode.push(newNode);newNode.src=url;newNode._pos=0;newNode.preload="auto";newNode.volume=Howler._muted?0:self._volume*Howler.volume();cache[url]=self;var listener=function(){self._duration=Math.ceil(newNode.duration*10)/10;if(Object.getOwnPropertyNames(self._sprite).length===0){self._sprite={_default:[0,self._duration*1e3]}}if(!self._loaded){self._loaded=true;self.on("load")}if(self._autoplay){self.play()}newNode.removeEventListener("canplaythrough",listener,false)};newNode.addEventListener("canplaythrough",listener,false);newNode.load()}return self},urls:function(urls){var self=this;if(urls){self.stop();self._urls=typeof urls==="string"?[urls]:urls;self._loaded=false;self.load();return self}else{return self._urls}},play:function(sprite,callback){var self=this;if(typeof sprite==="function"){callback=sprite}if(!sprite||typeof sprite==="function"){sprite="_default"}if(!self._loaded){self.on("load",function(){self.play(sprite,callback)});return self}if(!self._sprite[sprite]){if(typeof callback==="function")callback();return self}self._inactiveNode(function(node){node._sprite=sprite;var pos=node._pos>0?node._pos:self._sprite[sprite][0]/1e3;var duration=0;if(self._webAudio){duration=self._sprite[sprite][1]/1e3-node._pos;if(node._pos>0){pos=self._sprite[sprite][0]/1e3+pos}}else{duration=self._sprite[sprite][1]/1e3-(pos-self._sprite[sprite][0]/1e3)}var loop=!!(self._loop||self._sprite[sprite][2]);var soundId=typeof callback==="string"?callback:Math.round(Date.now()*Math.random())+"",timerId;(function(){var data={id:soundId,sprite:sprite,loop:loop};timerId=setTimeout(function(){if(!self._webAudio&&loop){self.stop(data.id).play(sprite,data.id)}if(self._webAudio&&!loop){self._nodeById(data.id).paused=true;self._nodeById(data.id)._pos=0}if(!self._webAudio&&!loop){self.stop(data.id)}self.on("end",soundId)},duration*1e3);self._onendTimer.push({timer:timerId,id:data.id})})();if(self._webAudio){var loopStart=self._sprite[sprite][0]/1e3,loopEnd=self._sprite[sprite][1]/1e3;node.id=soundId;node.paused=false;refreshBuffer(self,[loop,loopStart,loopEnd],soundId);self._playStart=ctx.currentTime;node.gain.value=self._volume;if(typeof node.bufferSource.start==="undefined"){node.bufferSource.noteGrainOn(0,pos,duration)}else{node.bufferSource.start(0,pos,duration)}}else{if(node.readyState===4||!node.readyState&&navigator.isCocoonJS){node.readyState=4;node.id=soundId;node.currentTime=pos;node.muted=Howler._muted||node.muted;node.volume=self._volume*Howler.volume();setTimeout(function(){node.play()},0)}else{self._clearEndTimer(soundId);(function(){var sound=self,playSprite=sprite,fn=callback,newNode=node;var listener=function(){sound.play(playSprite,fn);newNode.removeEventListener("canplaythrough",listener,false)};newNode.addEventListener("canplaythrough",listener,false)})();return self}}self.on("play");if(typeof callback==="function")callback(soundId);return self});return self},pause:function(id){var self=this;if(!self._loaded){self.on("play",function(){self.pause(id)});return self}self._clearEndTimer(id);var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){activeNode._pos=self.pos(null,id);if(self._webAudio){if(!activeNode.bufferSource||activeNode.paused){return self}activeNode.paused=true;if(typeof activeNode.bufferSource.stop==="undefined"){activeNode.bufferSource.noteOff(0)}else{activeNode.bufferSource.stop(0)}}else{activeNode.pause()}}self.on("pause");return self},stop:function(id){var self=this;if(!self._loaded){self.on("play",function(){self.stop(id)});return self}self._clearEndTimer(id);var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){activeNode._pos=0;if(self._webAudio){if(!activeNode.bufferSource||activeNode.paused){return self}activeNode.paused=true;if(typeof activeNode.bufferSource.stop==="undefined"){activeNode.bufferSource.noteOff(0)}else{activeNode.bufferSource.stop(0)}}else if(!isNaN(activeNode.duration)){activeNode.pause();activeNode.currentTime=0}}return self},mute:function(id){var self=this;if(!self._loaded){self.on("play",function(){self.mute(id)});return self}var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){if(self._webAudio){activeNode.gain.value=0}else{activeNode.muted=true}}return self},unmute:function(id){var self=this;if(!self._loaded){self.on("play",function(){self.unmute(id)});return self}var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){if(self._webAudio){activeNode.gain.value=self._volume}else{activeNode.muted=false}}return self},volume:function(vol,id){var self=this;vol=parseFloat(vol);if(vol>=0&&vol<=1){self._volume=vol;if(!self._loaded){self.on("play",function(){self.volume(vol,id)});return self}var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){if(self._webAudio){activeNode.gain.value=vol}else{activeNode.volume=vol*Howler.volume()}}return self}else{return self._volume}},loop:function(loop){var self=this;if(typeof loop==="boolean"){self._loop=loop;return self}else{return self._loop}},sprite:function(sprite){var self=this;if(typeof sprite==="object"){self._sprite=sprite;return self}else{return self._sprite}},pos:function(pos,id){var self=this;if(!self._loaded){self.on("load",function(){self.pos(pos)});return typeof pos==="number"?self:self._pos||0}pos=parseFloat(pos);var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){if(pos>=0){self.pause(id);activeNode._pos=pos;self.play(activeNode._sprite,id);return self}else{return self._webAudio?activeNode._pos+(ctx.currentTime-self._playStart):activeNode.currentTime}}else if(pos>=0){return self}else{for(var i=0;i<self._audioNode.length;i++){if(self._audioNode[i].paused&&self._audioNode[i].readyState===4){return self._webAudio?self._audioNode[i]._pos:self._audioNode[i].currentTime}}}},pos3d:function(x,y,z,id){var self=this;y=typeof y==="undefined"||!y?0:y;z=typeof z==="undefined"||!z?-.5:z;if(!self._loaded){self.on("play",function(){self.pos3d(x,y,z,id)});return self}if(x>=0||x<0){if(self._webAudio){var activeNode=id?self._nodeById(id):self._activeNode();if(activeNode){self._pos3d=[x,y,z];activeNode.panner.setPosition(x,y,z);activeNode.panner.panningModel=self._model||"HRTF"}}}else{return self._pos3d}return self},fade:function(from,to,len,callback,id){var self=this,diff=Math.abs(from-to),dir=from>to?"down":"up",steps=diff/.01,stepTime=len/steps;if(!self._loaded){self.on("load",function(){self.fade(from,to,len,callback,id)});return self}self.volume(from,id);for(var i=1;i<=steps;i++){(function(){var change=self._volume+(dir==="up"?.01:-.01)*i,vol=Math.round(1e3*change)/1e3,toVol=to;setTimeout(function(){self.volume(vol,id);if(vol===toVol){if(callback)callback()}},stepTime*i)})()}},fadeIn:function(to,len,callback){return this.volume(0).play().fade(0,to,len,callback)},fadeOut:function(to,len,callback,id){var self=this;return self.fade(self._volume,to,len,function(){if(callback)callback();self.pause(id);self.on("end")},id)},_nodeById:function(id){var self=this,node=self._audioNode[0];for(var i=0;i<self._audioNode.length;i++){if(self._audioNode[i].id===id){node=self._audioNode[i];break}}return node},_activeNode:function(){var self=this,node=null;for(var i=0;i<self._audioNode.length;i++){if(!self._audioNode[i].paused){node=self._audioNode[i];break}}self._drainPool();return node},_inactiveNode:function(callback){var self=this,node=null;for(var i=0;i<self._audioNode.length;i++){if(self._audioNode[i].paused&&self._audioNode[i].readyState===4){callback(self._audioNode[i]);node=true;break}}self._drainPool();if(node){return}var newNode;if(self._webAudio){newNode=self._setupAudioNode();callback(newNode)}else{self.load();newNode=self._audioNode[self._audioNode.length-1];var listenerEvent=navigator.isCocoonJS?"canplaythrough":"loadedmetadata";var listener=function(){newNode.removeEventListener(listenerEvent,listener,false);callback(newNode)};newNode.addEventListener(listenerEvent,listener,false)}},_drainPool:function(){var self=this,inactive=0,i;for(i=0;i<self._audioNode.length;i++){if(self._audioNode[i].paused){inactive++}}for(i=self._audioNode.length-1;i>=0;i--){if(inactive<=5){break}if(self._audioNode[i].paused){if(self._webAudio){self._audioNode[i].disconnect(0)}inactive--;self._audioNode.splice(i,1)}}},_clearEndTimer:function(soundId){var self=this,index=0;for(var i=0;i<self._onendTimer.length;i++){if(self._onendTimer[i].id===soundId){index=i;break}}var timer=self._onendTimer[index];if(timer){clearTimeout(timer.timer);self._onendTimer.splice(index,1)}},_setupAudioNode:function(){var self=this,node=self._audioNode,index=self._audioNode.length;node[index]=typeof ctx.createGain==="undefined"?ctx.createGainNode():ctx.createGain();node[index].gain.value=self._volume;node[index].paused=true;node[index]._pos=0;node[index].readyState=4;node[index].connect(masterGain);node[index].panner=ctx.createPanner();node[index].panner.panningModel=self._model||"equalpower";node[index].panner.setPosition(self._pos3d[0],self._pos3d[1],self._pos3d[2]);node[index].panner.connect(node[index]);return node[index]},on:function(event,fn){var self=this,events=self["_on"+event];if(typeof fn==="function"){events.push(fn)}else{for(var i=0;i<events.length;i++){if(fn){events[i].call(self,fn)}else{events[i].call(self)}}}return self},off:function(event,fn){var self=this,events=self["_on"+event],fnString=fn.toString();for(var i=0;i<events.length;i++){if(fnString===events[i].toString()){events.splice(i,1);break}}return self},unload:function(){var self=this;var nodes=self._audioNode;for(var i=0;i<self._audioNode.length;i++){if(!nodes[i].paused){self.stop(nodes[i].id)}if(!self._webAudio){nodes[i].src=""}else{nodes[i].disconnect(0)}}for(i=0;i<self._onendTimer.length;i++){clearTimeout(self._onendTimer[i].timer)}var index=Howler._howls.indexOf(self);if(index!==null&&index>=0){Howler._howls.splice(index,1)}delete cache[self._src];self=null}};if(usingWebAudio){var loadBuffer=function(obj,url){if(url in cache){obj._duration=cache[url].duration;loadSound(obj)}else{var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.onload=function(){ctx.decodeAudioData(xhr.response,function(buffer){if(buffer){cache[url]=buffer;loadSound(obj,buffer)}},function(err){obj.on("loaderror")})};xhr.onerror=function(){if(obj._webAudio){obj._buffer=true;obj._webAudio=false;obj._audioNode=[];delete obj._gainNode;obj.load()}};try{xhr.send()}catch(e){xhr.onerror()}}};var loadSound=function(obj,buffer){obj._duration=buffer?buffer.duration:obj._duration;if(Object.getOwnPropertyNames(obj._sprite).length===0){obj._sprite={_default:[0,obj._duration*1e3]}}if(!obj._loaded){obj._loaded=true;obj.on("load")}if(obj._autoplay){obj.play()}};var refreshBuffer=function(obj,loop,id){var node=obj._nodeById(id);node.bufferSource=ctx.createBufferSource();node.bufferSource.buffer=cache[obj._src];node.bufferSource.connect(node.panner);node.bufferSource.loop=loop[0];if(loop[0]){node.bufferSource.loopStart=loop[1];node.bufferSource.loopEnd=loop[1]+loop[2]}node.bufferSource.playbackRate.value=obj._rate}}if(typeof define==="function"&&define.amd){define(function(){return{Howler:Howler,Howl:Howl}})}if(typeof exports!=="undefined"){exports.Howler=Howler;exports.Howl=Howl}if(typeof window!=="undefined"){window.Howler=Howler;window.Howl=Howl}})();var Game=function(){this._player=parseInt(window.location.hash.replace("#",""),10);this._width=1920;this._height=1080;window.addEventListener("resize",function(){this.resize()}.bind(this),false);this.bgRenderer=new PIXI.CanvasRenderer(this._width,this._height);document.body.appendChild(this.bgRenderer.view);this.bgStage=new PIXI.Stage;this.renderer=new PIXI.CanvasRenderer(this._width,this._height,null,true);document.body.appendChild(this.renderer.view);this.stage=new PIXI.Stage;this.world=new p2.World({gravity:[0,0]});this.speed=500;this.turnSpeed=3;window.addEventListener("keydown",function(event){this.handleKeys(event.keyCode,true)}.bind(this),false);window.addEventListener("keyup",function(event){this.handleKeys(event.keyCode,false)}.bind(this),false);this.enemyBodies=[];this.enemyGraphics=[];this.removeObjs=[];this.socket=io("http://localhost:2000");this.socket.on("score",function(msg){this._score[msg.plr]=msg.score;this.score[msg.plr].setText(this._score[msg.plr])}.bind(this));this.build()};Game.prototype={build:function(){this.resize();this.drawStars();this.setupBoundaries();this.createShip();this.createEnemies();this.setupAudio();this.setupScores();requestAnimationFrame(this.tick.bind(this))},setupAudio:function(){this.sounds=new Howl({urls:["sounds.mp3","sounds.ogg"],sprite:{boom1:[0,640],boom2:[2e3,2140],boom3:[5e3,2180]}});this.music=new Howl({urls:["music.mp3","music.ogg"],buffer:true,autoplay:true,volume:.7,loop:true})},drawStars:function(){for(var i=0;i<1500;i++){var x=Math.round(Math.random()*this._width);var y=Math.round(Math.random()*this._height);var rad=Math.ceil(Math.random()*2);var alpha=Math.min(Math.random()+.25,1);var star=new PIXI.Graphics;star.beginFill(16777215,alpha);star.drawCircle(x,y,rad);star.endFill();this.bgStage.addChild(star)}this.bgRenderer.render(this.bgStage)},setupBoundaries:function(){var walls=new PIXI.Graphics;walls.beginFill(16777215,.5);walls.drawRect(0,0,this._width,10);walls.drawRect(this._width-10,10,10,this._height-20);walls.drawRect(0,this._height-10,this._width,10);walls.drawRect(0,10,10,this._height-20);this.bgStage.addChild(walls);this.bgRenderer.render(this.bgStage)},createShip:function(){this.ship=new p2.Body({mass:1,angularVelocity:0,damping:0,angularDamping:0,position:[Math.round(this._width/2),Math.round(this._height/2)]});this.shipShape=new p2.Rectangle(52,69);this.ship.addShape(this.shipShape);this.world.addBody(this.ship);var shipGraphics=new PIXI.Graphics;shipGraphics.beginFill(this._player===0?2151422:16770048);shipGraphics.moveTo(26,0);shipGraphics.lineTo(0,60);shipGraphics.lineTo(52,60);shipGraphics.endFill();shipGraphics.beginFill(this._player===0?1349073:16760832);shipGraphics.drawRect(7,60,38,8);shipGraphics.endFill();var shipCache=new PIXI.CanvasRenderer(52,69,null,true);var shipCacheStage=new PIXI.Stage;shipCacheStage.addChild(shipGraphics);shipCache.render(shipCacheStage);var shipTexture=PIXI.Texture.fromCanvas(shipCache.view);this.shipGraphics=new PIXI.Sprite(shipTexture);this.stage.addChild(this.shipGraphics)},createEnemies:function(){var enemyGraphics=new PIXI.Graphics;enemyGraphics.beginFill(3724314);enemyGraphics.drawCircle(20,20,20);enemyGraphics.endFill();enemyGraphics.beginFill(2817792);enemyGraphics.lineStyle(1,2333963,1);enemyGraphics.drawCircle(20,20,10);enemyGraphics.endFill();var enemyCache=new PIXI.CanvasRenderer(40,40,null,true);var enemyCacheStage=new PIXI.Stage;enemyCacheStage.addChild(enemyGraphics);enemyCache.render(enemyCacheStage);var enemyTexture=PIXI.Texture.fromCanvas(enemyCache.view);this.enemyTimer=setInterval(function(){var x=Math.round(Math.random()*this._width);var y=Math.round(Math.random()*this._height);var vx=(Math.random()-.5)*this.speed;var vy=(Math.random()-.5)*this.speed;var va=(Math.random()-.5)*this.speed;var enemy=new p2.Body({position:[x,y],mass:1,damping:0,angularDamping:0,velocity:[vx,vy],angularVelocity:va});var enemyShape=new p2.Circle(20);enemyShape.sensor=true;enemy.addShape(enemyShape);this.world.addBody(enemy);var enemySprite=new PIXI.Sprite(enemyTexture);this.stage.addChild(enemySprite);this.enemyBodies.push(enemy);this.enemyGraphics.push(enemySprite)}.bind(this),1e3);this.world.on("beginContact",function(event){if(event.bodyB.id===this.ship.id){event.bodyA._sound=true;this.removeObjs.push(event.bodyA);this._score[this._player]++;this.score[this._player].setText(this._score[this._player]);this.socket.emit("score",{score:this._score[this._player],plr:this._player})}}.bind(this))},setupScores:function(){this._score=[0,0];this.score=[];this.score[0]=new PIXI.Text(this._score[0],{font:"bold 40px Arial",fill:"cyan",align:"left"});this.score[0].x=20;this.score[0].y=1025;this.score[1]=new PIXI.Text(this._score[1],{font:"bold 40px Arial",fill:"yellow",align:"right"});this.score[1].x=1880;this.score[1].y=1025;this.stage.addChild(this.score[0]);this.stage.addChild(this.score[1])},handleKeys:function(code,state){switch(code){case 65:this.keyLeft=state;break;case 68:this.keyRight=state;break;case 87:this.keyUp=state;break}},updatePhysics:function(){if(this.keyLeft){this.ship.angularVelocity=-1*this.turnSpeed}else if(this.keyRight){this.ship.angularVelocity=this.turnSpeed}else{this.ship.angularVelocity=0}if(this.keyUp){var angle=this.ship.angle+Math.PI/2;this.ship.force[0]-=this.speed*Math.cos(angle);this.ship.force[1]-=this.speed*Math.sin(angle)}this.shipGraphics.x=this.ship.position[0];this.shipGraphics.y=this.ship.position[1];this.shipGraphics.rotation=this.ship.angle;if(this.ship.position[0]>this._width){this.ship.position[0]=0}else if(this.ship.position[0]<0){this.ship.position[0]=this._width}if(this.ship.position[1]>this._height){this.ship.position[1]=0}else if(this.ship.position[1]<0){this.ship.position[1]=this._height}for(var i=0;i<this.enemyBodies.length;i++){var x=this.enemyBodies[i].position[0];var y=this.enemyBodies[i].position[1];this.enemyGraphics[i].x=x;this.enemyGraphics[i].y=y;if(x<0||y<0||x>this._width||y>this._height){this.removeObjs.push(this.enemyBodies[i])}}this.world.step(1/60);for(i=0;i<this.removeObjs.length;i++){this.world.removeBody(this.removeObjs[i]);if(this.removeObjs[i]._sound){this.sounds.play("boom"+Math.ceil(Math.random()*3))}var index=this.enemyBodies.indexOf(this.removeObjs[i]);if(index){this.enemyBodies.splice(index,1);this.stage.removeChild(this.enemyGraphics[index]);this.enemyGraphics.splice(index,1)}}this.removeObjs.length=0},resize:function(){var ratio=1080/1920;var docWidth=document.body.clientWidth;var docHeight=document.body.clientHeight;if(docHeight/docWidth<ratio){this.bgRenderer.view.style.height="100%";this.renderer.view.style.height="100%";this.bgRenderer.view.style.width="auto";this.renderer.view.style.width="auto"}else{this.bgRenderer.view.style.width="100%";this.renderer.view.style.width="100%";this.bgRenderer.view.style.height="auto";this.renderer.view.style.height="auto"}},tick:function(){this.updatePhysics();this.renderer.render(this.stage);requestAnimationFrame(this.tick.bind(this))}};var game=new Game;